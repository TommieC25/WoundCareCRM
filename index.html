<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
 <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
 <meta http-equiv="Pragma" content="no-cache">
 <meta http-equiv="Expires" content="0">
 <meta name="apple-mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
 <title>Territory CRM - Miami Wound Care</title>
 <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
 <style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f5f5f5;-webkit-font-smoothing:antialiased;overflow-x:hidden}.app{display:flex;height:100vh}.connection-status{position:fixed;top:0;left:0;right:0;padding:0.5rem;text-align:center;font-size:0.75rem;font-weight:600;z-index:200;transition:all 0.3s}.connection-status.connected{background:#10b981;color:white}.connection-status.disconnected{background:#ef4444;color:white}.connection-status.syncing{background:#f59e0b;color:white}.connection-status.hidden{transform:translateY(-100%)}.mobile-header{display:none;background:#0a4d3c;color:white;padding:1rem;align-items:center;gap:1rem;position:sticky;top:0;z-index:60;box-shadow:0 2px 4px rgba(0,0,0,0.1)}.mobile-header h1{flex:1;font-size:1.25rem;font-weight:600}.menu-btn,.add-header-btn{background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;padding:0.5rem;display:flex;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent}.sidebar{width:300px;background:#0a4d3c;color:white;display:flex;flex-direction:column;overflow-y:auto;transition:transform 0.3s}.sidebar-header{padding:1.5rem;border-bottom:1px solid rgba(255,255,255,0.1)}.sidebar-header h1{font-size:1.5rem;font-weight:700;margin-bottom:0.25rem}.sidebar-header .subtitle{font-size:0.75rem;opacity:0.7;text-transform:uppercase;letter-spacing:1px}.sidebar-header .count{font-size:0.85rem;margin-top:0.5rem;opacity:0.8}.search-box{padding:0.75rem 1rem;border-bottom:1px solid rgba(255,255,255,0.1)}.search-wrapper{position:relative;display:flex;align-items:center}.search-input{width:100%;padding:0.75rem;padding-right:2.5rem;border:none;border-radius:8px;background:rgba(255,255,255,0.1);color:white;font-size:0.9rem}.search-input::placeholder{color:rgba(255,255,255,0.5)}.search-input:focus{outline:none;background:rgba(255,255,255,0.15)}.search-clear{position:absolute;right:0.5rem;background:rgba(255,255,255,0.3);border:none;color:white;font-size:1.25rem;cursor:pointer;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;padding:0;line-height:1;-webkit-tap-highlight-color:transparent;touch-action:manipulation}.sort-controls{padding:0.5rem 1rem;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;gap:0.5rem;flex-wrap:wrap}.sort-btn{padding:0.4rem 0.75rem;background:rgba(255,255,255,0.1);border:none;border-radius:6px;color:white;font-size:0.75rem;cursor:pointer;transition:all 0.2s}.sort-btn:hover{background:rgba(255,255,255,0.2)}.sort-btn.active{background:#f97316}.physician-list{flex:1;padding:0.5rem;list-style:none;overflow-y:auto}.physician-item{padding:0.875rem;margin-bottom:0.5rem;background:rgba(255,255,255,0.1);border-radius:8px;cursor:pointer;transition:all 0.2s;border-left:3px solid transparent;-webkit-tap-highlight-color:transparent}.physician-item:active{transform:scale(0.98)}.physician-item.active{background:rgba(255,255,255,0.2);border-left-color:#f97316}.physician-item .name{font-weight:600;font-size:0.9rem;margin-bottom:0.25rem}.physician-item .practice{font-size:0.75rem;opacity:0.8}.physician-item .tier{font-size:0.65rem;margin-top:0.25rem;padding:0.125rem 0.5rem;background:rgba(249,115,22,0.3);border-radius:4px;display:inline-block}.physician-item .city-badge{font-size:0.65rem;margin-left:0.25rem;padding:0.125rem 0.5rem;background:rgba(255,255,255,0.2);border-radius:4px;display:inline-block}.add-physician-btn{margin:1rem;padding:1rem;background:#f97316;color:white;border:none;border-radius:8px;font-weight:600;font-size:1rem;cursor:pointer;-webkit-tap-highlight-color:transparent}.add-physician-btn:active{transform:scale(0.98)}.main-content{flex:1;overflow-y:auto;padding:1rem;-webkit-overflow-scrolling:touch}.empty-state{text-align:center;padding:4rem 2rem;color:#666}.empty-state h2{font-size:1.5rem;margin-bottom:1rem}.profile-header{background:white;padding:1.5rem;border-radius:12px;margin-bottom:1rem;box-shadow:0 1px 3px rgba(0,0,0,0.1)}.profile-name{font-size:1.75rem;font-weight:700;color:#0a4d3c;margin-bottom:0.5rem}.profile-practice{font-size:1rem;color:#666;margin-bottom:1rem}.profile-meta{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;padding-top:1rem;border-top:1px solid #e5e5e5}.meta-item{display:flex;flex-direction:column}.meta-label{font-size:0.7rem;text-transform:uppercase;color:#999;letter-spacing:0.5px;margin-bottom:0.25rem}.meta-value{font-weight:600;color:#0a4d3c;font-size:0.9rem}.section{background:white;padding:1.5rem;border-radius:12px;margin-bottom:1rem;box-shadow:0 1px 3px rgba(0,0,0,0.1)}.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:0.75rem;border-bottom:2px solid #f0f0f0}.section-header h3{font-size:1.25rem;color:#0a4d3c}.edit-btn{padding:0.5rem 1rem;background:#0a4d3c;color:white;border:none;border-radius:6px;font-weight:600;font-size:0.85rem;cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:manipulation}.edit-btn:active{transform:scale(0.95)}.delete-btn{padding:0.5rem 1rem;background:#dc2626;color:white;border:none;border-radius:6px;font-weight:600;font-size:0.85rem;cursor:pointer;margin-left:0.5rem}.contact-grid{display:grid;gap:0.75rem}.contact-item{display:flex;gap:0.75rem;padding:0.875rem;background:#f9f9f9;border-radius:8px}.contact-icon{width:40px;height:40px;background:#0a4d3c;color:white;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:1.25rem}.contact-item-content{flex:1}.contact-item-label{font-size:0.7rem;text-transform:uppercase;color:#999;letter-spacing:0.5px;margin-bottom:0.25rem}.contact-item-value{font-weight:500;color:#333;font-size:0.9rem}.contact-item-value a{color:#0a4d3c;text-decoration:none}.form-grid{display:grid;gap:1rem}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}@media (max-width:500px){.form-row{grid-template-columns:1fr}}label{display:block;font-size:0.75rem;font-weight:600;color:#666;margin-bottom:0.25rem;text-transform:uppercase;letter-spacing:0.5px}input,textarea,select{width:100%;padding:0.875rem;border:2px solid #e5e5e5;border-radius:8px;font-size:1rem;font-family:inherit;-webkit-appearance:none}input:focus,textarea:focus,select:focus{outline:none;border-color:#0a4d3c}textarea{resize:vertical;min-height:100px}.btn-primary{width:100%;padding:1rem;background:#0a4d3c;color:white;border:none;border-radius:8px;font-weight:600;font-size:1rem;cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:manipulation}.btn-primary:active{transform:scale(0.98)}.btn-primary:disabled{background:#ccc;cursor:not-allowed}.btn-primary.saving{background:#f59e0b;pointer-events:none}.btn-primary.saved{background:#10b981}.contact-entries{display:flex;flex-direction:column;gap:0.75rem}.contact-entry{padding:1rem;background:#f9f9f9;border-left:4px solid #0a4d3c;border-radius:8px}.contact-entry-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem}.contact-entry-date{font-size:0.75rem;color:#999;text-transform:uppercase;letter-spacing:0.5px}.contact-entry-location{display:block;font-size:0.8rem;color:#0a4d3c;margin-top:0.25rem}.contact-entry-timestamp{font-size:0.7rem;color:#bbb;margin-left:0.5rem;font-style:italic}.contact-entry-actions{display:flex;gap:0.5rem}.icon-btn{background:none;border:none;font-size:1rem;cursor:pointer;padding:0.25rem;opacity:0.6;transition:opacity 0.2s;touch-action:manipulation;-webkit-tap-highlight-color:transparent}.icon-btn:hover{opacity:1}.contact-entry-notes{font-size:0.9rem;line-height:1.5;color:#333;white-space:pre-wrap}.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:100;padding:1rem;overflow-y:auto;-webkit-overflow-scrolling:touch}.modal.active{display:flex;align-items:center;justify-content:center}.modal-content{background:white;border-radius:16px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;-webkit-overflow-scrolling:touch;box-shadow:0 20px 25px -5px rgba(0,0,0,0.2)}.modal-header{display:flex;justify-content:space-between;align-items:center;padding:1.5rem;border-bottom:1px solid #e5e5e5;position:sticky;top:0;background:white;border-radius:16px 16px 0 0}.modal-header h2{font-size:1.5rem;color:#0a4d3c}.close-btn{background:none;border:none;font-size:2rem;cursor:pointer;color:#999;padding:0;width:40px;height:40px;display:flex;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent}.modal-body{padding:1.5rem}.locations-grid{display:flex;flex-direction:column;gap:1rem}.location-card{background:#f9f9f9;border-radius:10px;padding:1rem;border-left:4px solid #0a4d3c}.location-card.primary{border-left-color:#f97316}.location-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem}.location-label{font-weight:600;color:#0a4d3c;font-size:0.95rem}.location-badge{font-size:0.65rem;padding:0.2rem 0.5rem;background:#f97316;color:white;border-radius:4px;text-transform:uppercase;font-weight:600}.practice-badge{font-size:0.65rem;padding:0.2rem 0.5rem;background:#0a4d3c;color:white;border-radius:4px;margin-left:0.25rem}.location-actions{display:flex;gap:0.25rem}.location-details{display:grid;gap:0.5rem}.location-detail{display:flex;align-items:flex-start;gap:0.5rem;font-size:0.85rem}.location-detail-icon{flex-shrink:0;width:20px;text-align:center}.location-detail-value{color:#333}.location-detail-value a{color:#0a4d3c;text-decoration:none}.add-location-btn{display:flex;align-items:center;justify-content:center;gap:0.5rem;padding:1rem;background:rgba(10,77,60,0.05);border:2px dashed #0a4d3c;border-radius:10px;color:#0a4d3c;font-weight:600;cursor:pointer;transition:all 0.2s}.add-location-btn:hover{background:rgba(10,77,60,0.1)}.selector-section{margin-bottom:1rem;padding:1rem;background:#f0f9ff;border-radius:8px;border:1px solid #bae6fd}.selector-section h4{color:#0369a1;margin-bottom:0.75rem;font-size:0.9rem}.selector-options{display:flex;flex-direction:column;gap:0.5rem;max-height:200px;overflow-y:auto}.selector-option{display:flex;align-items:center;gap:0.5rem;padding:0.5rem;background:white;border-radius:6px;cursor:pointer;transition:all 0.2s;touch-action:manipulation;-webkit-tap-highlight-color:transparent}.selector-option:hover{background:#e0f2fe}.selector-option.selected{background:#0ea5e9;color:white}.selector-option input[type="checkbox"],.selector-option input[type="radio"]{width:18px;height:18px;margin:0;accent-color:#0ea5e9;cursor:pointer}.selector-option input[type="checkbox"]:checked{background-color:#0ea5e9}.selector-option input[type="checkbox"]{-webkit-appearance:none;-moz-appearance:none;appearance:none;border:2px solid #0ea5e9;border-radius:3px;background:#e0f2fe;position:relative;flex-shrink:0;pointer-events:none}.selector-option input[type="checkbox"]:checked{background-color:#0ea5e9;border-color:#0ea5e9}.selector-option input[type="checkbox"]:checked::after{content:'‚úì';position:absolute;color:white;font-size:14px;font-weight:bold;top:50%;left:50%;transform:translate(-50%,-50%)}.selector-option-label{flex:1;font-size:0.85rem}.selector-option-sub{font-size:0.75rem;opacity:0.7}.btn-secondary{padding:0.5rem 1rem;background:#e5e5e5;color:#333;border:none;border-radius:6px;font-weight:600;font-size:0.85rem;cursor:pointer;margin-top:0.5rem;touch-action:manipulation;-webkit-tap-highlight-color:transparent}.btn-secondary:hover{background:#d5d5d5}@media (max-width:768px){.app{flex-direction:column}.mobile-header{display:flex}.sidebar{position:fixed;top:0;left:0;bottom:0;z-index:50;transform:translateX(-100%);box-shadow:2px 0 8px rgba(0,0,0,0.1)}.sidebar.open{transform:translateX(0)}.main-content{padding:0.5rem}.profile-name{font-size:1.5rem}.section{padding:1rem}}.loading{text-align:center;padding:3rem;color:#666}.empty-notice{text-align:center;padding:2rem;color:#999;font-style:italic}.sync-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-left:0.5rem;animation:pulse 1.5s infinite}.sync-indicator.synced{background:#10b981}.sync-indicator.syncing{background:#f59e0b;animation:pulse 0.5s infinite}.sync-indicator.error{background:#ef4444}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}.toast-container{position:fixed;bottom:1rem;right:1rem;z-index:300;display:flex;flex-direction:column;gap:0.5rem}.toast{padding:1rem 1.5rem;border-radius:8px;color:white;font-weight:500;box-shadow:0 4px 12px rgba(0,0,0,0.15);animation:slideIn 0.3s ease}.toast.success{background:#10b981}.toast.error{background:#ef4444}.toast.info{background:#3b82f6}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}.view-tabs{display:flex;gap:0.5rem;padding:0.5rem 1rem;border-bottom:1px solid rgba(255,255,255,0.1)}.view-tab{padding:0.5rem 1rem;background:rgba(255,255,255,0.1);border:none;border-radius:6px;color:white;font-size:0.8rem;cursor:pointer;transition:all 0.2s}.view-tab:hover{background:rgba(255,255,255,0.2)}.view-tab.active{background:#f97316}.admin-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;padding:0.4rem 0.75rem;border-radius:6px;font-size:0.75rem;cursor:pointer;margin-top:0.5rem;transition:all 0.2s}.admin-btn:hover{background:rgba(255,255,255,0.2)}.admin-panel{background:#1a1a2e;border:1px solid #333;border-radius:8px;padding:1rem;margin-top:1rem;display:none}.admin-panel.show{display:block}.admin-panel h4{color:#f97316;margin-bottom:0.75rem;font-size:0.9rem}.admin-panel p{color:#aaa;font-size:0.8rem;margin-bottom:0.75rem}.btn-danger{background:#dc2626;color:white;border:none;padding:0.6rem 1rem;border-radius:6px;font-size:0.85rem;cursor:pointer;width:100%;margin-bottom:0.5rem;transition:all 0.2s}.btn-danger:hover{background:#b91c1c}.btn-warning{background:#f59e0b;color:white;border:none;padding:0.6rem 1rem;border-radius:6px;font-size:0.85rem;cursor:pointer;width:100%;transition:all 0.2s}.btn-warning:hover{background:#d97706}
</style>
</head>
<body>
<div id="connectionStatus" class="connection-status hidden">Connecting...</div>
<div id="toastContainer" class="toast-container"></div>
<div class="app">
<div class="mobile-header">
<button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
<h1>Territory CRM <span id="mobileSyncIndicator" class="sync-indicator synced"></span></h1>
<button class="add-header-btn" onclick="openPhysicianModal()">+</button>
</div>
<aside class="sidebar" id="sidebar">
<div class="sidebar-header">
<h1>Territory CRM <span id="desktopSyncIndicator" class="sync-indicator synced"></span></h1>
<div class="subtitle">Miami Wound Care</div>
<div class="count" id="physicianCount">Loading...</div>
<button class="admin-btn" onclick="toggleAdminPanel()">Admin Settings</button>
<div class="admin-panel" id="adminPanel">
<h4>Database Management</h4>
<p style="color:#aaa;font-size:0.8rem;margin-bottom:0.75rem;">Add new records to the existing database, or manage all data.</p>
<label style="display:block;margin-bottom:0.5rem;padding:0.75rem;background:#10b981;color:white;border-radius:8px;font-weight:600;text-align:center;cursor:pointer;font-size:0.95rem;">
Append New Records from CSV <input type="file" accept=".csv" onchange="importCSV(this.files[0])" style="display:none">
</label>
<div style="font-size:0.7rem;color:#888;margin-bottom:0.75rem;text-align:center;">Adds new physicians without affecting existing data</div>
<div id="importStatus" style="font-size:0.8rem;margin-bottom:0.5rem;color:#ccc;"></div>
<button class="btn-danger" onclick="clearDatabase()" style="margin-top:0.5rem;">Clear All Data</button>
</div>
</div>
<div class="view-tabs">
<button class="view-tab active" onclick="setView('physicians')" id="tabPhysicians">Physicians</button>
<button class="view-tab" onclick="setView('practices')" id="tabPractices">Practices</button>
</div>
<div class="search-box">
<div class="search-wrapper">
<input type="text" class="search-input" id="searchInput" placeholder="Search physicians..." oninput="filterList()">
<button class="search-clear" id="searchClear" onclick="clearSearch()" style="display:none">&times;</button>
</div>
</div>
<div class="sort-controls" id="sortControls">
<button class="sort-btn active" onclick="setSortBy('name')" id="sortName">Name</button>
<button class="sort-btn" onclick="setSortBy('city')" id="sortCity">City</button>
<button class="sort-btn" onclick="setSortBy('zip')" id="sortZip">ZIP</button>
<button class="sort-btn" onclick="setSortBy('tier')" id="sortTier">Tier</button>
</div>
<ul class="physician-list" id="physicianList">
<li class="loading">Loading physicians...</li>
</ul>
<button class="add-physician-btn" id="addBtn" onclick="openPhysicianModal()">+ New Physician</button>
</aside>
<main class="main-content" id="mainContent">
<div class="empty-state">
<h2>Welcome to Territory CRM</h2>
<p>Select a physician from the list to view their profile</p>
<div id="importStatusMain" style="font-size:0.85rem;margin-top:0.5rem;color:#666;"></div>
</div>
</main>
</div>
<div class="modal" id="physicianModal">
<div class="modal-content">
<div class="modal-header">
<h2 id="modalTitle">Add Physician</h2>
<button class="close-btn" onclick="closePhysicianModal()">&times;</button>
</div>
<div class="modal-body">
<form id="physicianForm" onsubmit="savePhysician(event)">
<div class="form-grid">
<div class="selector-section" id="practiceSelector">
<h4>Select or Create Practice</h4>
<input type="text" id="practiceSearchInput" placeholder="Search practices..." oninput="filterPracticeOptions()" style="width:100%;padding:0.5rem;border:1px solid #bae6fd;border-radius:6px;margin-bottom:0.5rem;font-size:0.85rem;">
<div class="selector-options" id="practiceOptions">
</div>
<button type="button" class="btn-secondary" onclick="toggleNewPractice()">+ New Practice</button>
<div id="newPracticeFields" style="display: none; margin-top: 1rem;">
<label>New Practice Name</label>
<input type="text" id="newPracticeName" placeholder="e.g., Miami Dermatology Associates">
</div>
</div>
<div class="selector-section" id="locationSelector" style="display: none;">
<h4>Assign to Locations</h4>
<div class="selector-options" id="locationOptions">
</div>
<button type="button" class="btn-secondary" onclick="toggleNewLocation()">+ New Location</button>
</div>
<div class="form-row">
<div>
<label>First Name *</label>
<input type="text" id="firstName" required>
</div>
<div>
<label>Last Name *</label>
<input type="text" id="lastName" required>
</div>
</div>
<div class="form-row">
<div>
<label>Degree</label>
<select id="degree">
<option value="">-- Select --</option>
<option value="MD">MD</option>
<option value="DO">DO</option>
<option value="DPM">DPM</option>
<option value="PA-C">PA-C</option>
<option value="NP">NP</option>
<option value="RN">RN</option>
<option value="PhD">PhD</option>
<option value="Other">Other</option>
</select>
</div>
<div>
<label>Title (non-physician staff)</label>
<input type="text" id="staffTitle" placeholder="e.g. Office Manager">
</div>
</div>
<div>
<label>Email</label>
<input type="email" id="physicianEmail">
</div>
<div class="form-row">
<div>
<label>Priority Tier (Quintile)</label>
<select id="priority">
<option value="">-- Select Tier --</option>
<option value="1">1 - Highest Priority</option>
<option value="2">2 - High Priority</option>
<option value="3">3 - Medium Priority</option>
<option value="4">4 - Lower Priority</option>
<option value="5">5 - Lowest Priority</option>
</select>
</div>
<div>
<label>Specialty</label>
<select id="specialty">
<option value="">-- Select Specialty --</option>
<option value="Dermatology">Dermatology</option>
<option value="Podiatry">Podiatry</option>
<option value="Wound Healing">Wound Healing</option>
<option value="Plastic & Reconstructive Surgery">Plastic & Reconstructive Surgery</option>
<option value="General Surgery">General Surgery</option>
<option value="Other">Other</option>
</select>
</div>
</div>
<div>
<label>UM Connection</label>
<input type="text" id="umConnection">
</div>
<div>
<label>Candidate Patient Volume</label>
<input type="text" id="patientVolume">
</div>
<div>
<label>General Notes</label>
<textarea id="physicianGeneralNotes" rows="3"></textarea>
</div>
</div>
<button type="submit" class="btn-primary" id="physicianSaveBtn" style="margin-top: 1.5rem;">Save Physician</button>
</form>
</div>
</div>
</div>
<div class="modal" id="locationModal">
<div class="modal-content">
<div class="modal-header">
<h2 id="locationModalTitle">Add Location</h2>
<button class="close-btn" onclick="closeLocationModal()">&times;</button>
</div>
<div class="modal-body">
<form id="locationForm" onsubmit="saveLocation(event)">
<div class="form-grid">
<div class="selector-section" id="locationPracticeSelector">
<h4>Select Practice for this Location</h4>
<select id="locationPracticeId" required style="width: 100%;">
<option value="">-- Select Practice --</option>
</select>
</div>
<div class="form-row">
<div>
<label>Location Label</label>
<input type="text" id="locationLabel" placeholder="e.g., Main Office, Key Biscayne">
</div>
<div>
<label>Primary Location?</label>
<select id="locationIsPrimary">
<option value="false">No</option>
<option value="true">Yes - Main Office</option>
</select>
</div>
</div>
<div>
<label>Street Address</label>
<input type="text" id="locationAddress">
</div>
<div class="form-row">
<div>
<label>City</label>
<input type="text" id="locationCity">
</div>
<div>
<label>ZIP</label>
<input type="text" id="locationZip">
</div>
</div>
<div class="form-row">
<div>
<label>Phone</label>
<input type="tel" id="locationPhone">
</div>
<div>
<label>Fax</label>
<input type="tel" id="locationFax">
</div>
</div>
<div>
<label>Office Email</label>
<input type="email" id="locationEmail">
</div>
<div>
<label>Office Hours</label>
<input type="text" id="locationHours" placeholder="e.g., Mon-Fri 9AM-5PM">
</div>
<div>
<label>Office Staff Names</label>
<input type="text" id="locationStaff">
</div>
<div class="form-row">
<div>
<label>Main Receptionist</label>
<input type="text" id="locationReceptionist">
</div>
<div>
<label>Best Days to Visit</label>
<input type="text" id="locationBestDays">
</div>
</div>
</div>
<button type="submit" class="btn-primary" id="locationSaveBtn" style="margin-top: 1.5rem;">Save Location</button>
</form>
</div>
</div>
</div>
<div class="modal" id="practiceModal">
<div class="modal-content">
<div class="modal-header">
<h2 id="practiceModalTitle">Add Practice</h2>
<button class="close-btn" onclick="closePracticeModal()">&times;</button>
</div>
<div class="modal-body">
<form id="practiceForm" onsubmit="savePractice(event)">
<div class="form-grid">
<div>
<label>Practice Name *</label>
<input type="text" id="practiceName" required>
</div>
<div>
<label>Website</label>
<input type="url" id="practiceWebsite" placeholder="https://...">
</div>
<div>
<label>General Notes</label>
<textarea id="practiceNotes" rows="3"></textarea>
</div>
<div id="practiceAddressSection">
<div style="border-top:1px solid #e5e5e5;margin-top:0.5rem;padding-top:0.75rem;">
<label style="color:#0a4d3c;font-size:0.85rem;margin-bottom:0.5rem;">Primary Location (optional)</label>
</div>
<div>
<label>Address</label>
<input type="text" id="practiceAddress" placeholder="123 Main St">
</div>
<div class="form-row">
<div><label>City</label><input type="text" id="practiceCity"></div>
<div><label>ZIP</label><input type="text" id="practiceZip"></div>
</div>
<div class="form-row">
<div><label>Phone</label><input type="tel" id="practicePhone"></div>
<div><label>Fax</label><input type="tel" id="practiceFax"></div>
</div>
</div>
</div>
<button type="submit" class="btn-primary" id="practiceSaveBtn" style="margin-top: 1.5rem;">Save Practice</button>
</form>
</div>
</div>
</div>
<div class="modal" id="contactModal">
<div class="modal-content">
<div class="modal-header">
<h2 id="contactModalTitle">Add Contact Note</h2>
<button class="close-btn" onclick="closeContactModal()">&times;</button>
</div>
<div class="modal-body">
<form id="contactForm" onsubmit="saveContact(event)">
<div class="form-grid">
<div class="form-row">
<div>
<label>Your Name *</label>
<input type="text" id="authorName" value="Tom" required>
</div>
<div>
<label>Date *</label>
<input type="date" id="contactDate" required>
</div>
<div>
<label>Time</label>
<input type="time" id="contactTime">
</div>
</div>
<div id="locationSelectRow">
<label>Location</label>
<select id="contactLocation">
<option value="">Select location...</option>
</select>
</div>
<div>
<label>Notes *</label>
<textarea id="contactNotes" placeholder="What happened during this call/visit?" required rows="6"></textarea>
</div>
</div>
<button type="submit" class="btn-primary" id="contactSaveBtn" style="margin-top: 1rem;">Save Note</button>
</form>
</div>
</div>
</div>
<div class="modal" id="assignLocationModal">
<div class="modal-content">
<div class="modal-header">
<h2>Assign to Location</h2>
<button class="close-btn" onclick="closeAssignLocationModal()">&times;</button>
</div>
<div class="modal-body">
<div id="quickAddPracticeSection" style="margin-bottom:1rem;padding:1rem;background:#f0fdf4;border:1px solid #86efac;border-radius:8px;">
<h4 style="color:#0a4d3c;margin-bottom:0.75rem;font-size:0.9rem;">Quick Add New Practice + Location</h4>
<div style="margin-bottom:0.5rem;"><input type="text" id="quickPracticeName" placeholder="Practice Name" style="padding:0.5rem;font-size:0.85rem;"></div>
<div class="form-row" style="margin-bottom:0.5rem;">
<div><input type="text" id="quickPracticeAddr" placeholder="Address" style="padding:0.5rem;font-size:0.85rem;"></div>
<div><input type="text" id="quickPracticeCity" placeholder="City" style="padding:0.5rem;font-size:0.85rem;"></div>
</div>
<div class="form-row" style="margin-bottom:0.5rem;">
<div><input type="text" id="quickPracticeZip" placeholder="ZIP" style="padding:0.5rem;font-size:0.85rem;"></div>
<div><input type="tel" id="quickPracticePhone" placeholder="Phone" style="padding:0.5rem;font-size:0.85rem;"></div>
</div>
<button type="button" class="btn-secondary" style="background:#0a4d3c;color:white;width:100%;" onclick="quickAddPracticeAndAssign()">Create & Assign</button>
</div>
<p style="margin-bottom: 0.5rem; color: #666;">Or select existing locations:</p>
<input type="text" id="assignLocationSearch" placeholder="Search practices or locations..." oninput="filterAssignLocationOptions()" style="width:100%;padding:0.5rem;border:1px solid #e5e5e5;border-radius:6px;margin-bottom:0.5rem;font-size:0.85rem;">
<div class="selector-options" id="assignLocationOptions" style="max-height: 300px;">
</div>
<button type="button" class="btn-primary" style="margin-top: 1rem;" onclick="saveLocationAssignments()">Save Assignments</button>
</div>
</div>
</div>
<div class="modal" id="assignPhysicianModal">
<div class="modal-content">
<div class="modal-header">
<h2>Assign Physician to Location</h2>
<button class="close-btn" onclick="closeAssignPhysicianModal()">&times;</button>
</div>
<div class="modal-body">
<p style="margin-bottom: 0.5rem; color: #666;">Select a location at this practice:</p>
<select id="assignPhysLocationSelect" style="width:100%;margin-bottom:1rem;padding:0.5rem;border:1px solid #e5e5e5;border-radius:6px;font-size:0.9rem;"></select>
<div id="quickAddPhysSection" style="margin-bottom:1rem;padding:1rem;background:#f0fdf4;border:1px solid #86efac;border-radius:8px;">
<h4 style="color:#0a4d3c;margin-bottom:0.75rem;font-size:0.9rem;">Quick Add New Physician</h4>
<div class="form-row" style="margin-bottom:0.5rem;">
<div><input type="text" id="quickPhysFirst" placeholder="First Name" style="padding:0.5rem;font-size:0.85rem;"></div>
<div><input type="text" id="quickPhysLast" placeholder="Last Name" style="padding:0.5rem;font-size:0.85rem;"></div>
</div>
<div class="form-row" style="margin-bottom:0.5rem;">
<div>
<select id="quickPhysSpecialty" style="padding:0.5rem;font-size:0.85rem;">
<option value="">Specialty</option>
<option value="Dermatology">Dermatology</option>
<option value="Podiatry">Podiatry</option>
<option value="Wound Healing">Wound Healing</option>
<option value="Plastic & Reconstructive Surgery">Plastic & Reconstructive Surgery</option>
<option value="General Surgery">General Surgery</option>
<option value="Other">Other</option>
</select>
</div>
<div>
<select id="quickPhysPriority" style="padding:0.5rem;font-size:0.85rem;">
<option value="">Priority</option>
<option value="1">Tier 1</option>
<option value="2">Tier 2</option>
<option value="3">Tier 3</option>
<option value="4">Tier 4</option>
<option value="5">Tier 5</option>
</select>
</div>
</div>
<button type="button" class="btn-secondary" style="background:#0a4d3c;color:white;width:100%;" onclick="quickAddPhysician()">Add & Assign Physician</button>
</div>
<p style="margin-bottom: 0.5rem; color: #666;">Or select existing physicians:</p>
<input type="text" id="assignPhysSearch" placeholder="Search physicians..." oninput="filterAssignPhysicianOptions()" style="width:100%;padding:0.5rem;border:1px solid #e5e5e5;border-radius:6px;margin-bottom:0.5rem;font-size:0.85rem;">
<div class="selector-options" id="assignPhysicianOptions" style="max-height: 300px;">
</div>
<button type="button" class="btn-primary" style="margin-top: 1rem;" onclick="savePhysicianToLocation()">Save Assignments</button>
</div>
</div>
</div>
<script>
const SUPABASE_URL = 'https://xhdjywibdjzbczfjmctp.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhoZGp5d2liZGp6YmN6ZmptY3RwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NzE4MTYsImV4cCI6MjA4NTM0NzgxNn0.vHAfeYTVbu2Isu5AoFONvzrtJ2sS3YwF00QRe3LNrbU';
const { createClient } = window.supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const $=id=>document.getElementById(id);
async function withSave(btnId,label,fn){const btn=$(btnId);if(btn.classList.contains('saving'))return;btn.textContent='Saving...';btn.classList.add('saving');try{updateSyncIndicators('syncing');await fn();btn.textContent='Saved!';btn.classList.remove('saving');btn.classList.add('saved');updateSyncIndicators('synced');}catch(e){console.error('Save error:',e);showToast('Error: '+e.message,'error');btn.textContent=label;btn.classList.remove('saving');updateSyncIndicators('error');throw e;}}
async function dbDel(table,id,msg,after){if(!confirm(msg))return;try{updateSyncIndicators('syncing');const{error}=await db.from(table).delete().eq('id',id);if(error)throw error;await after();showToast('Deleted','success');updateSyncIndicators('synced');}catch(e){console.error('Delete error:',e);showToast('Error: '+e.message,'error');updateSyncIndicators('error');}}
function setFields(map){for(const[id,val]of Object.entries(map))$(id).value=val;}
let physicians = [];
let practices = [];
let practiceLocations = [];
let physicianAssignments = {};
let contactLogs = {};
let currentPhysician = null;
let currentPractice = null;
let currentView = 'physicians';  // 'physicians' or 'practices'
let sortBy = 'name';  // 'name', 'city', 'zip', 'tier'
let editMode = false;
let editingContactId = null;
let editingLocationId = null;
let editingPracticeId = null;
let selectedPracticeId = null;
let selectedLocationIds = [];
document.addEventListener('DOMContentLoaded', async () => {
setToday();
await loadAllData();
setupRealtimeSubscription();
// Prevent background scroll when modals are open (iPad fix)
document.querySelectorAll('.modal').forEach(modal => {
modal.addEventListener('touchmove', function(e) {
const content = modal.querySelector('.modal-content');
if (content && content.contains(e.target)) return; // allow scroll inside modal content
e.preventDefault();
}, { passive: false });
});
});
function setToday() {
const today = new Date();
const yyyy = today.getFullYear();
const mm = String(today.getMonth() + 1).padStart(2, '0');
const dd = String(today.getDate()).padStart(2, '0');
const hh = String(today.getHours()).padStart(2, '0');
const min = String(today.getMinutes()).padStart(2, '0');
$('contactDate').value = `${yyyy}-${mm}-${dd}`;
$('contactTime').value = `${hh}:${min}`;
}
function showToast(message, type = 'info') {
const container = $('toastContainer');
const toast = document.createElement('div');
toast.className = `toast ${type}`;
toast.textContent = message;
container.appendChild(toast);
setTimeout(() => toast.remove(), 3000);
}
function updateConnectionStatus(status) {
const el = $('connectionStatus');
el.className = `connection-status ${status}`;
el.textContent = status === 'connected' ? 'Connected - Real-time sync active' :
status === 'syncing' ? 'Syncing...' : 'Disconnected - Working offline';
el.classList.remove('hidden');
if (status === 'connected') {
setTimeout(() => el.classList.add('hidden'), 2000);
}
}
function updateSyncIndicators(status) {
const classes = { synced: 'synced', syncing: 'syncing', error: 'error' };
$('mobileSyncIndicator').className = `sync-indicator ${classes[status] || 'synced'}`;
$('desktopSyncIndicator').className = `sync-indicator ${classes[status] || 'synced'}`;
}
async function loadAllData() {
try {
updateSyncIndicators('syncing');
const { data: physData, error: physError } = await db
.from('physicians')
.select('*')
.order('last_name', { ascending: true });
if (physError) throw physError;
physicians = physData || [];
const { data: practData, error: practError } = await db
.from('practices')
.select('*')
.order('name', { ascending: true });
if (!practError) {
practices = practData || [];
}
const { data: locData, error: locError } = await db
.from('practice_locations')
.select('*, practices(name)')
.order('city', { ascending: true });
if (!locError) {
practiceLocations = locData || [];
}
const { data: assignData, error: assignError } = await db
.from('physician_location_assignments')
.select('*, practice_locations(*, practices(name))');
if (!assignError) {
physicianAssignments = {};
(assignData || []).forEach(a => {
if (!physicianAssignments[a.physician_id]) {
physicianAssignments[a.physician_id] = [];
}
physicianAssignments[a.physician_id].push(a);
});
}
renderList();
updateSyncIndicators('synced');
updateConnectionStatus('connected');
} catch (error) {
console.error('Error loading data:', error);
updateSyncIndicators('error');
showToast('Error loading data: ' + error.message, 'error');
}
}
async function loadContactLogs(physicianId) {
try {
const { data, error } = await db
.from('contact_logs')
.select('*')
.eq('physician_id', physicianId)
.order('contact_date', { ascending: false });
if (error) throw error;
contactLogs[physicianId] = data || [];
} catch (error) {
console.error('Error loading contact logs:', error);
}
}
function setupRealtimeSubscription() {
['physicians','practices','practice_locations','physician_location_assignments'].forEach(t =>
db.channel(t+'-ch').on('postgres_changes',{event:'*',schema:'public',table:t},()=>loadAllData()).subscribe());
db.channel('contact-logs-ch')
.on('postgres_changes',{event:'*',schema:'public',table:'contact_logs'},(payload)=>{
const pid=payload.new?.physician_id||payload.old?.physician_id;
if(currentPhysician&&pid===currentPhysician.id) loadContactLogs(currentPhysician.id).then(()=>renderProfile());
}).subscribe();
}
function setView(view) {
currentView = view;
$('tabPhysicians').classList.toggle('active', view === 'physicians');
$('tabPractices').classList.toggle('active', view === 'practices');
$('searchInput').placeholder = view === 'physicians' ? 'Search physicians...' : 'Search practices...';
$('addBtn').textContent = view === 'physicians' ? '+ New Physician' : '+ New Practice';
$('addBtn').onclick = view === 'physicians' ? openPhysicianModal : openPracticeModal;
$('sortControls').style.display = view === 'physicians' ? 'flex' : 'none';
currentPhysician = null;
currentPractice = null;
renderList();
renderEmptyState();
}
function setSortBy(sort) {
sortBy = sort;
document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
$('sort' + sort.charAt(0).toUpperCase() + sort.slice(1)).classList.add('active');
renderList();
}
function fmtName(p) {
const deg = p.degree || '';
const tl = p.title || '';
if (deg) return `${p.first_name} ${p.last_name}, ${deg}`;
if (tl) return `${p.first_name} ${p.last_name} (${tl})`;
return `Dr. ${p.first_name} ${p.last_name}`;
}
function getSortedPhysicians(filtered) {
return [...filtered].sort((a, b) => {
if (sortBy === 'name') {
return a.last_name.localeCompare(b.last_name);
} else if (sortBy === 'city') {
const cityA = getPrimaryLoc(a.id).city || 'zzz';
const cityB = getPrimaryLoc(b.id).city || 'zzz';
return cityA.localeCompare(cityB);
} else if (sortBy === 'zip') {
const zipA = getPrimaryLoc(a.id).zip || 'zzz';
const zipB = getPrimaryLoc(b.id).zip || 'zzz';
return zipA.localeCompare(zipB);
} else if (sortBy === 'tier') {
const tierA = a.priority || 'zzz';
const tierB = b.priority || 'zzz';
return tierA.localeCompare(tierB);
}
return 0;
});
}
function ld(val,icon,content){return val?`<div class="location-detail"><span class="location-detail-icon">${icon}</span><span class="location-detail-value">${content||val}</span></div>`:''}
function mi(label,val){return `<div class="meta-item"><div class="meta-label">${label}</div><div class="meta-value">${val}</div></div>`}
function ci(icon,label,val){return val?`<div class="contact-item"><div class="contact-icon">${icon}</div><div class="contact-item-content"><div class="contact-item-label">${label}</div><div class="contact-item-value">${val}</div></div></div>`:''}
function getPrimaryLoc(physicianId) {
const a = physicianAssignments[physicianId] || [];
const assign = a.find(x => x.is_primary) || a[0];
if (!assign) return {};
return assign.practice_locations || practiceLocations.find(l => l.id === assign.practice_location_id) || {};
}
function toggleSidebar() {
$('sidebar').classList.toggle('open');
}
function updateCount() {
const search = $('searchInput').value.toLowerCase();
if (currentView === 'physicians') {
const filtered = getFilteredPhysicians(search);
$('physicianCount').textContent =
`${filtered.length} of ${physicians.length} physician${physicians.length !== 1 ? 's' : ''}`;
} else {
const filtered = getFilteredPractices(search);
$('physicianCount').textContent =
`${filtered.length} of ${practices.length} practice${practices.length !== 1 ? 's' : ''}`;
}
}
function getFilteredPhysicians(search) {
if (!search) return physicians;
return physicians.filter(p => {
if (p.first_name.toLowerCase().includes(search) || p.last_name.toLowerCase().includes(search)) return true;
if ((p.specialty||'').toLowerCase().includes(search)) return true;
if ((p.email||'').toLowerCase().includes(search)) return true;
if ((p.general_notes||'').toLowerCase().includes(search)) return true;
const assigns = physicianAssignments[p.id] || [];
return assigns.some(a => {
const loc = a.practice_locations || practiceLocations.find(l => l.id === a.practice_location_id) || {};
const pName = loc.practices?.name || practices.find(pr => pr.id === loc.practice_id)?.name || '';
return pName.toLowerCase().includes(search) || (loc.city||'').toLowerCase().includes(search) || (loc.zip||'').toLowerCase().includes(search) || (loc.address||'').toLowerCase().includes(search) || (loc.phone||'').toLowerCase().includes(search);
});
});
}
function getFilteredPractices(search) {
if (!search) return practices;
return practices.filter(p => {
if (p.name.toLowerCase().includes(search)) return true;
if ((p.website||'').toLowerCase().includes(search)) return true;
if ((p.general_notes||'').toLowerCase().includes(search)) return true;
const locs = practiceLocations.filter(l => l.practice_id === p.id);
return locs.some(l => (l.address||'').toLowerCase().includes(search) || (l.city||'').toLowerCase().includes(search) || (l.zip||'').toLowerCase().includes(search) || (l.phone||'').toLowerCase().includes(search));
});
}
function filterList() {
const val = $('searchInput').value;
$('searchClear').style.display = val ? 'flex' : 'none';
renderList();
}
function clearSearch() {
$('searchInput').value = '';
$('searchClear').style.display = 'none';
renderList();
$('searchInput').focus();
}
function renderList() {
const list = $('physicianList');
const search = $('searchInput').value.toLowerCase();
if (currentView === 'physicians') {
renderPhysicianList(list, search);
} else {
renderPracticeList(list, search);
}
updateCount();
}
function renderPhysicianList(list, search) {
const filtered = getFilteredPhysicians(search);
const sorted = getSortedPhysicians(filtered);
if (sorted.length === 0) {
list.innerHTML = '<li class="loading">No physicians found</li>';
return;
}
list.innerHTML = sorted.map(p => {
const assignments = physicianAssignments[p.id] || [];
const primaryAssign = assignments.find(a => a.is_primary) || assignments[0];
const pLoc = primaryAssign?.practice_locations || (primaryAssign ? practiceLocations.find(l => l.id === primaryAssign.practice_location_id) : null) || {};
const cityDisplay = pLoc.city || '';
const practiceName = pLoc.practices?.name || (pLoc.practice_id ? practices.find(pr => pr.id === pLoc.practice_id)?.name : '') || p.practice_name || '';
const locationCount = assignments.length;
return `
<li class="physician-item ${currentPhysician?.id === p.id ? 'active' : ''}"
onclick="viewPhysician('${p.id}')">
<div class="name">${fmtName(p)}</div>
<div class="practice">${practiceName}</div>
<div class="tier">${p.priority || 'No tier'}</div>
${cityDisplay ? `<span class="city-badge">${cityDisplay}</span>` : ''}
${locationCount > 1 ? `<span class="city-badge">+${locationCount - 1} more</span>` : ''}
</li>
`}).join('');
}
function renderPracticeList(list, search) {
const filtered = getFilteredPractices(search);
if (filtered.length === 0) {
list.innerHTML = '<li class="loading">No practices found</li>';
return;
}
list.innerHTML = filtered.map(p => {
const locations = practiceLocations.filter(l => l.practice_id === p.id);
const cities = [...new Set(locations.map(l => l.city).filter(Boolean))];
return `
<li class="physician-item ${currentPractice?.id === p.id ? 'active' : ''}"
onclick="viewPractice('${p.id}')">
<div class="name">${p.name}</div>
<div class="practice">${locations.length} location${locations.length !== 1 ? 's' : ''}</div>
${cities.slice(0, 2).map(c => `<span class="city-badge">${c}</span>`).join('')}
${cities.length > 2 ? `<span class="city-badge">+${cities.length - 2} more</span>` : ''}
</li>
`}).join('');
}
async function renderEmptyState() {
$('mainContent').innerHTML = `
<div class="empty-state">
<h2>Welcome to Territory CRM</h2>
<p>Select a ${currentView === 'physicians' ? 'physician' : 'practice'} from the list to view details</p>
</div>
<div class="section" style="margin-top:1rem;">
<div class="section-header"><h3>Recent Activity</h3></div>
<div id="recentActivityContent"><div class="loading">Loading recent activity...</div></div>
</div>
<div class="section">
<div class="section-header"><h3>Quick Stats</h3></div>
<div class="profile-meta">
${mi('Physicians',physicians.length)}${mi('Practices',practices.length)}${mi('Locations',practiceLocations.length)}${mi('Cities',[...new Set(practiceLocations.map(l=>l.city).filter(Boolean))].length)}
</div>
</div>
`;
try {
const {data:recentLogs,error} = await db.from('contact_logs').select('*').order('created_at',{ascending:false}).limit(15);
if (error) throw error;
const container = $('recentActivityContent');
if (!recentLogs || recentLogs.length === 0) {
container.innerHTML = '<div class="empty-notice">No contact notes yet. Start logging your visits and calls!</div>';
return;
}
container.innerHTML = '<div class="contact-entries">' + recentLogs.map(e => {
const phys = physicians.find(p => p.id === e.physician_id);
const physName = phys ? fmtName(phys) : 'Unknown';
const tm = (e.notes||'').match(/^\[(\d{1,2}:\d{2}(?:\s*[APap][Mm])?)\]\s*/);
const displayTime = tm ? ' ' + tm[1] : '';
const displayNotes = tm ? e.notes.replace(tm[0], '') : (e.notes||'');
const preview = displayNotes.length > 120 ? displayNotes.substring(0,120) + '...' : displayNotes;
return `
<div class="contact-entry" style="cursor:pointer" onclick="viewPhysician('${e.physician_id}')">
<div class="contact-entry-header">
<div>
<span class="contact-entry-date">${e.contact_date}${displayTime}${e.author ? ' - ' + e.author : ''}</span>
<span style="font-weight:600;color:#0a4d3c;display:block;margin-top:0.25rem;">${physName}</span>
${e.practice_location_id ? '<span class="contact-entry-location">' + getLocationLabel(e.practice_location_id) + '</span>' : ''}
</div>
</div>
<div class="contact-entry-notes">${preview}</div>
</div>
`;
}).join('') + '</div>';
} catch(e) {
const container = $('recentActivityContent');
if (container) container.innerHTML = '<div class="empty-notice">Could not load recent activity</div>';
}
}
async function viewPhysician(id) {
currentPhysician = physicians.find(p => p.id === id);
currentPractice = null;
if (!currentPhysician) return;
await loadContactLogs(id);
renderList();
renderProfile();
if (window.innerWidth <= 768) {
$('sidebar').classList.remove('open');
}
}
async function viewPractice(id) {
currentPractice = practices.find(p => p.id === id);
currentPhysician = null;
if (!currentPractice) return;
renderList();
renderPracticeProfile();
if (window.innerWidth <= 768) {
$('sidebar').classList.remove('open');
}
}
function formatTimestamp(isoString) {
if (!isoString) return '';
const date = new Date(isoString);
const options = { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' };
return date.toLocaleDateString('en-US', options);
}
function getLocationLabel(locationId) {
const loc = practiceLocations.find(l => l.id === locationId);
if (!loc) return '';
return `${loc.address}, ${loc.city}`;
}
function renderProfile() {
const p = currentPhysician;
const logs = contactLogs[p.id] || [];
const assignments = physicianAssignments[p.id] || [];
const practiceIds = [...new Set(assignments.map(a => {
const loc = a.practice_locations || practiceLocations.find(l => l.id === a.practice_location_id);
return loc?.practice_id;
}).filter(Boolean))];
const associatedPractices = practices.filter(pr => practiceIds.includes(pr.id));
$('mainContent').innerHTML = `
<div class="profile-header">
<div class="profile-name">${fmtName(p)}</div>
<div class="profile-practice">
${associatedPractices.map(pr => pr.name).join(' | ') || 'No practice assigned'}
</div>
<div class="profile-meta">
${mi('Priority',p.priority||'Not set')}${mi('Specialty',p.specialty||'Not set')}${mi('Degree',p.degree||'Not set')}${p.title?mi('Title',p.title):''}
${mi('UM Connection',p.um_connection||'None')}${mi('Candidate Patient Volume',p.patient_volume||p.mohs_volume||'Unknown')}${mi('Last Contact',p.last_contact||'Never')}${mi('Locations',assignments.length+' location'+(assignments.length!==1?'s':''))}
</div>
</div>
<div class="section">
<div class="section-header">
<h3>Physician Profile</h3>
<div>
<button class="edit-btn" onclick="editPhysicianInfo()">Edit</button>
<button class="delete-btn" onclick="deletePhysician()">Delete</button>
</div>
</div>
<div class="contact-grid">
${ci('‚úâÔ∏è','Physician Email',p.email?`<a href="mailto:${p.email}">${p.email}</a>`:'')}
${ci('üìù','General Notes',p.general_notes)}
${!p.email&&!p.general_notes?'<div class="empty-notice">Click Edit to add email and notes</div>':''}
</div>
</div>
<div class="section">
<div class="section-header">
<h3>Practice Locations</h3>
<button class="edit-btn" onclick="openAssignLocationModal()">+ Assign Location</button>
</div>
${assignments.length === 0 ?
'<div class="empty-notice">No locations assigned. Click + Assign Location to add practice locations.</div>' :
'<div class="locations-grid">' +
assignments.map(assign => {
const loc = assign.practice_locations || practiceLocations.find(l => l.id === assign.practice_location_id);
if (!loc) return '';
const practiceName = loc.practices?.name || practices.find(pr => pr.id === loc.practice_id)?.name || '';
return `
<div class="location-card ${assign.is_primary ? 'primary' : ''}">
<div class="location-card-header">
<div class="location-label">
${loc.label || 'Office'}
${assign.is_primary ? '<span class="location-badge">Primary</span>' : ''}
${practiceName ? `<span class="practice-badge">${practiceName}</span>` : ''}
</div>
<div class="location-actions">
<button class="icon-btn" onclick="removeAssignment('${assign.id}')" title="Remove">üóëÔ∏è</button>
</div>
</div>
<div class="location-details">
${ld(loc.address,'üìç',`${loc.address}${loc.city?', '+loc.city:''}${loc.zip?' '+loc.zip:''}`)}
${ld(loc.phone,'üìû',`<a href="tel:${(loc.phone||'').replace(/\D/g,'')}">${loc.phone}</a>`)}
${ld(loc.fax,'üì†')}${ld(loc.practice_email,'‚úâÔ∏è',`<a href="mailto:${loc.practice_email}">${loc.practice_email}</a>`)}
${ld(loc.office_hours,'üïê')}${ld(loc.office_staff,'üë•')}${ld(loc.receptionist_name,'üë§')}${ld(loc.best_days,'üìÖ')}
</div>
</div>
`}).join('') +
'</div>'
}
</div>
<div class="section">
<div class="section-header">
<h3>Activity Log</h3>
<button class="edit-btn" onclick="openContactModal()">+ Add Note</button>
</div>
${logs.length === 0 ?
'<div class="empty-notice">No contact history yet. Click + Add Note to record your first call or visit.</div>' :
'<div class="contact-entries">' +
logs.map(e => {
const tm = (e.notes||'').match(/^\[(\d{1,2}:\d{2}(?:\s*[APap][Mm])?)\]\s*/);
const displayTime = tm ? ' ' + tm[1] : '';
const displayNotes = tm ? e.notes.replace(tm[0], '') : (e.notes||'');
return `
<div class="contact-entry">
<div class="contact-entry-header">
<div>
<span class="contact-entry-date">${e.contact_date}${displayTime}${e.author ? ' - ' + e.author : ''}</span>
${e.practice_location_id ? '<span class="contact-entry-location">' + getLocationLabel(e.practice_location_id) + '</span>' : ''}
<span class="contact-entry-timestamp">${formatTimestamp(e.created_at)}</span>
</div>
<div class="contact-entry-actions">
<button class="icon-btn" onclick="editNote('${e.id}')" title="Edit">‚úèÔ∏è</button>
<button class="icon-btn" onclick="deleteNote('${e.id}')" title="Delete">üóëÔ∏è</button>
</div>
</div>
<div class="contact-entry-notes">${displayNotes}</div>
</div>
`;}).join('') +
'</div>'
}
</div>
`;
}
function renderPracticeProfile() {
const p = currentPractice;
const locations = practiceLocations.filter(l => l.practice_id === p.id);
const practicePhysicians = physicians.filter(phys => {
const assigns = physicianAssignments[phys.id] || [];
return assigns.some(a => {
const loc = a.practice_locations || practiceLocations.find(l => l.id === a.practice_location_id);
return loc && loc.practice_id === p.id;
});
});
$('mainContent').innerHTML = `
<div class="profile-header">
<div class="profile-name">${p.name}</div>
<div class="profile-practice">${p.website ? `<a href="${p.website}" target="_blank">${p.website}</a>` : 'No website'}</div>
<div class="profile-meta">
${mi('Locations',locations.length)}${mi('Physicians',practicePhysicians.length)}${mi('Cities',[...new Set(locations.map(l=>l.city).filter(Boolean))].join(', ')||'N/A')}
</div>
</div>
<div class="section">
<div class="section-header">
<h3>Practice Details</h3>
<div>
<button class="edit-btn" onclick="editPractice()">Edit</button>
<button class="delete-btn" onclick="deletePractice()">Delete</button>
</div>
</div>
<div class="contact-grid">${ci('üìù','Notes',p.general_notes)||'<div class="empty-notice">No notes for this practice</div>'}</div>
</div>
<div class="section">
<div class="section-header">
<h3>Locations</h3>
<button class="edit-btn" onclick="openLocationModal('${p.id}')">+ Add Location</button>
</div>
${locations.length === 0 ?
'<div class="empty-notice">No locations yet. Click + Add Location to add an address.</div>' :
'<div class="locations-grid">' +
locations.map(loc => `
<div class="location-card">
<div class="location-card-header">
<div class="location-label">${loc.label || 'Office'}</div>
<div class="location-actions">
<button class="icon-btn" onclick="editLocationDetails('${loc.id}')" title="Edit">‚úèÔ∏è</button>
<button class="icon-btn" onclick="deleteLocation('${loc.id}')" title="Delete">üóëÔ∏è</button>
</div>
</div>
<div class="location-details">
${ld(loc.address,'üìç',`${loc.address}${loc.city?', '+loc.city:''}${loc.zip?' '+loc.zip:''}`)}
${ld(loc.phone,'üìû',`<a href="tel:${(loc.phone||'').replace(/\D/g,'')}">${loc.phone}</a>`)}
${ld(loc.fax,'üì†')}
</div>
</div>
`).join('') +
'</div>'
}
</div>
<div class="section">
<div class="section-header">
<h3>Physicians at this Practice</h3>
<button class="edit-btn" onclick="openAssignPhysicianModal()">+ Assign Physician</button>
</div>
${practicePhysicians.length === 0 ?
'<div class="empty-notice">No physicians assigned to this practice yet.</div>' :
'<div class="contact-grid">' +
practicePhysicians.map(phys => `
<div class="contact-item" style="cursor: pointer;" onclick="viewPhysician('${phys.id}'); setView('physicians');">
<div class="contact-icon">üë®‚Äç‚öïÔ∏è</div>
<div class="contact-item-content">
<div class="contact-item-label">${phys.priority || 'No tier'}</div>
<div class="contact-item-value">${fmtName(phys)}</div>
</div>
</div>
`).join('') +
'</div>'
}
</div>
`;
}
function openPhysicianModal() {
editMode=false;selectedPracticeId=null;selectedLocationIds=[];$('modalTitle').textContent='Add Physician';
$('physicianForm').reset();setFields({priority:'',specialty:''});
$('newPracticeFields').style.display='none';$('locationSelector').style.display='none';
$('physicianSaveBtn').textContent='Save Physician';$('physicianSaveBtn').className='btn-primary';
populatePracticeOptions();$('physicianModal').classList.add('active');
}
function closePhysicianModal(){$('physicianModal').classList.remove('active');}
function populatePracticeOptions() {
const container = $('practiceOptions');
const search = ($('practiceSearchInput')?.value || '').toLowerCase();
const filtered = search ? practices.filter(p => p.name.toLowerCase().includes(search)) : practices;
container.innerHTML = filtered.map(p => `
<div class="selector-option ${selectedPracticeId === p.id ? 'selected' : ''}"
onclick="selectPractice('${p.id}')">
<input type="radio" name="practice" ${selectedPracticeId === p.id ? 'checked' : ''}>
<span class="selector-option-label">${p.name}</span>
</div>
`).join('') || '<div class="empty-notice">No practices found.</div>';
}
function filterPracticeOptions() { populatePracticeOptions(); }
function filterAssignLocationOptions() {
const search = ($('assignLocationSearch')?.value || '').toLowerCase();
document.querySelectorAll('#assignLocationOptions > div').forEach(group => {
const name = group.querySelector('div[style]')?.textContent?.toLowerCase() || '';
const locs = group.querySelectorAll('.selector-option');
let anyVisible = false;
locs.forEach(loc => {
const text = loc.textContent.toLowerCase();
const match = !search || name.includes(search) || text.includes(search);
loc.style.display = match ? '' : 'none';
if (match) anyVisible = true;
});
group.style.display = anyVisible ? '' : 'none';
});
}
function selectPractice(practiceId) {
selectedPracticeId = practiceId;
populatePracticeOptions();
populateLocationOptions(practiceId);
$('locationSelector').style.display = 'block';
$('newPracticeFields').style.display = 'none';
}
function populateLocationOptions(practiceId) {
const locations = practiceLocations.filter(l => l.practice_id === practiceId);
const container = $('locationOptions');
if (locations.length === 0) {
container.innerHTML = '<div class="empty-notice">No locations for this practice. Add one below.</div>';
return;
}
container.innerHTML = locations.map(loc => `
<div class="selector-option ${selectedLocationIds.includes(loc.id) ? 'selected' : ''}"
onclick="toggleLocationSelection('${loc.id}')">
<input type="checkbox" ${selectedLocationIds.includes(loc.id) ? 'checked' : ''}>
<div>
<span class="selector-option-label">${loc.label || 'Office'}</span>
<div class="selector-option-sub">${loc.city || ''} ${loc.zip || ''}</div>
</div>
</div>
`).join('');
}
function toggleLocationSelection(locationId) {
const index = selectedLocationIds.indexOf(locationId);
if (index === -1) {
selectedLocationIds.push(locationId);
} else {
selectedLocationIds.splice(index, 1);
}
populateLocationOptions(selectedPracticeId);
}
function toggleNewPractice() {
const fields = $('newPracticeFields');
fields.style.display = fields.style.display === 'none' ? 'block' : 'none';
if (fields.style.display === 'block') {
selectedPracticeId = null;
populatePracticeOptions();
$('locationSelector').style.display = 'none';
}
}
async function toggleNewLocation() {
let practiceId = selectedPracticeId;
if (!practiceId) {
const npn = $('newPracticeName').value;
if (!npn) { showToast('Please select or create a practice first', 'error'); return; }
try {
const {data:np,error} = await db.from('practices').insert({name:npn}).select().single();
if (error) throw error;
practices.push(np);
practiceId = np.id;
selectedPracticeId = np.id;
showToast('Practice created: ' + npn, 'success');
} catch(e) { showToast('Error creating practice: ' + e.message, 'error'); return; }
}
closePhysicianModal();
openLocationModal(practiceId);
}
function editPhysicianInfo() {
editMode=true;const p=currentPhysician;$('modalTitle').textContent='Edit Physician';
setFields({firstName:p.first_name,lastName:p.last_name,physicianEmail:p.email||'',priority:p.priority||'',specialty:p.specialty||'',umConnection:p.um_connection||'',patientVolume:p.patient_volume||p.mohs_volume||'',physicianGeneralNotes:p.general_notes||'',degree:p.degree||'',staffTitle:p.title||''});
$('practiceSelector').style.display='none';$('locationSelector').style.display='none';
$('physicianSaveBtn').textContent='Save Physician';$('physicianSaveBtn').className='btn-primary';$('physicianModal').classList.add('active');
}
async function savePhysician(e) {
e.preventDefault();
const data = {first_name:$('firstName').value,last_name:$('lastName').value,email:$('physicianEmail').value||null,priority:$('priority').value||null,specialty:$('specialty').value||null,um_connection:$('umConnection').value||null,patient_volume:$('patientVolume').value||null,general_notes:$('physicianGeneralNotes').value||null};
const degreeVal=$('degree').value||null;const titleVal=$('staffTitle').value||null;
if(degreeVal)data.degree=degreeVal;if(titleVal)data.title=titleVal;
await withSave('physicianSaveBtn','Save Physician',async()=>{
if(editMode){const{error}=await db.from('physicians').update(data).eq('id',currentPhysician.id);if(error)throw error;Object.assign(currentPhysician,data);renderProfile();showToast('Physician updated','success');
}else{
let practiceId=selectedPracticeId;const npn=$('newPracticeName').value;
if(npn&&!practiceId){const{data:np,error:pe}=await db.from('practices').insert({name:npn}).select().single();if(pe)throw pe;practiceId=np.id;practices.push(np);}
const{data:newP,error}=await db.from('physicians').insert(data).select().single();if(error)throw error;
if(selectedLocationIds.length>0){const a=selectedLocationIds.map((lid,i)=>({physician_id:newP.id,practice_location_id:lid,is_primary:i===0}));const{error:ae}=await db.from('physician_location_assignments').insert(a);if(ae)throw ae;}
else if(practiceId){
// Auto-create a default location for the new practice and assign physician
const existingLocs=practiceLocations.filter(l=>l.practice_id===practiceId);
if(existingLocs.length>0){
// Assign to first existing location
const{error:ae}=await db.from('physician_location_assignments').insert({physician_id:newP.id,practice_location_id:existingLocs[0].id,is_primary:true});
if(ae)throw ae;
}else{
// Create a default location and assign
const{data:newLoc,error:le}=await db.from('practice_locations').insert({practice_id:practiceId,label:'Main Office'}).select().single();
if(le)throw le;
const{error:ae}=await db.from('physician_location_assignments').insert({physician_id:newP.id,practice_location_id:newLoc.id,is_primary:true});
if(ae)throw ae;
}
}
physicians.push(newP);physicians.sort((a,b)=>a.last_name.localeCompare(b.last_name));showToast('Physician added','success');
}
await loadAllData();renderList();setTimeout(()=>closePhysicianModal(),500);
});
}
async function deletePhysician() {
await dbDel('physicians',currentPhysician.id,`Delete ${fmtName(currentPhysician)}?`,async()=>{physicians=physicians.filter(p=>p.id!==currentPhysician.id);currentPhysician=null;renderList();renderEmptyState();});
}
function openPracticeModal(){editingPracticeId=null;$('practiceModalTitle').textContent='Add Practice';$('practiceForm').reset();$('practiceAddressSection').style.display='';$('practiceSaveBtn').textContent='Save Practice';$('practiceSaveBtn').className='btn-primary';$('practiceModal').classList.add('active');}
function closePracticeModal(){$('practiceModal').classList.remove('active');}
function editPractice(){editingPracticeId=currentPractice.id;$('practiceModalTitle').textContent='Edit Practice';setFields({practiceName:currentPractice.name,practiceWebsite:currentPractice.website||'',practiceNotes:currentPractice.general_notes||''});$('practiceAddressSection').style.display='none';$('practiceSaveBtn').textContent='Save Practice';$('practiceSaveBtn').className='btn-primary';$('practiceModal').classList.add('active');}
async function savePractice(e) {
e.preventDefault();
const data={name:$('practiceName').value,website:$('practiceWebsite').value||null,general_notes:$('practiceNotes').value||null};
await withSave('practiceSaveBtn','Save Practice',async()=>{
if(editingPracticeId){const{error}=await db.from('practices').update(data).eq('id',editingPracticeId);if(error)throw error;showToast('Practice updated','success');
}else{const{data:newPract,error}=await db.from('practices').insert(data).select().single();if(error)throw error;
const addr=$('practiceAddress').value,city=$('practiceCity').value,zip=$('practiceZip').value,ph=$('practicePhone').value,fx=$('practiceFax').value;
if(addr||city){const locData={practice_id:newPract.id,label:'Main Office',address:addr||null,city:city||null,zip:zip||null,phone:ph||null,fax:fx||null};const{error:le}=await db.from('practice_locations').insert(locData);if(le)console.error('Location insert error:',le);}
showToast('Practice added','success');}
await loadAllData();if(currentPractice){currentPractice=practices.find(p=>p.id===currentPractice.id);renderPracticeProfile();}
setTimeout(()=>closePracticeModal(),500);
});
}
async function deletePractice() {
await dbDel('practices',currentPractice.id,`Delete ${currentPractice.name}? This will also delete all its locations.`,async()=>{practices=practices.filter(p=>p.id!==currentPractice.id);currentPractice=null;await loadAllData();renderList();renderEmptyState();});
}
function openLocationModal(practiceId = null) {
editingLocationId = null;
$('locationModalTitle').textContent = 'Add Location';
$('locationForm').reset();
$('locationIsPrimary').value = 'false';
$('locationSaveBtn').textContent = 'Save Location';
$('locationSaveBtn').className = 'btn-primary';
const select = $('locationPracticeId');
select.innerHTML = '<option value="">-- Select Practice --</option>' +
practices.map(p => `<option value="${p.id}" ${p.id === practiceId ? 'selected' : ''}>${p.name}</option>`).join('');
$('locationModal').classList.add('active');
}
function closeLocationModal() {
$('locationModal').classList.remove('active');
}
function editLocationDetails(locationId) {
const loc=practiceLocations.find(l=>l.id===locationId);if(!loc)return;
editingLocationId=locationId;$('locationModalTitle').textContent='Edit Location';
setFields({locationPracticeId:loc.practice_id,locationLabel:loc.label||'',locationIsPrimary:'false',locationAddress:loc.address||'',locationCity:loc.city||'',locationZip:loc.zip||'',locationPhone:loc.phone||'',locationFax:loc.fax||'',locationEmail:loc.practice_email||'',locationHours:loc.office_hours||'',locationStaff:loc.office_staff||'',locationReceptionist:loc.receptionist_name||'',locationBestDays:loc.best_days||''});
$('locationSaveBtn').textContent='Save Location';$('locationSaveBtn').className='btn-primary';
$('locationPracticeId').innerHTML='<option value="">-- Select Practice --</option>'+practices.map(p=>`<option value="${p.id}" ${p.id===loc.practice_id?'selected':''}>${p.name}</option>`).join('');
$('locationModal').classList.add('active');
}
async function saveLocation(e) {
e.preventDefault();
const data={practice_id:$('locationPracticeId').value,label:$('locationLabel').value,address:$('locationAddress').value||null,city:$('locationCity').value||null,zip:$('locationZip').value||null,phone:$('locationPhone').value||null,fax:$('locationFax').value||null,practice_email:$('locationEmail').value||null,office_hours:$('locationHours').value||null,office_staff:$('locationStaff').value||null,receptionist_name:$('locationReceptionist').value||null,best_days:$('locationBestDays').value||null};
await withSave('locationSaveBtn','Save Location',async()=>{
if(editingLocationId){const{error}=await db.from('practice_locations').update(data).eq('id',editingLocationId);if(error)throw error;showToast('Location updated','success');
}else{const{error}=await db.from('practice_locations').insert(data);if(error)throw error;showToast('Location added','success');}
await loadAllData();if(currentPractice)renderPracticeProfile();setTimeout(()=>closeLocationModal(),500);
});
}
async function deleteLocation(locationId) {
await dbDel('practice_locations',locationId,'Delete this location and all physician assignments?',async()=>{await loadAllData();if(currentPractice)renderPracticeProfile();});
}
function openAssignLocationModal() {
const existingAssignments = (physicianAssignments[currentPhysician.id] || []).map(a => a.practice_location_id);
const container = $('assignLocationOptions');
container.innerHTML = practices.map(practice => {
const locations = practiceLocations.filter(l => l.practice_id === practice.id);
if (locations.length === 0) return '';
return `
<div style="margin-bottom: 1rem;">
<div style="font-weight: 600; margin-bottom: 0.5rem; color: #0a4d3c;">${practice.name}</div>
${locations.map(loc => `
<div class="selector-option" data-loc-id="${loc.id}" onclick="toggleAssignLocation('${loc.id}', this)">
<input type="checkbox" ${existingAssignments.includes(loc.id) ? 'checked' : ''}>
<div>
<span class="selector-option-label">${loc.label || 'Office'}</span>
<div class="selector-option-sub">${loc.city || ''} ${loc.address || ''}</div>
</div>
</div>
`).join('')}
</div>
`;
}).join('') || '<div class="empty-notice">No locations available. Create a practice and location first.</div>';
$('assignLocationModal').classList.add('active');
}
function closeAssignLocationModal() {
$('assignLocationModal').classList.remove('active');
}
function toggleAssignLocation(locationId, element) {
const checkbox = element.querySelector('input[type="checkbox"]');
checkbox.checked = !checkbox.checked;
}
async function saveLocationAssignments() {
const options = document.querySelectorAll('#assignLocationOptions .selector-option');
const selectedIds = [];
options.forEach(opt => {
const cb = opt.querySelector('input[type="checkbox"]');
const locId = opt.getAttribute('data-loc-id');
if (cb && cb.checked && locId) selectedIds.push(locId);
});
try {
updateSyncIndicators('syncing');
const {error:delErr} = await db
.from('physician_location_assignments')
.delete()
.eq('physician_id', currentPhysician.id);
if (delErr) throw delErr;
if (selectedIds.length > 0) {
const assignments = selectedIds.map((locId, index) => ({
physician_id: currentPhysician.id,
practice_location_id: locId,
is_primary: index === 0
}));
const { error } = await db
.from('physician_location_assignments')
.insert(assignments);
if (error) throw error;
}
await loadAllData();
renderProfile();
closeAssignLocationModal();
showToast('Location assignments updated', 'success');
updateSyncIndicators('synced');
} catch (error) {
console.error('Save error:', error);
showToast('Error saving: ' + error.message, 'error');
updateSyncIndicators('error');
}
}
async function quickAddPracticeAndAssign() {
const name = $('quickPracticeName').value.trim();
if (!name) { showToast('Practice name required', 'error'); return; }
try {
updateSyncIndicators('syncing');
const {data:newPract,error:pe} = await db.from('practices').insert({name}).select().single();
if (pe) throw pe;
const locData = {practice_id:newPract.id,label:'Main Office',address:$('quickPracticeAddr').value||null,city:$('quickPracticeCity').value||null,zip:$('quickPracticeZip').value||null,phone:$('quickPracticePhone').value||null};
const {data:newLoc,error:le} = await db.from('practice_locations').insert(locData).select().single();
if (le) throw le;
const {error:ae} = await db.from('physician_location_assignments').insert({physician_id:currentPhysician.id,practice_location_id:newLoc.id,is_primary:false});
if (ae) throw ae;
await loadAllData();
renderProfile();
closeAssignLocationModal();
showToast(`${name} created and assigned`, 'success');
updateSyncIndicators('synced');
} catch(e) {
console.error('Quick add practice error:', e);
showToast('Error: ' + e.message, 'error');
updateSyncIndicators('error');
}
}
async function removeAssignment(assignmentId) {
await dbDel('physician_location_assignments',assignmentId,'Remove this location assignment?',async()=>{await loadAllData();renderProfile();});
}
function openContactModal() {
editingContactId = null;
$('contactForm').reset();
$('contactModalTitle').textContent = 'Add Contact Note';
$('authorName').value = 'Tom';
$('contactSaveBtn').textContent = 'Save Note';
$('contactSaveBtn').className = 'btn-primary';
setToday();
populateLocationDropdown();
$('contactModal').classList.add('active');
}
function populateLocationDropdown() {
const select = $('contactLocation');
const assignments = physicianAssignments[currentPhysician.id] || [];
const locations = assignments.map(a => {
const loc = practiceLocations.find(l => l.id === a.practice_location_id);
if (loc) {
const practice = practices.find(p => p.id === loc.practice_id);
return {
id: loc.id,
label: `${loc.address}, ${loc.city}${practice ? ' (' + practice.name + ')' : ''}`
};
}
return null;
}).filter(Boolean);
select.innerHTML = locations.length === 1
? `<option value="${locations[0].id}">${locations[0].label}</option>`
: '<option value="">Select location...</option>' +
locations.map(l => `<option value="${l.id}">${l.label}</option>`).join('');
$('locationSelectRow').style.display = locations.length <= 1 ? 'none' : 'block';
if (locations.length === 1) {
select.value = locations[0].id;
}
}
function closeContactModal() {
$('contactModal').classList.remove('active');
}
async function saveContact(e) {
e.preventDefault();
const tv=$('contactTime').value,nv=$('contactNotes').value;
const locVal=$('contactLocation').value||null;
const data={physician_id:currentPhysician.id,contact_date:$('contactDate').value,author:$('authorName').value,practice_location_id:locVal,notes:tv?`[${tv}] ${nv}`:nv};
await withSave('contactSaveBtn','Save Note',async()=>{
if(editingContactId){const{error}=await db.from('contact_logs').update(data).eq('id',editingContactId);if(error)throw error;showToast('Note updated','success');
}else{const{error}=await db.from('contact_logs').insert(data);if(error)throw error;showToast('Note added','success');}
await db.from('physicians').update({last_contact:data.contact_date}).eq('id',currentPhysician.id);
currentPhysician.last_contact=data.contact_date;await loadContactLogs(currentPhysician.id);renderProfile();setTimeout(()=>closeContactModal(),500);
});
}
async function editNote(logId) {
const log = (contactLogs[currentPhysician.id] || []).find(l => l.id === logId);
if (!log) return;
editingContactId = logId;
$('contactModalTitle').textContent = 'Edit Contact Note';
$('contactSaveBtn').textContent = 'Save Note';
$('contactSaveBtn').className = 'btn-primary';
populateLocationDropdown();
$('contactDate').value = log.contact_date;
$('contactLocation').value = log.practice_location_id || '';
$('authorName').value = log.author || '';
// Parse time from notes if stored as [HH:MM] prefix
let notes = log.notes || '';
let time = '';
if (!time) {
const timeMatch = notes.match(/^\[(\d{1,2}:\d{2})\]\s*/);
if (timeMatch) {
time = timeMatch[1];
notes = notes.replace(timeMatch[0], '');
}
}
$('contactTime').value = time;
$('contactNotes').value = notes;
$('contactModal').classList.add('active');
}
async function deleteNote(logId) {
await dbDel('contact_logs',logId,'Delete this note?',async()=>{await loadContactLogs(currentPhysician.id);renderProfile();});
}
function toggleAdminPanel() {
const panel = $('adminPanel');
panel.classList.toggle('show');
}
async function importCSV(file) {
if(!file)return;
const status=s=>{const el=$('importStatus');if(el)el.textContent=s;const el2=$('importStatusMain');if(el2)el2.textContent=s;};
status('Reading CSV...');
try{
const text=await file.text();
const lines=text.split('\n').filter(l=>l.trim());
const headers=lines[0].split(',').map(h=>h.trim().toLowerCase().replace(/\s+/g,'_'));
const rows=[];
for(let i=1;i<lines.length;i++){
const vals=[];let cur='',inQ=false;
for(const ch of lines[i]){if(ch==='"'){inQ=!inQ;}else if(ch===','&&!inQ){vals.push(cur.trim());cur='';}else{cur+=ch;}}
vals.push(cur.trim());
const row={};headers.forEach((h,j)=>row[h]=vals[j]||'');rows.push(row);
}
status(`Parsed ${rows.length} rows. Importing...`);
updateSyncIndicators('syncing');
// Build unique practices
const practiceNames=[...new Set(rows.map(r=>r.practice_name).filter(Boolean))];
const practiceMap={};
for(const name of practiceNames){
const{data:ex}=await db.from('practices').select('*').eq('name',name).maybeSingle();
if(ex){practiceMap[name]=ex.id;}else{
const{data:np,error}=await db.from('practices').insert({name}).select().maybeSingle();
if(np)practiceMap[name]=np.id;
}}
// Group by physician name, collect locations
const physMap=new Map();
rows.forEach(r=>{
const key=`${(r.first_name||'').toLowerCase()}|${(r.last_name||'').toLowerCase()}`;
if(!physMap.has(key))physMap.set(key,{phys:{first_name:r.first_name,last_name:r.last_name,email:r.email||null,priority:r.priority||null,um_connection:r.um_connection||null,specialty:r.specialty||null,general_notes:r.general_notes||null},locs:[]});
const e=physMap.get(key);
if(r.address&&r.address!=='[Research needed]')e.locs.push({practice_id:practiceMap[r.practice_name],address:r.address,city:r.city,zip:r.zip,phone:r.phone,fax:r.fax,label:r.city||'Office',is_primary:e.locs.length===0});
});
// Insert physicians
let count=0;const total=physMap.size;
for(const[key,entry] of physMap){
count++;if(count%10===0)status(`Importing physician ${count} of ${total}...`);
const{data:ex}=await db.from('physicians').select('*').ilike('first_name',entry.phys.first_name).ilike('last_name',entry.phys.last_name).maybeSingle();
const phys=ex||(await db.from('physicians').insert(entry.phys).select().maybeSingle()).data;
if(!phys)continue;
// Create locations and assignments
for(const loc of entry.locs){
if(!loc.practice_id)continue;
const{data:exLoc}=await db.from('practice_locations').select('*').eq('practice_id',loc.practice_id).eq('address',loc.address).maybeSingle();
const locRec=exLoc||(await db.from('practice_locations').insert({practice_id:loc.practice_id,label:loc.label,address:loc.address,city:loc.city,zip:loc.zip,phone:loc.phone,fax:loc.fax}).select().maybeSingle()).data;
if(!locRec)continue;
const{data:exA}=await db.from('physician_location_assignments').select('*').eq('physician_id',phys.id).eq('practice_location_id',locRec.id).maybeSingle();
if(!exA)await db.from('physician_location_assignments').insert({physician_id:phys.id,practice_location_id:locRec.id,is_primary:loc.is_primary});
}}
await loadAllData();
status(`Done! Imported ${physMap.size} physicians, ${practiceNames.length} practices.`);
showToast(`Imported ${physMap.size} physicians`,'success');
updateSyncIndicators('synced');
}catch(e){console.error('Import error:',e);status('Error: '+e.message);showToast('Import failed: '+e.message,'error');updateSyncIndicators('error');}
}
async function clearDatabase() {
const confirmMsg = 'Are you sure you want to DELETE ALL DATA?\n\nThis will remove:\n- All physicians\n- All practices\n- All locations\n- All contact logs\n\nThis cannot be undone!';
if (!confirm(confirmMsg)) return;
if (!confirm('FINAL WARNING: Click OK to permanently delete all data.')) return;
try {
updateSyncIndicators('syncing');
showToast('Clearing database...', 'info');
for(const t of ['contact_logs','physician_location_assignments','physicians','practice_locations','practices']){
const{error,count}=await db.from(t).delete().neq('id','00000000-0000-0000-0000-000000000000');
console.log(`Deleted from ${t}: error=${error?.message||'none'}`);
if(error) throw error;
}
// Verify physicians table is actually empty
const{data:remaining}=await db.from('physicians').select('id,first_name,last_name');
if(remaining&&remaining.length>0){
console.warn(`${remaining.length} physicians survived delete! RLS may be blocking deletions.`);
showToast(`Warning: ${remaining.length} records could not be deleted (database permissions issue). Check Supabase RLS policies.`,'error');
// Try deleting them individually
for(const r of remaining){
const{error:e2}=await db.from('physicians').delete().eq('id',r.id);
console.log(`Individual delete ${r.first_name} ${r.last_name}: ${e2?.message||'ok'}`);
}
}
physicians=[];practices=[];practiceLocations=[];physicianAssignments={};contactLogs={};
currentPhysician=null;currentPractice=null;
await loadAllData();
renderList();
if(physicians.length>0){
showToast(`Clear incomplete: ${physicians.length} physicians remain. Check Supabase RLS/policies.`,'error');
}else{
renderEmptyState();
showToast('Database cleared successfully!', 'success');
}
updateSyncIndicators('synced');
} catch (error) {
console.error('Clear database error:', error);
showToast('Error clearing database: ' + error.message, 'error');
updateSyncIndicators('error');
}
}
function openAssignPhysicianModal() {
const locations = practiceLocations.filter(l => l.practice_id === currentPractice.id);
const select = $('assignPhysLocationSelect');
select.innerHTML = locations.map(loc => `<option value="${loc.id}">${loc.label || 'Office'} - ${loc.address || ''}, ${loc.city || ''}</option>`).join('');
if (locations.length === 0) { showToast('Add a location to this practice first', 'error'); return; }
const locId = select.value;
const existingPhysIds = physicians.filter(p => {
const assigns = physicianAssignments[p.id] || [];
return assigns.some(a => locations.some(l => l.id === a.practice_location_id));
}).map(p => p.id);
renderAssignPhysicianOptions(existingPhysIds);
$('assignPhysSearch').value = '';
$('assignPhysicianModal').classList.add('active');
}
function renderAssignPhysicianOptions(existingPhysIds) {
const search = ($('assignPhysSearch')?.value || '').toLowerCase();
const filtered = search ? physicians.filter(p => `${p.first_name} ${p.last_name}`.toLowerCase().includes(search)) : physicians;
$('assignPhysicianOptions').innerHTML = filtered.map(p => `
<div class="selector-option" data-phys-id="${p.id}" onclick="toggleAssignPhys('${p.id}', this)">
<input type="checkbox" ${existingPhysIds.includes(p.id) ? 'checked' : ''}>
<div>
<span class="selector-option-label">${fmtName(p)}</span>
<div class="selector-option-sub">${p.specialty || ''}</div>
</div>
</div>
`).join('') || '<div class="empty-notice">No physicians found</div>';
}
function filterAssignPhysicianOptions() {
// Preserve current checkbox state before re-rendering
const currentChecked = new Set();
document.querySelectorAll('#assignPhysicianOptions .selector-option').forEach(opt => {
const cb = opt.querySelector('input[type="checkbox"]');
const pid = opt.getAttribute('data-phys-id');
if (cb && cb.checked && pid) currentChecked.add(pid);
});
const locations = practiceLocations.filter(l => l.practice_id === currentPractice.id);
const existingPhysIds = physicians.filter(p => {
const assigns = physicianAssignments[p.id] || [];
return assigns.some(a => locations.some(l => l.id === a.practice_location_id));
}).map(p => p.id);
// Merge: existing DB assignments + manually checked
const mergedIds = [...new Set([...existingPhysIds, ...currentChecked])];
renderAssignPhysicianOptions(mergedIds);
}
function toggleAssignPhys(physId, element) {
const cb = element.querySelector('input[type="checkbox"]');
cb.checked = !cb.checked;
}
function closeAssignPhysicianModal() { $('assignPhysicianModal').classList.remove('active'); }
async function quickAddPhysician() {
const first = $('quickPhysFirst').value.trim();
const last = $('quickPhysLast').value.trim();
if (!first || !last) { showToast('First and last name required', 'error'); return; }
const locId = $('assignPhysLocationSelect').value;
if (!locId) { showToast('Select a location first', 'error'); return; }
try {
updateSyncIndicators('syncing');
const data = {first_name:first,last_name:last,specialty:$('quickPhysSpecialty').value||null,priority:$('quickPhysPriority').value||null};
const {data:newPhys,error} = await db.from('physicians').insert(data).select().single();
if (error) throw error;
// Assign to selected location
const {error:assignErr} = await db.from('physician_location_assignments').insert({physician_id:newPhys.id,practice_location_id:locId,is_primary:true});
if (assignErr) throw assignErr;
await loadAllData();
// Clear quick-add fields
$('quickPhysFirst').value = '';
$('quickPhysLast').value = '';
$('quickPhysSpecialty').value = '';
$('quickPhysPriority').value = '';
renderPracticeProfile();
// Re-render the physician options to show the new physician as checked
const locations = practiceLocations.filter(l => l.practice_id === currentPractice.id);
const existingPhysIds = physicians.filter(p => {
const assigns = physicianAssignments[p.id] || [];
return assigns.some(a => locations.some(l => l.id === a.practice_location_id));
}).map(p => p.id);
renderAssignPhysicianOptions(existingPhysIds);
showToast(`Dr. ${first} ${last} added and assigned`, 'success');
updateSyncIndicators('synced');
} catch(e) {
console.error('Quick add error:', e);
showToast('Error: ' + e.message, 'error');
updateSyncIndicators('error');
}
}
async function savePhysicianToLocation() {
const locId = $('assignPhysLocationSelect').value;
if (!locId) { showToast('Select a location', 'error'); return; }
const options = document.querySelectorAll('#assignPhysicianOptions .selector-option');
const selectedPhysIds = [];
const unselectedPhysIds = [];
options.forEach(opt => {
const cb = opt.querySelector('input[type="checkbox"]');
const physId = opt.getAttribute('data-phys-id');
if (physId && cb) {
if (cb.checked) selectedPhysIds.push(physId);
else unselectedPhysIds.push(physId);
}
});
try {
updateSyncIndicators('syncing');
// Add new assignments
for (const physId of selectedPhysIds) {
const {data:existing} = await db.from('physician_location_assignments').select('id').eq('physician_id',physId).eq('practice_location_id',locId).maybeSingle();
if (!existing) {
const {error} = await db.from('physician_location_assignments').insert({physician_id:physId,practice_location_id:locId,is_primary:false});
if (error) throw error;
}
}
// Remove unchecked assignments
for (const physId of unselectedPhysIds) {
await db.from('physician_location_assignments').delete().eq('physician_id',physId).eq('practice_location_id',locId);
}
await loadAllData();
renderPracticeProfile();
closeAssignPhysicianModal();
showToast('Physicians assigned', 'success');
updateSyncIndicators('synced');
} catch(e) {
console.error('Assign error:', e);
showToast('Error: ' + e.message, 'error');
updateSyncIndicators('error');
}
}
</script>
</body>
</html>
