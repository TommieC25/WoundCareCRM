<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
 <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
 <meta http-equiv="Pragma" content="no-cache">
 <meta http-equiv="Expires" content="0">
 <meta name="apple-mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
 <title>Territory CRM - Miami Wound Care</title>
 <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
 <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
 <style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f5f5f5;-webkit-font-smoothing:antialiased;overflow-x:hidden}.app{display:flex;height:100vh}.connection-status{position:fixed;top:0;left:0;right:0;padding:0.5rem;text-align:center;font-size:0.75rem;font-weight:600;z-index:200;transition:all 0.3s}.connection-status.connected{background:#10b981;color:white}.connection-status.disconnected{background:#ef4444;color:white}.connection-status.syncing{background:#f59e0b;color:white}.connection-status.hidden{transform:translateY(-100%)}.mobile-header{display:none;background:#0a4d3c;color:white;padding:1rem;align-items:center;gap:1rem;position:sticky;top:0;z-index:60;box-shadow:0 2px 4px rgba(0,0,0,0.1)}.mobile-header h1{flex:1;font-size:1.25rem;font-weight:600}.menu-btn,.add-header-btn{background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;padding:0.5rem;display:flex;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent}.sidebar{width:300px;background:#0a4d3c;color:white;display:flex;flex-direction:column;overflow-y:auto;transition:transform 0.3s}.sidebar-header{padding:1.5rem;border-bottom:1px solid rgba(255,255,255,0.1)}.sidebar-header h1{font-size:1.5rem;font-weight:700;margin-bottom:0.25rem}.sidebar-header .subtitle{font-size:0.75rem;opacity:0.7;text-transform:uppercase;letter-spacing:1px}.sidebar-header .count{font-size:0.85rem;margin-top:0.5rem;opacity:0.8}.search-box{padding:0.75rem 1rem;border-bottom:1px solid rgba(255,255,255,0.1)}.search-wrapper{position:relative;display:flex;align-items:center}.search-input{width:100%;padding:0.75rem;padding-right:2.5rem;border:none;border-radius:8px;background:rgba(255,255,255,0.1);color:white;font-size:0.9rem}.search-input::placeholder{color:rgba(255,255,255,0.5)}.search-input:focus{outline:none;background:rgba(255,255,255,0.15)}.search-clear{position:absolute;right:0.5rem;background:rgba(255,255,255,0.3);border:none;color:white;font-size:1.25rem;cursor:pointer;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;padding:0;line-height:1;-webkit-tap-highlight-color:transparent;touch-action:manipulation}.sort-controls{padding:0.5rem 1rem;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;gap:0.5rem;flex-wrap:wrap}.sort-btn{padding:0.4rem 0.75rem;background:rgba(255,255,255,0.1);border:none;border-radius:6px;color:white;font-size:0.75rem;cursor:pointer;transition:all 0.2s}.sort-btn:hover{background:rgba(255,255,255,0.2)}.sort-btn.active{background:#f97316}.physician-list{flex:1;padding:0.5rem;list-style:none;overflow-y:auto}.physician-item{padding:0.875rem;margin-bottom:0.5rem;background:rgba(255,255,255,0.1);border-radius:8px;cursor:pointer;transition:all 0.2s;border-left:3px solid transparent;-webkit-tap-highlight-color:transparent}.physician-item:active{transform:scale(0.98)}.physician-item.active{background:rgba(255,255,255,0.2);border-left-color:#f97316}.physician-item .name{font-weight:600;font-size:0.9rem;margin-bottom:0.25rem}.physician-item .practice{font-size:0.75rem;opacity:0.8}.physician-item .tier{font-size:0.65rem;margin-top:0.25rem;padding:0.125rem 0.5rem;background:rgba(249,115,22,0.3);border-radius:4px;display:inline-block}.physician-item .city-badge{font-size:0.65rem;margin-left:0.25rem;padding:0.125rem 0.5rem;background:rgba(255,255,255,0.2);border-radius:4px;display:inline-block}.add-physician-btn{margin:1rem;padding:1rem;background:#f97316;color:white;border:none;border-radius:8px;font-weight:600;font-size:1rem;cursor:pointer;-webkit-tap-highlight-color:transparent}.add-physician-btn:active{transform:scale(0.98)}.main-content{flex:1;overflow-y:auto;padding:1rem;-webkit-overflow-scrolling:touch}.empty-state{text-align:center;padding:4rem 2rem;color:#666}.empty-state h2{font-size:1.5rem;margin-bottom:1rem}.profile-header{background:white;padding:1.5rem;border-radius:12px;margin-bottom:1rem;box-shadow:0 1px 3px rgba(0,0,0,0.1)}.profile-name{font-size:1.75rem;font-weight:700;color:#0a4d3c;margin-bottom:0.5rem}.profile-practice{font-size:1rem;color:#666;margin-bottom:1rem}.profile-meta{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;padding-top:1rem;border-top:1px solid #e5e5e5}.meta-item{display:flex;flex-direction:column}.meta-label{font-size:0.7rem;text-transform:uppercase;color:#999;letter-spacing:0.5px;margin-bottom:0.25rem}.meta-value{font-weight:600;color:#0a4d3c;font-size:0.9rem}.section{background:white;padding:1.5rem;border-radius:12px;margin-bottom:1rem;box-shadow:0 1px 3px rgba(0,0,0,0.1)}.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:0.75rem;border-bottom:2px solid #f0f0f0}.section-header h3{font-size:1.25rem;color:#0a4d3c}.edit-btn{padding:0.5rem 1rem;background:#0a4d3c;color:white;border:none;border-radius:6px;font-weight:600;font-size:0.85rem;cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:manipulation}.edit-btn:active{transform:scale(0.95)}.delete-btn{padding:0.5rem 1rem;background:#dc2626;color:white;border:none;border-radius:6px;font-weight:600;font-size:0.85rem;cursor:pointer;margin-left:0.5rem}.contact-grid{display:grid;gap:0.75rem}.contact-item{display:flex;gap:0.75rem;padding:0.875rem;background:#f9f9f9;border-radius:8px}.contact-icon{width:40px;height:40px;background:#0a4d3c;color:white;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:1.25rem}.contact-item-content{flex:1}.contact-item-label{font-size:0.7rem;text-transform:uppercase;color:#999;letter-spacing:0.5px;margin-bottom:0.25rem}.contact-item-value{font-weight:500;color:#333;font-size:0.9rem}.contact-item-value a{color:#0a4d3c;text-decoration:none}.form-grid{display:grid;gap:1rem}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}@media (max-width:500px){.form-row{grid-template-columns:1fr}}label{display:block;font-size:0.75rem;font-weight:600;color:#666;margin-bottom:0.25rem;text-transform:uppercase;letter-spacing:0.5px}input,textarea,select{width:100%;padding:0.875rem;border:2px solid #e5e5e5;border-radius:8px;font-size:1rem;font-family:inherit;-webkit-appearance:none}input:focus,textarea:focus,select:focus{outline:none;border-color:#0a4d3c}textarea{resize:vertical;min-height:100px}.btn-primary{width:100%;padding:1rem;background:#0a4d3c;color:white;border:none;border-radius:8px;font-weight:600;font-size:1rem;cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:manipulation}.btn-primary:active{transform:scale(0.98)}.btn-primary:disabled{background:#ccc;cursor:not-allowed}.btn-primary.saving{background:#f59e0b;pointer-events:none}.btn-primary.saved{background:#10b981}.contact-entries{display:flex;flex-direction:column;gap:0.75rem}.contact-entry{padding:1rem;background:#f9f9f9;border-left:4px solid #0a4d3c;border-radius:8px}.contact-entry-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem}.contact-entry-date{font-size:0.75rem;color:#999;text-transform:uppercase;letter-spacing:0.5px}.contact-entry-location{display:block;font-size:0.8rem;color:#0a4d3c;margin-top:0.25rem}.contact-entry-timestamp{font-size:0.7rem;color:#bbb;margin-left:0.5rem;font-style:italic}.contact-entry-actions{display:flex;gap:0.5rem}.icon-btn{background:none;border:none;font-size:1rem;cursor:pointer;padding:0.25rem;opacity:0.6;transition:opacity 0.2s;touch-action:manipulation;-webkit-tap-highlight-color:transparent}.icon-btn:hover{opacity:1}.contact-entry-notes{font-size:0.9rem;line-height:1.5;color:#333;white-space:pre-wrap}.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:100;padding:1rem;overflow-y:auto;-webkit-overflow-scrolling:touch}.modal.active{display:flex;align-items:center;justify-content:center}.modal-content{background:white;border-radius:16px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;-webkit-overflow-scrolling:touch;box-shadow:0 20px 25px -5px rgba(0,0,0,0.2)}.modal-header{display:flex;justify-content:space-between;align-items:center;padding:1.5rem;border-bottom:1px solid #e5e5e5;position:sticky;top:0;background:white;border-radius:16px 16px 0 0}.modal-header h2{font-size:1.5rem;color:#0a4d3c}.close-btn{background:none;border:none;font-size:2rem;cursor:pointer;color:#999;padding:0;width:40px;height:40px;display:flex;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent}.modal-body{padding:1.5rem}.locations-grid{display:flex;flex-direction:column;gap:1rem}.location-card{background:#f9f9f9;border-radius:10px;padding:1rem;border-left:4px solid #0a4d3c}.location-card.primary{border-left-color:#f97316}.location-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem}.location-label{font-weight:600;color:#0a4d3c;font-size:0.95rem}.location-badge{font-size:0.65rem;padding:0.2rem 0.5rem;background:#f97316;color:white;border-radius:4px;text-transform:uppercase;font-weight:600}.practice-badge{font-size:0.65rem;padding:0.2rem 0.5rem;background:#0a4d3c;color:white;border-radius:4px;margin-left:0.25rem}.location-actions{display:flex;gap:0.25rem}.location-details{display:grid;gap:0.5rem}.location-detail{display:flex;align-items:flex-start;gap:0.5rem;font-size:0.85rem}.location-detail-icon{flex-shrink:0;width:20px;text-align:center}.location-detail-value{color:#333}.location-detail-value a{color:#0a4d3c;text-decoration:none}.add-location-btn{display:flex;align-items:center;justify-content:center;gap:0.5rem;padding:1rem;background:rgba(10,77,60,0.05);border:2px dashed #0a4d3c;border-radius:10px;color:#0a4d3c;font-weight:600;cursor:pointer;transition:all 0.2s}.add-location-btn:hover{background:rgba(10,77,60,0.1)}.selector-section{margin-bottom:1rem;padding:1rem;background:#f0f9ff;border-radius:8px;border:1px solid #bae6fd}.selector-section h4{color:#0369a1;margin-bottom:0.75rem;font-size:0.9rem}.selector-options{display:flex;flex-direction:column;gap:0.5rem;max-height:200px;overflow-y:auto}.selector-option{display:flex;align-items:center;gap:0.5rem;padding:0.5rem;background:white;border-radius:6px;cursor:pointer;transition:all 0.2s;touch-action:manipulation;-webkit-tap-highlight-color:transparent}.selector-option:hover{background:#e0f2fe}.selector-option.selected{background:#0ea5e9;color:white}.selector-option input[type="checkbox"],.selector-option input[type="radio"]{width:18px;height:18px;margin:0;accent-color:#0ea5e9;cursor:pointer}.selector-option input[type="checkbox"]:checked{background-color:#0ea5e9}.selector-option input[type="checkbox"]{-webkit-appearance:none;-moz-appearance:none;appearance:none;border:2px solid #0ea5e9;border-radius:3px;background:#e0f2fe;position:relative;flex-shrink:0;pointer-events:none}.selector-option input[type="checkbox"]:checked{background-color:#0ea5e9;border-color:#0ea5e9}.selector-option input[type="checkbox"]:checked::after{content:'‚úì';position:absolute;color:white;font-size:14px;font-weight:bold;top:50%;left:50%;transform:translate(-50%,-50%)}.selector-option-label{flex:1;font-size:0.85rem}.selector-option-sub{font-size:0.75rem;opacity:0.7}.btn-secondary{padding:0.5rem 1rem;background:#e5e5e5;color:#333;border:none;border-radius:6px;font-weight:600;font-size:0.85rem;cursor:pointer;margin-top:0.5rem;touch-action:manipulation;-webkit-tap-highlight-color:transparent}.btn-secondary:hover{background:#d5d5d5}@media (max-width:768px){.app{flex-direction:column}.mobile-header{display:flex}.sidebar{position:fixed;top:0;left:0;bottom:0;z-index:50;transform:translateX(-100%);box-shadow:2px 0 8px rgba(0,0,0,0.1)}.sidebar.open{transform:translateX(0)}.main-content{padding:0.5rem}.profile-name{font-size:1.5rem}.section{padding:1rem}}.loading{text-align:center;padding:3rem;color:#666}.empty-notice{text-align:center;padding:2rem;color:#999;font-style:italic}.sync-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-left:0.5rem;animation:pulse 1.5s infinite}.sync-indicator.synced{background:#10b981}.sync-indicator.syncing{background:#f59e0b;animation:pulse 0.5s infinite}.sync-indicator.error{background:#ef4444}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}.toast-container{position:fixed;bottom:1rem;right:1rem;z-index:300;display:flex;flex-direction:column;gap:0.5rem}.toast{padding:1rem 1.5rem;border-radius:8px;color:white;font-weight:500;box-shadow:0 4px 12px rgba(0,0,0,0.15);animation:slideIn 0.3s ease}.toast.success{background:#10b981}.toast.error{background:#ef4444}.toast.info{background:#3b82f6}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}.view-tabs{display:flex;gap:0.5rem;padding:0.5rem 1rem;border-bottom:1px solid rgba(255,255,255,0.1)}.view-tab{padding:0.5rem 1rem;background:rgba(255,255,255,0.1);border:none;border-radius:6px;color:white;font-size:0.8rem;cursor:pointer;transition:all 0.2s}.view-tab:hover{background:rgba(255,255,255,0.2)}.view-tab.active{background:#f97316}.admin-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;padding:0.4rem 0.75rem;border-radius:6px;font-size:0.75rem;cursor:pointer;margin-top:0.5rem;transition:all 0.2s}.admin-btn:hover{background:rgba(255,255,255,0.2)}.admin-panel{background:#1a1a2e;border:1px solid #333;border-radius:8px;padding:1rem;margin-top:1rem;display:none}.admin-panel.show{display:block}.admin-panel h4{color:#f97316;margin-bottom:0.75rem;font-size:0.9rem}.admin-panel p{color:#aaa;font-size:0.8rem;margin-bottom:0.75rem}.btn-danger{background:#dc2626;color:white;border:none;padding:0.6rem 1rem;border-radius:6px;font-size:0.85rem;cursor:pointer;width:100%;margin-bottom:0.5rem;transition:all 0.2s}.btn-danger:hover{background:#b91c1c}.btn-warning{background:#f59e0b;color:white;border:none;padding:0.6rem 1rem;border-radius:6px;font-size:0.85rem;cursor:pointer;width:100%;transition:all 0.2s}.btn-warning:hover{background:#d97706}.loc-edit-card{background:#f0f9f6;border:1px solid #d1e7dd;border-radius:10px;padding:1rem;margin-bottom:0.75rem;position:relative}.loc-edit-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;padding-bottom:0.5rem;border-bottom:1px solid #d1e7dd}.loc-edit-card-title{font-weight:600;color:#0a4d3c;font-size:0.85rem}.loc-edit-card .remove-loc-btn{background:none;border:none;color:#dc2626;font-size:1.1rem;cursor:pointer;padding:0.25rem 0.5rem;border-radius:4px;opacity:0.6;transition:opacity 0.2s}.loc-edit-card .remove-loc-btn:hover{opacity:1;background:rgba(220,38,38,0.1)}.loc-edit-card .form-row{display:grid;grid-template-columns:1fr 1fr;gap:0.5rem}.loc-edit-card input,.loc-edit-card select{padding:0.625rem;font-size:0.85rem;border:1.5px solid #d1e7dd;border-radius:6px}.loc-edit-card input:focus{border-color:#0a4d3c;outline:none}.loc-edit-card label{font-size:0.65rem;margin-bottom:0.125rem;color:#555}.loc-edit-card .loc-field{margin-bottom:0.5rem}.loc-edit-card .loc-advanced-toggle{background:none;border:none;color:#0a4d3c;font-size:0.75rem;cursor:pointer;padding:0.25rem 0;text-decoration:underline;margin-top:0.25rem}.loc-edit-card .loc-advanced{display:none}.loc-edit-card .loc-advanced.show{display:block}.routing-row{padding:0.625rem 0.75rem;border-radius:8px;margin-bottom:0.375rem;font-size:0.8rem;display:flex;align-items:flex-start;gap:0.5rem;cursor:pointer;transition:background 0.15s}.routing-row:hover{filter:brightness(0.97)}.routing-row.new-row{background:#fef3c7;border-left:3px solid #f59e0b}.routing-row.exported-row{background:#f3f4f6;border-left:3px solid #9ca3af}.routing-row.no-phys-row{background:#fce7f3;border-left:3px solid #ec4899}.routing-row input[type="checkbox"]{margin-top:0.15rem;flex-shrink:0;accent-color:#f59e0b;width:16px;height:16px}.routing-row-content{flex:1;min-width:0}.routing-row-name{font-weight:600;color:#0a4d3c}.routing-row-detail{color:#666;font-size:0.75rem;margin-top:0.125rem}.routing-row-badge{font-size:0.6rem;padding:0.125rem 0.4rem;border-radius:3px;font-weight:600;white-space:nowrap;flex-shrink:0}.routing-row-badge.new{background:#f59e0b;color:white}.routing-row-badge.exported{background:#d1d5db;color:#4b5563}
</style>
</head>
<body>
<div id="sidebarOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:45;" onclick="closeSidebar()"></div>
<div id="connectionStatus" class="connection-status hidden">Connecting...</div>
<div id="toastContainer" class="toast-container"></div>
<div class="app">
<div class="mobile-header">
<button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
<h1>Territory CRM <span id="mobileSyncIndicator" class="sync-indicator synced"></span></h1>
<button class="add-header-btn" onclick="openPhysicianModal()">+</button>
</div>
<aside class="sidebar" id="sidebar">
<div class="sidebar-header">
<h1>Territory CRM <span id="desktopSyncIndicator" class="sync-indicator synced"></span></h1>
<div class="subtitle">Miami Wound Care</div>
<div class="count" id="physicianCount">Loading...</div>
<button class="admin-btn" onclick="setView('map')" style="background:#0ea5e9;border-color:#0ea5e9;">üó∫Ô∏è Map</button>
<button class="admin-btn" onclick="toggleAdminPanel()">Admin Settings</button>
<div class="admin-panel" id="adminPanel">
<h4>Database Management</h4>
<p style="color:#aaa;font-size:0.8rem;margin-bottom:0.75rem;">Add new records to the existing database, or manage all data.</p>
<label style="display:block;margin-bottom:0.5rem;padding:0.75rem;background:#10b981;color:white;border-radius:8px;font-weight:600;text-align:center;cursor:pointer;font-size:0.95rem;">
Append New Records from CSV <input type="file" accept=".csv" onchange="importCSV(this.files[0])" style="display:none">
</label>
<div style="font-size:0.7rem;color:#888;margin-bottom:0.75rem;text-align:center;">Adds new physicians without affecting existing data</div>
<div id="importStatus" style="font-size:0.8rem;margin-bottom:0.5rem;color:#ccc;"></div>
<h4 style="margin-top:1rem;color:#f97316;">Advanced Solution Import</h4>
<p style="color:#aaa;font-size:0.8rem;margin-bottom:0.75rem;">Upload CSV with "First Last" and "AS?" columns to bulk-set AS designations.</p>
<label style="display:block;margin-bottom:0.5rem;padding:0.75rem;background:#f97316;color:white;border-radius:8px;font-weight:600;text-align:center;cursor:pointer;font-size:0.95rem;">
Import AS List <input type="file" accept=".csv" onchange="importASList(this.files[0])" style="display:none">
</label>
<div id="asImportStatus" style="font-size:0.8rem;margin-bottom:0.5rem;color:#ccc;"></div>
<h4 style="margin-top:1rem;color:#0ea5e9;">Data Export</h4>
<p style="color:#aaa;font-size:0.8rem;margin-bottom:0.75rem;">Download your CRM data as CSV files.</p>
<button style="background:#0ea5e9;color:white;border:none;padding:0.6rem 1rem;border-radius:6px;font-size:0.85rem;cursor:pointer;width:100%;font-weight:600;" onclick="openExportModal()">Export Data</button>
<h4 style="margin-top:1rem;color:#f97316;">Analytics</h4>
<button style="background:#f97316;color:white;border:none;padding:0.6rem 1rem;border-radius:6px;font-size:0.85rem;cursor:pointer;width:100%;font-weight:600;" onclick="setView('dashboard')">Territory Dashboard</button>
<button class="btn-danger" onclick="clearDatabase()" style="margin-top:1rem;">Clear All Data</button>
</div>
</div>
<div class="view-tabs">
<button class="view-tab active" onclick="setView('physicians')" id="tabPhysicians">Physicians</button>
<button class="view-tab" onclick="setView('practices')" id="tabPractices">Practices</button>
<button class="view-tab" onclick="setView('activity')" id="tabActivity">Activity</button>
<button class="view-tab" onclick="setView('map')" id="tabMap" style="display:none;"></button>
<button class="view-tab" onclick="setView('dashboard')" id="tabDashboard" style="display:none;"></button>
</div>
<div class="search-box">
<div class="search-wrapper">
<input type="text" class="search-input" id="searchInput" placeholder="Search physicians..." oninput="filterList()">
<button class="search-clear" id="searchClear" onclick="clearSearch()" style="display:none">&times;</button>
</div>
</div>
<div class="sort-controls" id="sortControls">
<button class="sort-btn active" onclick="setSortBy('name')" id="sortName">Name</button>
<button class="sort-btn" onclick="setSortBy('city')" id="sortCity">City</button>
<button class="sort-btn" onclick="setSortBy('zip')" id="sortZip">ZIP</button>
<button class="sort-btn" onclick="setSortBy('tier')" id="sortTier">Tier</button>
</div>
<ul class="physician-list" id="physicianList">
<li class="loading">Loading physicians...</li>
</ul>
<button class="add-physician-btn" id="addBtn" onclick="openPhysicianModal()">+ New Physician</button>
</aside>
<main class="main-content" id="mainContent">
<div class="empty-state">
<h2>Welcome to Territory CRM</h2>
<p>Select a physician from the list to view their profile</p>
<div id="importStatusMain" style="font-size:0.85rem;margin-top:0.5rem;color:#666;"></div>
</div>
</main>
</div>
<div class="modal" id="physicianModal">
<div class="modal-content">
<div class="modal-header">
<h2 id="modalTitle">Add Physician</h2>
<button class="close-btn" onclick="closePhysicianModal()">&times;</button>
</div>
<div class="modal-body">
<form id="physicianForm" onsubmit="savePhysician(event)">
<div class="form-grid">
<div class="selector-section" id="practiceSelector">
<h4>Select or Create Practice</h4>
<input type="text" id="practiceSearchInput" placeholder="Search practices..." oninput="filterPracticeOptions()" style="width:100%;padding:0.5rem;border:1px solid #bae6fd;border-radius:6px;margin-bottom:0.5rem;font-size:0.85rem;">
<div class="selector-options" id="practiceOptions">
</div>
<button type="button" class="btn-secondary" onclick="toggleNewPractice()">+ New Practice</button>
<div id="newPracticeFields" style="display: none; margin-top: 1rem;">
<label>New Practice Name</label>
<input type="text" id="newPracticeName" placeholder="e.g., Miami Dermatology Associates">
</div>
</div>
<div class="selector-section" id="locationSelector" style="display: none;">
<h4>Assign to Locations</h4>
<div class="selector-options" id="locationOptions">
</div>
<button type="button" class="btn-secondary" onclick="toggleNewLocation()">+ New Location</button>
</div>
<div class="form-row">
<div>
<label>First Name *</label>
<input type="text" id="firstName" required>
</div>
<div>
<label>Last Name *</label>
<input type="text" id="lastName" required>
</div>
</div>
<div class="form-row">
<div>
<label>Degree</label>
<select id="degree">
<option value="">-- Select --</option>
<option value="MD">MD</option>
<option value="DO">DO</option>
<option value="DPM">DPM</option>
<option value="PA-C">PA-C</option>
<option value="NP">NP</option>
<option value="RN">RN</option>
<option value="PhD">PhD</option>
<option value="Other">Other</option>
</select>
</div>
<div>
<label>Title (non-physician staff)</label>
<input type="text" id="staffTitle" placeholder="e.g. Office Manager">
</div>
</div>
<div>
<label>Email</label>
<input type="email" id="physicianEmail">
</div>
<div class="form-row">
<div>
<label>Priority Tier (Quintile)</label>
<select id="priority">
<option value="">-- Select Tier --</option>
<option value="1">1 - Highest Priority</option>
<option value="2">2 - High Priority</option>
<option value="3">3 - Medium Priority</option>
<option value="4">4 - Lower Priority</option>
<option value="5">5 - Lowest Priority</option>
</select>
</div>
<div>
<label>Specialty</label>
<select id="specialty">
<option value="">-- Select Specialty --</option>
<option value="Dermatology">Dermatology</option>
<option value="Podiatry">Podiatry</option>
<option value="Wound Healing">Wound Healing</option>
<option value="Plastic & Reconstructive Surgery">Plastic & Reconstructive Surgery</option>
<option value="General Surgery">General Surgery</option>
<option value="Other">Other</option>
</select>
</div>
</div>
<div>
<label>Academic Connection</label>
<input type="text" id="umConnection" placeholder="e.g., UM, Barry University">
</div>
<div>
<label>Candidate Patient Volume</label>
<input type="text" id="patientVolume">
</div>
<div>
<label>General Notes</label>
<textarea id="physicianGeneralNotes" rows="3"></textarea>
</div>
</div>
<button type="submit" class="btn-primary" id="physicianSaveBtn" style="margin-top: 1.5rem;">Save Physician</button>
</form>
</div>
</div>
</div>
<div class="modal" id="locationModal">
<div class="modal-content">
<div class="modal-header">
<h2 id="locationModalTitle">Add Location</h2>
<button class="close-btn" onclick="closeLocationModal()">&times;</button>
</div>
<div class="modal-body">
<form id="locationForm" onsubmit="saveLocation(event)">
<div class="form-grid">
<div class="selector-section" id="locationPracticeSelector">
<h4>Practice for this Location</h4>
<select id="locationPracticeId" required style="width: 100%;">
<option value="">-- Select Practice --</option>
</select>
<div id="locationPracticeEditRow" style="display:none;margin-top:0.5rem;">
<label style="font-size:0.7rem;color:#0369a1;">Practice Name (editable)</label>
<div style="display:flex;gap:0.5rem;align-items:center;">
<input type="text" id="locationPracticeNameEdit" style="flex:1;" placeholder="Edit practice name...">
<button type="button" class="edit-btn" onclick="saveInlinePracticeName()" style="font-size:0.75rem;white-space:nowrap;padding:0.625rem 0.75rem;">Rename</button>
</div>
</div>
</div>
<div class="form-row">
<div>
<label>Location Label</label>
<input type="text" id="locationLabel" placeholder="e.g., Main Office, Key Biscayne">
</div>
<div>
<label>Primary Location?</label>
<select id="locationIsPrimary">
<option value="false">No</option>
<option value="true">Yes - Main Office</option>
</select>
</div>
</div>
<div>
<label>Street Address</label>
<input type="text" id="locationAddress">
</div>
<div class="form-row">
<div>
<label>City</label>
<input type="text" id="locationCity">
</div>
<div>
<label>ZIP</label>
<input type="text" id="locationZip">
</div>
</div>
<div class="form-row">
<div>
<label>Phone</label>
<input type="tel" id="locationPhone">
</div>
<div>
<label>Fax</label>
<input type="tel" id="locationFax">
</div>
</div>
<div>
<label>Office Email</label>
<input type="email" id="locationEmail">
</div>
<div>
<label>Office Hours</label>
<input type="text" id="locationHours" placeholder="e.g., Mon-Fri 9AM-5PM">
</div>
<div>
<label>Office Staff Names</label>
<input type="text" id="locationStaff">
</div>
<div class="form-row">
<div>
<label>Main Receptionist</label>
<input type="text" id="locationReceptionist">
</div>
<div>
<label>Best Days to Visit</label>
<input type="text" id="locationBestDays">
</div>
</div>
</div>
<button type="submit" class="btn-primary" id="locationSaveBtn" style="margin-top: 1.5rem;">Save Location</button>
</form>
</div>
</div>
</div>
<div class="modal" id="practiceModal">
<div class="modal-content">
<div class="modal-header">
<h2 id="practiceModalTitle">Add Practice</h2>
<button class="close-btn" onclick="closePracticeModal()">&times;</button>
</div>
<div class="modal-body">
<form id="practiceForm" onsubmit="savePractice(event)">
<div class="form-grid">
<div>
<label>Practice Name *</label>
<input type="text" id="practiceName" required>
</div>
<div>
<label>Website</label>
<input type="url" id="practiceWebsite" placeholder="https://...">
</div>
<div>
<label>Email</label>
<input type="email" id="practiceEmail" placeholder="info@practice.com">
</div>
<div>
<label>General Notes</label>
<textarea id="practiceNotes" rows="3"></textarea>
</div>
<div id="practiceAddressSection">
<div style="border-top:1px solid #e5e5e5;margin-top:0.5rem;padding-top:0.75rem;">
<label style="color:#0a4d3c;font-size:0.85rem;margin-bottom:0.5rem;">Primary Location (optional)</label>
</div>
<div>
<label>Address</label>
<input type="text" id="practiceAddress" placeholder="123 Main St">
</div>
<div class="form-row">
<div><label>City</label><input type="text" id="practiceCity"></div>
<div><label>ZIP</label><input type="text" id="practiceZip"></div>
</div>
<div class="form-row">
<div><label>Phone</label><input type="tel" id="practicePhone"></div>
<div><label>Fax</label><input type="tel" id="practiceFax"></div>
</div>
</div>
<div id="practiceLocationsEditSection" style="display:none;">
<div style="border-top:1px solid #e5e5e5;margin-top:0.5rem;padding-top:0.75rem;">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">
<label style="color:#0a4d3c;font-size:0.85rem;font-weight:600;">Locations</label>
<button type="button" class="edit-btn" onclick="addNewLocationCard()" style="font-size:0.75rem;">+ Add Location</button>
</div>
</div>
<div id="practiceLocationsCards"></div>
</div>
</div>
<button type="submit" class="btn-primary" id="practiceSaveBtn" style="margin-top: 1.5rem;">Save Practice</button>
</form>
</div>
</div>
</div>
<div class="modal" id="contactModal">
<div class="modal-content">
<div class="modal-header">
<h2 id="contactModalTitle">Add Contact Note</h2>
<button class="close-btn" onclick="closeContactModal()">&times;</button>
</div>
<div class="modal-body">
<form id="contactForm" onsubmit="saveContact(event)">
<div class="form-grid">
<div class="form-row">
<div>
<label>Your Name *</label>
<input type="text" id="authorName" value="Tom" required>
</div>
<div>
<label>Date *</label>
<input type="date" id="contactDate" required>
</div>
<div>
<label>Time</label>
<input type="time" id="contactTime">
</div>
</div>
<div id="locationSelectRow">
<label>Location</label>
<select id="contactLocation">
<option value="">Select location...</option>
</select>
</div>
<div id="alsoAttendedRow" style="display:none;">
<label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;text-transform:none;letter-spacing:0;font-size:0.9rem;color:#0a4d3c;" onclick="var el=$('alsoAttendedList');el.style.display=el.style.display==='none'?'block':'none';">
Also Present (log for multiple physicians) <span style="font-size:0.7rem;opacity:0.7;">tap to expand</span>
</label>
<div id="alsoAttendedList" style="display:none;max-height:150px;overflow-y:auto;border:1px solid #e5e5e5;border-radius:8px;padding:0.5rem;margin-top:0.25rem;"></div>
</div>
<div>
<label>Notes *</label>
<div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;">
<button type="button" onclick="prefixNote('Call: ')" style="padding:0.4rem 1rem;background:#0a4d3c;color:white;border:none;border-radius:6px;font-weight:600;font-size:0.85rem;cursor:pointer;">üìû Call</button>
<button type="button" onclick="prefixNote('Visit: ')" style="padding:0.4rem 1rem;background:#f97316;color:white;border:none;border-radius:6px;font-weight:600;font-size:0.85rem;cursor:pointer;">üè• Visit</button>
</div>
<textarea id="contactNotes" placeholder="What happened during this call/visit?" required rows="6"></textarea>
</div>
<div id="reminderRow" style="padding:0.75rem;background:#fffbeb;border:1px solid #fcd34d;border-radius:8px;">
<label style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;cursor:pointer;text-transform:none;letter-spacing:0;font-size:0.9rem;color:#92400e;">
<input type="checkbox" id="setReminder" onchange="$('reminderDays').style.display=this.checked?'flex':'none';if(this.checked)updateReminderPreview();" style="width:18px;height:18px;accent-color:#f59e0b;">
Set Follow-Up Reminder
</label>
<div id="reminderDays" style="display:none;align-items:center;gap:0.5rem;">
<select id="reminderDaysSelect" onchange="updateReminderPreview()" style="padding:0.5rem;font-size:0.85rem;border:1px solid #fcd34d;border-radius:6px;">
<option value="1">1 day</option>
<option value="2">2 days</option>
<option value="3">3 days</option>
<option value="5">5 days</option>
<option value="7" selected>1 week</option>
<option value="14">2 weeks</option>
<option value="30">1 month</option>
</select>
<span style="font-size:0.8rem;color:#92400e;" id="reminderDatePreview"></span>
</div>
</div>
</div>
<button type="submit" class="btn-primary" id="contactSaveBtn" style="margin-top: 1rem;">Save Note</button>
</form>
</div>
</div>
</div>
<div class="modal" id="assignLocationModal">
<div class="modal-content">
<div class="modal-header">
<h2>Assign to Location</h2>
<button class="close-btn" onclick="closeAssignLocationModal()">&times;</button>
</div>
<div class="modal-body">
<div id="quickAddPracticeSection" style="margin-bottom:1rem;padding:1rem;background:#f0fdf4;border:1px solid #86efac;border-radius:8px;">
<h4 style="color:#0a4d3c;margin-bottom:0.75rem;font-size:0.9rem;">Quick Add New Practice + Location</h4>
<div style="margin-bottom:0.5rem;"><input type="text" id="quickPracticeName" placeholder="Practice Name" style="padding:0.5rem;font-size:0.85rem;"></div>
<div class="form-row" style="margin-bottom:0.5rem;">
<div><input type="text" id="quickPracticeAddr" placeholder="Address" style="padding:0.5rem;font-size:0.85rem;"></div>
<div><input type="text" id="quickPracticeCity" placeholder="City" style="padding:0.5rem;font-size:0.85rem;"></div>
</div>
<div class="form-row" style="margin-bottom:0.5rem;">
<div><input type="text" id="quickPracticeZip" placeholder="ZIP" style="padding:0.5rem;font-size:0.85rem;"></div>
<div><input type="tel" id="quickPracticePhone" placeholder="Phone" style="padding:0.5rem;font-size:0.85rem;"></div>
</div>
<button type="button" class="btn-secondary" style="background:#0a4d3c;color:white;width:100%;" onclick="quickAddPracticeAndAssign()">Create & Assign</button>
</div>
<p style="margin-bottom: 0.5rem; color: #666;">Or select existing locations:</p>
<input type="text" id="assignLocationSearch" placeholder="Search practices or locations..." oninput="filterAssignLocationOptions()" style="width:100%;padding:0.5rem;border:1px solid #e5e5e5;border-radius:6px;margin-bottom:0.5rem;font-size:0.85rem;">
<div class="selector-options" id="assignLocationOptions" style="max-height: 300px;">
</div>
<button type="button" class="btn-primary" style="margin-top: 1rem;" onclick="saveLocationAssignments()">Save Assignments</button>
</div>
</div>
</div>
<div class="modal" id="assignPhysicianModal">
<div class="modal-content">
<div class="modal-header">
<h2>Assign Physician to Location</h2>
<button class="close-btn" onclick="closeAssignPhysicianModal()">&times;</button>
</div>
<div class="modal-body">
<p style="margin-bottom: 0.5rem; color: #666;">Select a location at this practice:</p>
<select id="assignPhysLocationSelect" style="width:100%;margin-bottom:1rem;padding:0.5rem;border:1px solid #e5e5e5;border-radius:6px;font-size:0.9rem;"></select>
<div id="quickAddPhysSection" style="margin-bottom:1rem;padding:1rem;background:#f0fdf4;border:1px solid #86efac;border-radius:8px;">
<h4 style="color:#0a4d3c;margin-bottom:0.75rem;font-size:0.9rem;">Quick Add New Physician</h4>
<div class="form-row" style="margin-bottom:0.5rem;">
<div><input type="text" id="quickPhysFirst" placeholder="First Name" style="padding:0.5rem;font-size:0.85rem;"></div>
<div><input type="text" id="quickPhysLast" placeholder="Last Name" style="padding:0.5rem;font-size:0.85rem;"></div>
</div>
<div class="form-row" style="margin-bottom:0.5rem;">
<div>
<select id="quickPhysDegree" style="padding:0.5rem;font-size:0.85rem;">
<option value="">Degree</option>
<option value="MD">MD</option>
<option value="DO">DO</option>
<option value="DPM">DPM</option>
<option value="PA-C">PA-C</option>
<option value="NP">NP</option>
<option value="RN">RN</option>
<option value="PhD">PhD</option>
<option value="Other">Other</option>
</select>
</div>
<div>
<select id="quickPhysSpecialty" style="padding:0.5rem;font-size:0.85rem;">
<option value="">Specialty</option>
<option value="Dermatology">Dermatology</option>
<option value="Podiatry">Podiatry</option>
<option value="Wound Healing">Wound Healing</option>
<option value="Plastic & Reconstructive Surgery">Plastic & Reconstructive Surgery</option>
<option value="General Surgery">General Surgery</option>
<option value="Other">Other</option>
</select>
</div>
</div>
<div class="form-row" style="margin-bottom:0.5rem;">
<div>
<select id="quickPhysPriority" style="padding:0.5rem;font-size:0.85rem;">
<option value="">Priority</option>
<option value="1">Tier 1</option>
<option value="2">Tier 2</option>
<option value="3">Tier 3</option>
<option value="4">Tier 4</option>
<option value="5">Tier 5</option>
</select>
</div>
</div>
<button type="button" class="btn-secondary" style="background:#0a4d3c;color:white;width:100%;" onclick="quickAddPhysician()">Add & Assign Physician</button>
</div>
<p style="margin-bottom: 0.5rem; color: #666;">Or select existing physicians:</p>
<input type="text" id="assignPhysSearch" placeholder="Search physicians..." oninput="filterAssignPhysicianOptions()" style="width:100%;padding:0.5rem;border:1px solid #e5e5e5;border-radius:6px;margin-bottom:0.5rem;font-size:0.85rem;">
<div class="selector-options" id="assignPhysicianOptions" style="max-height: 300px;">
</div>
<button type="button" class="btn-primary" style="margin-top: 1rem;" onclick="savePhysicianToLocation()">Save Assignments</button>
</div>
</div>
</div>
<script>
const SUPABASE_URL = 'https://xhdjywibdjzbczfjmctp.supabase.co';
// Google Sheet: Field Routing (persistent reference, auto-republishes)
// View: https://docs.google.com/spreadsheets/d/1zcVCVIciyScC3IcclfuBy4T4ogdcNSBVlxn6ZmYeiG0/edit?gid=150527751
// CSV: https://docs.google.com/spreadsheets/d/e/2PACX-1vSgKpcd74ISyaPdczn444-3z14Cmy7hObV3h5zY73q0lswJxlPeWIgaSGntQ1HKQUduefWDAz07rAwd/pub?gid=150527751&single=true&output=csv
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhoZGp5d2liZGp6YmN6ZmptY3RwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NzE4MTYsImV4cCI6MjA4NTM0NzgxNn0.vHAfeYTVbu2Isu5AoFONvzrtJ2sS3YwF00QRe3LNrbU';
const { createClient } = window.supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const $=id=>document.getElementById(id);
async function withSave(btnId,label,fn){const btn=$(btnId);if(btn.classList.contains('saving'))return;btn.textContent='Saving...';btn.classList.add('saving');try{updateSyncIndicators('syncing');await fn();btn.textContent='Saved!';btn.classList.remove('saving');btn.classList.add('saved');updateSyncIndicators('synced');}catch(e){console.error('Save error:',e);showToast('Error: '+e.message,'error');btn.textContent=label;btn.classList.remove('saving');updateSyncIndicators('error');throw e;}}
async function dbDel(table,id,msg,after){if(!confirm(msg))return;try{updateSyncIndicators('syncing');const{error}=await db.from(table).delete().eq('id',id);if(error)throw error;await after();showToast('Deleted','success');updateSyncIndicators('synced');}catch(e){console.error('Delete error:',e);showToast('Error: '+e.message,'error');updateSyncIndicators('error');}}
function setFields(map){for(const[id,val]of Object.entries(map))$(id).value=val;}
let physicians = [];
let practices = [];
let practiceLocations = [];
let physicianAssignments = {};
let contactLogs = {};
let currentPhysician = null;
let currentPractice = null;
let currentView = 'physicians';  // 'physicians' or 'practices'
let sortBy = 'name';  // 'name', 'city', 'zip', 'tier'
let editMode = false;
let editingContactId = null;
let editingLocationId = null;
let editingPracticeId = null;
let selectedPracticeId = null;
let selectedLocationIds = [];
let cachedLatestActivity = {};
document.addEventListener('DOMContentLoaded', async () => {
setToday();
await loadAllData();
await runVolumeMigration();
setupRealtimeSubscription();
// Prevent background scroll when modals are open (iPad fix)
document.querySelectorAll('.modal').forEach(modal => {
modal.addEventListener('touchmove', function(e) {
const content = modal.querySelector('.modal-content');
if (content && content.contains(e.target)) return; // allow scroll inside modal content
e.preventDefault();
}, { passive: false });
});
});
function setToday() {
const today = new Date();
const yyyy = today.getFullYear();
const mm = String(today.getMonth() + 1).padStart(2, '0');
const dd = String(today.getDate()).padStart(2, '0');
const hh = String(today.getHours()).padStart(2, '0');
const min = String(today.getMinutes()).padStart(2, '0');
$('contactDate').value = `${yyyy}-${mm}-${dd}`;
$('contactTime').value = `${hh}:${min}`;
}
function showToast(message, type = 'info') {
const container = $('toastContainer');
const toast = document.createElement('div');
toast.className = `toast ${type}`;
toast.style.cssText = 'display:flex;align-items:center;justify-content:space-between;gap:0.5rem;';
const msg = document.createElement('span');
msg.textContent = message;
toast.appendChild(msg);
if (type === 'error') {
const closeBtn = document.createElement('button');
closeBtn.textContent = '\u00d7';
closeBtn.style.cssText = 'background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;padding:0 0.25rem;flex-shrink:0;';
closeBtn.onclick = () => toast.remove();
toast.appendChild(closeBtn);
}
container.appendChild(toast);
const duration = type === 'error' ? 10000 : 3000;
setTimeout(() => toast.remove(), duration);
}
function updateConnectionStatus(status) {
const el = $('connectionStatus');
el.className = `connection-status ${status}`;
el.textContent = status === 'connected' ? 'Connected - Real-time sync active' :
status === 'syncing' ? 'Syncing...' : 'Disconnected - Working offline';
el.classList.remove('hidden');
if (status === 'connected') {
setTimeout(() => el.classList.add('hidden'), 2000);
}
}
function updateSyncIndicators(status) {
const classes = { synced: 'synced', syncing: 'syncing', error: 'error' };
$('mobileSyncIndicator').className = `sync-indicator ${classes[status] || 'synced'}`;
$('desktopSyncIndicator').className = `sync-indicator ${classes[status] || 'synced'}`;
}
async function loadAllData() {
try {
updateSyncIndicators('syncing');
const { data: physData, error: physError } = await db
.from('physicians')
.select('*')
.order('last_name', { ascending: true });
if (physError) throw physError;
physicians = physData || [];
const { data: practData, error: practError } = await db
.from('practices')
.select('*')
.order('name', { ascending: true });
if (!practError) {
practices = practData || [];
}
const { data: locData, error: locError } = await db
.from('practice_locations')
.select('*, practices(name)')
.order('city', { ascending: true });
if (!locError) {
practiceLocations = locData || [];
}
const { data: assignData, error: assignError } = await db
.from('physician_location_assignments')
.select('*, practice_locations(*, practices(name))');
if (!assignError) {
physicianAssignments = {};
(assignData || []).forEach(a => {
if (!physicianAssignments[a.physician_id]) {
physicianAssignments[a.physician_id] = [];
}
physicianAssignments[a.physician_id].push(a);
});
}
territoryMapCache=null; // invalidate map cache on data reload
renderList();
updateSyncIndicators('synced');
updateConnectionStatus('connected');
} catch (error) {
console.error('Error loading data:', error);
updateSyncIndicators('error');
showToast('Error loading data: ' + error.message, 'error');
}
}
async function runVolumeMigration() {
if (localStorage.getItem('volumeMigration20260217')) return;
const volData = {
'Amy|DeGirolamo': 95, 'Mario Adrian|Cala': 84, 'Nathalie|Mendez': 84,
'Michelle|Detweiler': 90, 'Kimberly|Bullock': 74, 'James A.|Green': 76,
'Pritesh|Patel': 87, 'Pollyanna|Reeves': 76, 'Jignesh|Desai': 82,
'Ashley|Bowles': 88, 'Alan|MacGill': 95, 'Nathan D.|Vela': 92,
'Kyle|Kinmon': 90, 'Jacqueline M.|Brill': 85, 'Richard|Seda': 75,
'Jaime|Carbonell': 85, 'Bamidele|Olupona': 78, 'Julio C.|Ortiz': 80,
'Robert|Garnet': 80, 'Naila|Esmail': 72, 'Tamara D.|Fishman': 77,
'Jim|Fran√ßois': 75, 'Charlton|Adler': 72, 'Shanika L.|Hill': 93,
'Ashot|Oganesyan': 78, 'Juliette|Perez': 88, 'Katherine|Machado': 83,
'Alexandra M.|Andes': 96, 'Holly|Seigle': 86, 'Carlo A.|Messina': 75,
'Christina Pena|Garcia': 70, 'Neil H.|Strauss': 100, 'Daniel|Pero': 72,
'Tiffany|Cerda': 85, 'Frankie|Kirk': 80, 'Joshua P.|Daly': 85,
'Jean|Louis-Charles': 80, 'Xavier|Sanchez': 81, 'Aldo M.|Gonzalez': 81,
'Eric|Schorr': 75, 'Brett|Fried': 75, 'Stephanie|Garzon': 82,
'Robyn|Hall': 78, 'Jonathan M.|Cutler': 80, 'Vishnu|Seecharan': 78,
'Suzanne|Fuchs': 78
};
let updated = 0;
for (const p of physicians) {
const key = `${p.first_name}|${p.last_name}`;
if (volData[key] !== undefined && p.patient_volume != String(volData[key])) {
const { error } = await db.from('physicians').update({ patient_volume: String(volData[key]) }).eq('id', p.id);
if (!error) updated++;
else console.warn('Volume migration failed for', key, error);
}
}
if (updated > 0) {
await loadAllData();
showToast(`Volume data updated for ${updated} physician(s)`, 'info');
}
localStorage.setItem('volumeMigration20260217', 'done');
console.log(`Volume migration complete: ${updated} updated`);
}
async function loadContactLogs(physicianId) {
try {
const { data, error } = await db
.from('contact_logs')
.select('*')
.eq('physician_id', physicianId)
.order('contact_date', { ascending: false });
if (error) throw error;
contactLogs[physicianId] = data || [];
} catch (error) {
console.error('Error loading contact logs:', error);
}
}
function setupRealtimeSubscription() {
['physicians','practices','practice_locations','physician_location_assignments'].forEach(t =>
db.channel(t+'-ch').on('postgres_changes',{event:'*',schema:'public',table:t},()=>loadAllData()).subscribe());
db.channel('contact-logs-ch')
.on('postgres_changes',{event:'*',schema:'public',table:'contact_logs'},(payload)=>{
const pid=payload.new?.physician_id||payload.old?.physician_id;
if(currentPhysician&&pid===currentPhysician.id) loadContactLogs(currentPhysician.id).then(()=>renderProfile());
}).subscribe();
}
function calcBusinessDate(days) {
const d = new Date();
let added = 0;
while (added < days) {
d.setDate(d.getDate() + 1);
if (d.getDay() !== 0 && d.getDay() !== 6) added++;
}
return d.toISOString().split('T')[0];
}
function updateReminderPreview() {
const days = parseInt($('reminderDaysSelect')?.value || 7);
const dt = calcBusinessDate(days);
const d = new Date(dt + 'T12:00:00');
const opts = {weekday:'short', month:'short', day:'numeric'};
const el = $('reminderDatePreview');
if (el) el.textContent = d.toLocaleDateString('en-US', opts);
}
function getUpcomingBusinessDays(count) {
const result = [];
const d = new Date();
const today = d.toISOString().split('T')[0];
let cursor = new Date(d);
// If today is a weekday, include it
if (cursor.getDay() !== 0 && cursor.getDay() !== 6) {
result.push({date: today, label: d.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'})});
}
while (result.length < count) {
cursor.setDate(cursor.getDate() + 1);
if (cursor.getDay() === 0 || cursor.getDay() === 6) continue;
const iso = cursor.toISOString().split('T')[0];
const label = cursor.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'});
result.push({date: iso, label});
}
return result;
}
function setView(view) {
currentView = view;
$('tabPhysicians').classList.toggle('active', view === 'physicians');
$('tabPractices').classList.toggle('active', view === 'practices');
$('tabActivity').classList.toggle('active', view === 'activity');
$('tabMap').classList.toggle('active', view === 'map');
if(view==='activity'){
$('searchInput').placeholder='Search activity...';
$('addBtn').style.display='none';
$('sortControls').style.display='none';
$('physicianList').innerHTML='<li class="loading">Loading activity...</li>';
currentPhysician=null;currentPractice=null;
renderActivityView();
return;
}
if(view==='map'){
$('searchInput').parentElement.parentElement.style.display='none';
$('addBtn').style.display='none';
$('sortControls').style.display='none';
$('physicianList').innerHTML='';
currentPhysician=null;currentPractice=null;
renderMapView();
return;
}
$('tabDashboard').classList.toggle('active', view === 'dashboard');
if(view==='dashboard'){
$('searchInput').parentElement.parentElement.style.display='none';
$('addBtn').style.display='none';
$('sortControls').style.display='none';
$('physicianList').innerHTML='';
currentPhysician=null;currentPractice=null;
renderDashboard();
return;
}
$('searchInput').parentElement.parentElement.style.display='';
$('addBtn').style.display='';
$('searchInput').placeholder = view === 'physicians' ? 'Search physicians...' : 'Search practices...';
$('addBtn').textContent = view === 'physicians' ? '+ New Physician' : '+ New Practice';
$('addBtn').onclick = view === 'physicians' ? openPhysicianModal : openPracticeModal;
$('sortControls').style.display = view === 'physicians' ? 'flex' : 'none';
currentPhysician = null;
currentPractice = null;
renderList();
renderEmptyState();
}
function setSortBy(sort) {
sortBy = sort;
document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
$('sort' + sort.charAt(0).toUpperCase() + sort.slice(1)).classList.add('active');
renderList();
}
function fmtName(p) {
const deg = p.degree || '';
const tl = p.title || '';
if (deg) return `${p.first_name} ${p.last_name}, ${deg}`;
if (tl) return `${p.first_name} ${p.last_name} (${tl})`;
return `${p.first_name} ${p.last_name}`;
}
function getSortedPhysicians(filtered) {
return [...filtered].sort((a, b) => {
if (sortBy === 'name') {
return a.last_name.localeCompare(b.last_name);
} else if (sortBy === 'city') {
const cityA = getPrimaryLoc(a.id).city || 'zzz';
const cityB = getPrimaryLoc(b.id).city || 'zzz';
return cityA.localeCompare(cityB);
} else if (sortBy === 'zip') {
const zipA = getPrimaryLoc(a.id).zip || 'zzz';
const zipB = getPrimaryLoc(b.id).zip || 'zzz';
return zipA.localeCompare(zipB);
} else if (sortBy === 'tier') {
const tierA = a.priority || 'zzz';
const tierB = b.priority || 'zzz';
return tierA.localeCompare(tierB);
}
return 0;
});
}
function ld(val,icon,content){return val?`<div class="location-detail"><span class="location-detail-icon">${icon}</span><span class="location-detail-value">${content||val}</span></div>`:''}
function locAddr(loc){const a=(loc.address||'')+', '+(loc.city||'')+' '+(loc.zip||'');return`<a href="https://maps.apple.com/?q=${encodeURIComponent(a)}" target="_blank" style="color:#0a4d3c;text-decoration:underline;">${loc.address}${loc.city?', '+loc.city:''}${loc.zip?' '+loc.zip:''}</a>`}
function locPhone(p){return`<a href="tel:${(p||'').replace(/\D/g,'')}">${p}</a>`}
function locDetails(loc){return ld(loc.address,'üìç',locAddr(loc))+ld(loc.phone,'üìû',locPhone(loc.phone))+ld(loc.fax,'üì†')+ld(loc.practice_email,'‚úâÔ∏è',loc.practice_email?`<a href="mailto:${loc.practice_email}">${loc.practice_email}</a>`:'')+ld(loc.office_hours,'üïê')+ld(loc.office_staff,'üë•')+ld(loc.receptionist_name,'üë§')+ld(loc.best_days,'üìÖ')}
function mi(label,val){return `<div class="meta-item"><div class="meta-label">${label}</div><div class="meta-value">${val}</div></div>`}
function parseNoteTime(notes){const tm=(notes||'').match(/^\[(\d{1,2}:\d{2}(?:\s*[APap][Mm])?)\]\s*/);return tm?{time:' '+tm[1],text:notes.replace(tm[0],'')}:{time:'',text:notes||''};}
function renderLogEntry(e,opts={}){const{time,text}=parseNoteTime(e.notes);const preview=opts.full?text:(text.length>120?text.substring(0,120)+'...':text);
const physLine=opts.physName?`<span style="font-weight:600;color:#0a4d3c;display:block;margin-top:0.25rem;">${opts.physName}</span>`:'';
const locLine=e.practice_location_id?'<span class="contact-entry-location">'+getLocationLabel(e.practice_location_id)+'</span>':'';
const tsLine=opts.showTimestamp?`<span class="contact-entry-timestamp">${formatTimestamp(e.created_at)}</span>`:'';
const reminderLine=e.reminder_date?`<span style="font-size:0.7rem;padding:0.15rem 0.5rem;background:#fef3c7;color:#92400e;border-radius:4px;margin-left:0.5rem;">Reminder: ${e.reminder_date}</span>`:'';
const actions=opts.editable?`<div class="contact-entry-actions"><button class="icon-btn" onclick="editNote('${e.id}')" title="Edit">‚úèÔ∏è</button><button class="icon-btn" onclick="deleteNote('${e.id}')" title="Delete">üóëÔ∏è</button></div>`:'';
const click=opts.onClick?` style="cursor:pointer" onclick="${opts.onClick}"`:'';
return `<div class="contact-entry"${click}><div class="contact-entry-header"><div><span class="contact-entry-date">${e.contact_date}${time}${e.author?' - '+e.author:''}</span>${physLine}${locLine}${tsLine}${reminderLine}</div>${actions}</div><div class="contact-entry-notes">${preview}</div></div>`;}
function ci(icon,label,val){return val?`<div class="contact-item"><div class="contact-icon">${icon}</div><div class="contact-item-content"><div class="contact-item-label">${label}</div><div class="contact-item-value">${val}</div></div></div>`:''}
function getPracticeName(practiceId){const p=practices.find(pr=>pr.id===practiceId);return p?p.name:'';}
function getPrimaryLoc(physicianId) {
const a = physicianAssignments[physicianId] || [];
const assign = a.find(x => x.is_primary) || a[0];
if (!assign) return {};
return assign.practice_locations || practiceLocations.find(l => l.id === assign.practice_location_id) || {};
}
function toggleSidebar() {
const isOpen = $('sidebar').classList.toggle('open');
$('sidebarOverlay').style.display = isOpen ? 'block' : 'none';
}
function closeSidebar() {
$('sidebar').classList.remove('open');
$('sidebarOverlay').style.display = 'none';
}
function updateCount() {
const search = $('searchInput').value.toLowerCase();
if (currentView === 'physicians') {
const filtered = getFilteredPhysicians(search);
$('physicianCount').textContent =
`${filtered.length} of ${physicians.length} physician${physicians.length !== 1 ? 's' : ''}`;
} else {
const filtered = getFilteredPractices(search);
$('physicianCount').textContent =
`${filtered.length} of ${practices.length} practice${practices.length !== 1 ? 's' : ''}`;
}
}
function getFilteredPhysicians(search) {
if (!search) return physicians;
return physicians.filter(p => {
if ([p.first_name,p.last_name,p.specialty,p.email,p.general_notes,p.priority,p.academic_connection||p.um_connection,p.patient_volume,p.mohs_volume,p.practice_name].some(v=>(v||'').toLowerCase().includes(search))) return true;
const logs=contactLogs[p.id]||[];
if(logs.some(l=>(l.notes||'').toLowerCase().includes(search)||(l.author||'').toLowerCase().includes(search))) return true;
const assigns=physicianAssignments[p.id]||[];
return assigns.some(a=>{const loc=a.practice_locations||{};const pName=loc.practices?.name||'';
return[pName,loc.city,loc.zip,loc.address,loc.phone,loc.fax,loc.practice_email,loc.office_hours,loc.office_staff,loc.receptionist_name,loc.best_days,loc.label].some(v=>(v||'').toLowerCase().includes(search));});
});
}
function getFilteredPractices(search) {
if (!search) return practices;
return practices.filter(p => {
if([p.name,p.website,p.general_notes].some(v=>(v||'').toLowerCase().includes(search))) return true;
const phys=physicians.filter(ph=>(physicianAssignments[ph.id]||[]).some(a=>a.practice_locations?.practice_id===p.id));
if(phys.some(ph=>(ph.first_name+' '+ph.last_name).toLowerCase().includes(search))) return true;
const locs=practiceLocations.filter(l=>l.practice_id===p.id);
return locs.some(l=>[l.address,l.city,l.zip,l.phone,l.fax,l.practice_email,l.office_hours,l.office_staff,l.receptionist_name,l.best_days,l.label].some(v=>(v||'').toLowerCase().includes(search)));
});
}
function filterList() {
const val = $('searchInput').value;
$('searchClear').style.display = val ? 'flex' : 'none';
renderList();
}
function clearSearch() {
$('searchInput').value = '';
$('searchClear').style.display = 'none';
renderList();
$('searchInput').focus();
}
function renderList() {
const list = $('physicianList');
const search = $('searchInput').value.toLowerCase();
if (currentView === 'physicians') {
renderPhysicianList(list, search);
} else {
renderPracticeList(list, search);
}
updateCount();
}
function renderPhysicianList(list, search) {
const filtered = getFilteredPhysicians(search);
const sorted = getSortedPhysicians(filtered);
if (sorted.length === 0) {
list.innerHTML = '<li class="loading">No physicians found</li>';
return;
}
list.innerHTML = sorted.map(p => {
const assignments = physicianAssignments[p.id] || [];
const primaryAssign = assignments.find(a => a.is_primary) || assignments[0];
const pLoc = primaryAssign?.practice_locations || (primaryAssign ? practiceLocations.find(l => l.id === primaryAssign.practice_location_id) : null) || {};
const cityDisplay = pLoc.city || '';
const practiceName = pLoc.practices?.name || getPracticeName(pLoc.practice_id) || p.practice_name || '';
const locationCount = assignments.length;
return `
<li class="physician-item ${currentPhysician?.id === p.id ? 'active' : ''}"
onclick="viewPhysician('${p.id}')">
<div class="name">${fmtName(p)}</div>
<div class="practice">${practiceName}</div>
<div class="tier">${p.priority || 'No tier'}</div>
${cityDisplay ? `<span class="city-badge">${cityDisplay}</span>` : ''}
${locationCount > 1 ? `<span class="city-badge">+${locationCount - 1} more</span>` : ''}
</li>
`}).join('');
}
function renderPracticeList(list, search) {
const filtered = getFilteredPractices(search);
if (filtered.length === 0) {
list.innerHTML = '<li class="loading">No practices found</li>';
return;
}
list.innerHTML = filtered.map(p => {
const locations = practiceLocations.filter(l => l.practice_id === p.id);
const cities = [...new Set(locations.map(l => l.city).filter(Boolean))];
return `
<li class="physician-item ${currentPractice?.id === p.id ? 'active' : ''}"
onclick="viewPractice('${p.id}')">
<div class="name">${p.name}</div>
<div class="practice">${locations.length} location${locations.length !== 1 ? 's' : ''}</div>
${cities.slice(0, 2).map(c => `<span class="city-badge">${c}</span>`).join('')}
${cities.length > 2 ? `<span class="city-badge">+${cities.length - 2} more</span>` : ''}
</li>
`}).join('');
}
async function renderEmptyState() {
$('mainContent').innerHTML = `
<div class="empty-state">
<h2>Welcome to Territory CRM</h2>
<p>Select a ${currentView === 'physicians' ? 'physician' : 'practice'} from the list to view details</p>
</div>
<div class="section" style="margin-top:1rem;">
<div class="section-header"><h3 style="color:#92400e;">Follow-Up Reminders</h3></div>
<div id="remindersContent"><div class="loading">Loading reminders...</div></div>
</div>
<div class="section">
<div class="section-header"><h3>Recent Activity</h3></div>
<div id="recentActivityContent"><div class="loading">Loading recent activity...</div></div>
</div>
<div class="section">
<div class="section-header"><h3>Quick Stats</h3></div>
<div class="profile-meta">
${mi('Physicians',physicians.length)}${mi('Practices',practices.length)}${mi('Locations',practiceLocations.length)}${mi('Cities',[...new Set(practiceLocations.map(l=>l.city).filter(Boolean))].length)}
</div>
</div>
`;
// Load reminders
try {
const bizDays = getUpcomingBusinessDays(3);
const startDate = bizDays[0].date;
const endDate = bizDays[bizDays.length - 1].date;
const {data:reminders,error:remErr} = await db.from('contact_logs').select('*').gte('reminder_date', startDate).lte('reminder_date', endDate).order('reminder_date',{ascending:true});
const rc = $('remindersContent');
if (remErr) { rc.innerHTML = '<div class="empty-notice">Could not load reminders</div>'; }
else if (!reminders || reminders.length === 0) {
rc.innerHTML = '<div class="empty-notice" style="color:#92400e;">No follow-ups scheduled for the next 3 business days.</div>';
} else {
let html = '';
bizDays.forEach(bd => {
const dayReminders = reminders.filter(r => r.reminder_date === bd.date);
if (dayReminders.length === 0) return;
html += `<div style="margin-bottom:0.75rem;"><div style="font-size:0.75rem;font-weight:700;color:#92400e;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:0.5rem;padding-bottom:0.25rem;border-bottom:2px solid #fcd34d;">${bd.label}</div>`;
dayReminders.forEach(r => {
const phys = physicians.find(p => p.id === r.physician_id);
const physName = phys ? fmtName(phys) : 'Unknown';
const tm = (r.notes||'').match(/^\[(\d{1,2}:\d{2}(?:\s*[APap][Mm])?)\]\s*/);
const displayNotes = tm ? r.notes.replace(tm[0], '') : (r.notes||'');
const preview = displayNotes.length > 100 ? displayNotes.substring(0,100) + '...' : displayNotes;
html += `<div class="contact-entry" style="cursor:pointer;border-left-color:#f59e0b;margin-bottom:0.5rem;" onclick="viewPhysician('${r.physician_id}')">
<div style="font-weight:600;color:#0a4d3c;font-size:0.9rem;">${physName}</div>
<div style="font-size:0.8rem;color:#666;margin-top:0.25rem;">${preview}</div>
<div style="font-size:0.7rem;color:#999;margin-top:0.25rem;">Note from ${r.contact_date}${r.author ? ' by ' + r.author : ''}</div>
</div>`;
});
html += '</div>';
});
rc.innerHTML = html || '<div class="empty-notice" style="color:#92400e;">No follow-ups scheduled for the next 3 business days.</div>';
}
} catch(e) {
const rc = $('remindersContent');
if (rc) rc.innerHTML = '<div class="empty-notice">Could not load reminders</div>';
}
// Load recent activity
try {
const {data:recentLogs,error} = await db.from('contact_logs').select('*').order('created_at',{ascending:false}).limit(15);
if (error) throw error;
const container = $('recentActivityContent');
if (!recentLogs || recentLogs.length === 0) {
container.innerHTML = '<div class="empty-notice">No contact notes yet. Start logging your visits and calls!</div>';
return;
}
container.innerHTML = '<div class="contact-entries">' + recentLogs.map(e => {
const phys = physicians.find(p => p.id === e.physician_id);
return renderLogEntry(e,{physName:phys?fmtName(phys):'Unknown',onClick:`viewPhysician('${e.physician_id}')`});
}).join('') + '</div>';
} catch(e) {
const container = $('recentActivityContent');
if (container) container.innerHTML = '<div class="empty-notice">Could not load recent activity</div>';
}
}
async function viewPhysician(id) {
currentPhysician = physicians.find(p => p.id === id);
currentPractice = null;
if (!currentPhysician) return;
await loadContactLogs(id);
renderList();
renderProfile();
if (window.innerWidth <= 768) {
closeSidebar();
}
}
async function viewPractice(id) {
currentPractice = practices.find(p => p.id === id);
currentPhysician = null;
if (!currentPractice) return;
renderList();
renderPracticeProfile();
if (window.innerWidth <= 768) {
closeSidebar();
}
}
function formatTimestamp(isoString) {
if (!isoString) return '';
const date = new Date(isoString);
const options = { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' };
return date.toLocaleDateString('en-US', options);
}
function getLocationLabel(locationId) {
const loc = practiceLocations.find(l => l.id === locationId);
if (!loc) return '';
return `${loc.address}, ${loc.city}`;
}
function renderProfile() {
const p = currentPhysician;
if (!p) return;
const logs = contactLogs[p.id] || [];
const assignments = physicianAssignments[p.id] || [];
const practiceIds = [...new Set(assignments.map(a => {
const loc = a.practice_locations || practiceLocations.find(l => l.id === a.practice_location_id);
return loc?.practice_id;
}).filter(Boolean))];
const associatedPractices = practices.filter(pr => practiceIds.includes(pr.id));
$('mainContent').innerHTML = `
<div class="profile-header">
<div class="profile-name">${fmtName(p)}</div>
<div class="profile-practice">
${associatedPractices.length > 0 ? associatedPractices.map(pr => `<span style="cursor:pointer;text-decoration:underline;color:#0a4d3c;" onclick="event.stopPropagation();editPracticeFromProfile('${pr.id}')">${pr.name}</span>`).join(' | ') + ` <button class="edit-btn" style="font-size:0.75rem;padding:0.25rem 0.5rem;margin-left:0.5rem;" onclick="editPracticeFromProfile('${associatedPractices[0].id}')">Edit Practice</button>` : 'No practice assigned'}
</div>
<div class="profile-meta">
${mi('Priority',p.priority||'Not set')}${mi('Specialty',p.specialty||'Not set')}${mi('Degree',p.degree||'‚Äî')}${p.title?mi('Title',p.title):''}
${mi('Academic Connection',p.academic_connection||p.um_connection||'None')}${mi('Candidate Patient Volume',p.patient_volume||p.mohs_volume||'Unknown')}
<div class="meta-item"><span class="meta-label">Advanced Solution</span><label style="display:inline-flex;align-items:center;gap:0.4rem;cursor:pointer;padding:0.25rem 0.6rem;border-radius:6px;background:${p.advanced_solution?'#f97316':'#e5e5e5'};color:${p.advanced_solution?'white':'#666'};font-size:0.8rem;font-weight:700;transition:all 0.2s;" onclick="toggleAdvancedSolution(event)"><input type="checkbox" ${p.advanced_solution?'checked':''} style="width:16px;height:16px;accent-color:#f97316;cursor:pointer;margin:0;" onchange="toggleAdvancedSolution(event)">${p.advanced_solution?'YES':'NO'}</label></div>
${mi('Last Contact',p.last_contact||'Never')}${mi('Locations',assignments.length+' location'+(assignments.length!==1?'s':''))}
</div>
</div>
<div class="section">
<div class="section-header">
<h3>Physician Profile</h3>
<div>
<button class="edit-btn" onclick="editPhysicianInfo()">Edit</button>
<button class="delete-btn" onclick="deletePhysician()">Delete</button>
</div>
</div>
<div class="contact-grid">
${ci('‚úâÔ∏è','Physician Email',p.email?`<a href="mailto:${p.email}">${p.email}</a>`:'')}
${ci('üìù','General Notes',p.general_notes)}
${!p.email&&!p.general_notes?'<div class="empty-notice">Click Edit to add email and notes</div>':''}
</div>
</div>
<div class="section">
<div class="section-header">
<h3>Practice Locations</h3>
<button class="edit-btn" onclick="openAssignLocationModal()">+ Assign Location</button>
</div>
${assignments.length === 0 ?
'<div class="empty-notice">No locations assigned. Click + Assign Location to add practice locations.</div>' :
'<div class="locations-grid">' +
assignments.map(assign => {
const loc = assign.practice_locations || practiceLocations.find(l => l.id === assign.practice_location_id);
if (!loc) return '';
const practiceName = loc.practices?.name || getPracticeName(loc.practice_id);
return `
<div class="location-card ${assign.is_primary ? 'primary' : ''}">
<div class="location-card-header">
<div class="location-label">
${loc.label || 'Office'}
${assign.is_primary ? '<span class="location-badge">Primary</span>' : ''}
${practiceName ? `<span class="practice-badge">${practiceName}</span>` : ''}
</div>
<div class="location-actions">
<button class="icon-btn" onclick="editLocationDetails('${loc.id}')" title="Edit">‚úèÔ∏è</button>
<button class="icon-btn" onclick="removeAssignment('${assign.id}')" title="Remove">üóëÔ∏è</button>
</div>
</div>
<div class="location-details">${locDetails(loc)}</div>
</div>
`}).join('') +
'</div>'
}
</div>
<div class="section">
<div class="section-header">
<h3>Activity Log</h3>
<button class="edit-btn" onclick="openContactModal()">+ Add Note</button>
</div>
${logs.length === 0 ?
'<div class="empty-notice">No contact history yet. Click + Add Note to record your first call or visit.</div>' :
'<div class="contact-entries">' + logs.map(e => renderLogEntry(e,{editable:true,showTimestamp:true,full:true})).join('') + '</div>'
}
</div>
`;
}
async function renderPracticeProfile() {
const p = currentPractice;
const locations = practiceLocations.filter(l => l.practice_id === p.id);
const practicePhysicians = physicians.filter(phys => {
const assigns = physicianAssignments[phys.id] || [];
return assigns.some(a => {
const loc = a.practice_locations || practiceLocations.find(l => l.id === a.practice_location_id);
return loc && loc.practice_id === p.id;
});
});
$('mainContent').innerHTML = `
<div class="profile-header">
<div class="profile-name">${p.name}</div>
<div class="profile-practice">${p.website ? `<a href="${p.website}" target="_blank">${p.website}</a>` : 'No website'}</div>
<div class="profile-meta">
${mi('Locations',locations.length)}${mi('Physicians',practicePhysicians.length)}${mi('Cities',[...new Set(locations.map(l=>l.city).filter(Boolean))].join(', ')||'N/A')}
</div>
</div>
<div class="section">
<div class="section-header">
<h3>Practice Details</h3>
<div>
<button class="edit-btn" onclick="editPractice()">Edit</button>
<button class="delete-btn" onclick="deletePractice()">Delete</button>
</div>
</div>
<div class="contact-grid">${(()=>{const pLocs=practiceLocations.filter(l=>l.practice_id===p.id);const pEmail=pLocs.map(l=>l.practice_email).find(Boolean)||'';return ci('‚úâÔ∏è','Email',pEmail?`<a href="mailto:${pEmail}">${pEmail}</a>`:'')+ci('üìù','Notes',p.general_notes)||((!pEmail&&!p.general_notes)?'<div class="empty-notice">No details for this practice</div>':'');})()}</div>
</div>
<div class="section">
<div class="section-header">
<h3>Locations</h3>
<button class="edit-btn" onclick="openLocationModal('${p.id}')">+ Add Location</button>
</div>
${locations.length === 0 ?
'<div class="empty-notice">No locations yet. Click + Add Location to add an address.</div>' :
'<div class="locations-grid">' +
locations.map(loc => `
<div class="location-card">
<div class="location-card-header">
<div class="location-label">${loc.label || 'Office'}</div>
<div class="location-actions">
<button class="icon-btn" onclick="editLocationDetails('${loc.id}')" title="Edit">‚úèÔ∏è</button>
<button class="icon-btn" onclick="deleteLocation('${loc.id}')" title="Delete">üóëÔ∏è</button>
</div>
</div>
<div class="location-details">${locDetails(loc)}</div>
</div>
`).join('') +
'</div>'
}
</div>
<div class="section">
<div class="section-header">
<h3>Activity Log</h3>
<button class="edit-btn" onclick="openPracticeContactModal()">+ Log Call</button>
</div>
<div id="practiceActivityContent"><div class="loading">Loading activity...</div></div>
</div>
<div class="section">
<div class="section-header">
<h3>Physicians at this Practice</h3>
<button class="edit-btn" onclick="openAssignPhysicianModal()">+ Assign Physician</button>
</div>
${practicePhysicians.length === 0 ?
'<div class="empty-notice">No physicians assigned to this practice yet.</div>' :
'<div class="contact-grid">' +
practicePhysicians.map(phys => `
<div class="contact-item" style="cursor: pointer;" onclick="setView('physicians');viewPhysician('${phys.id}')">
<div class="contact-icon">üë®‚Äç‚öïÔ∏è</div>
<div class="contact-item-content">
<div class="contact-item-label">${phys.priority || 'No tier'}</div>
<div class="contact-item-value">${fmtName(phys)}</div>
</div>
</div>
`).join('') +
'</div>'
}
</div>
`;
await loadPracticeActivity(p.id);
}
async function loadPracticeActivity(practiceId) {
const locIds = practiceLocations.filter(l => l.practice_id === practiceId).map(l => l.id);
const practPhysIds = physicians.filter(ph => {
const assigns = physicianAssignments[ph.id] || [];
return assigns.some(a => locIds.includes(a.practice_location_id));
}).map(ph => ph.id);
if (practPhysIds.length === 0) {
const el = $('practiceActivityContent');
if (el) el.innerHTML = '<div class="empty-notice">No physicians assigned yet. Assign physicians to log activity.</div>';
return;
}
try {
const { data: logs, error } = await db.from('contact_logs').select('*').in('physician_id', practPhysIds).order('contact_date', { ascending: false }).limit(50);
if (error) throw error;
const el = $('practiceActivityContent');
if (!el) return;
if (!logs || logs.length === 0) {
el.innerHTML = '<div class="empty-notice">No activity logged yet. Click + Log Call to record your first call or visit.</div>';
return;
}
el.innerHTML = '<div class="contact-entries">' + logs.map(e => {
const phys = physicians.find(p => p.id === e.physician_id);
return renderLogEntry(e,{physName:phys?fmtName(phys):'Unknown'});
}).join('') + '</div>';
} catch(e) {
const el = $('practiceActivityContent');
if (el) el.innerHTML = '<div class="empty-notice">Could not load activity</div>';
}
}
function openPracticeContactModal() {
editingContactId = null;
$('contactForm').reset();
$('contactModalTitle').textContent = 'Log Practice Call';
$('authorName').value = 'Tom';
$('contactSaveBtn').textContent = 'Save Note';
$('contactSaveBtn').className = 'btn-primary';
setToday();
const locations = practiceLocations.filter(l => l.practice_id === currentPractice.id);
const select = $('contactLocation');
select.innerHTML = locations.length === 1
? `<option value="${locations[0].id}">${locations[0].address || locations[0].label}, ${locations[0].city || ''}</option>`
: '<option value="">Select location...</option>' + locations.map(l => `<option value="${l.id}">${l.address || l.label || 'Office'}, ${l.city || ''}</option>`).join('');
$('locationSelectRow').style.display = locations.length <= 1 ? 'none' : 'block';
if (locations.length === 1) select.value = locations[0].id;
// Multi-physician checkbox selector
const practPhys = physicians.filter(ph => {
const assigns = physicianAssignments[ph.id] || [];
return assigns.some(a => locations.some(l => l.id === a.practice_location_id));
});
let physRow = $('practicePhysSelectRow');
if (!physRow) {
physRow = document.createElement('div');
physRow.id = 'practicePhysSelectRow';
$('locationSelectRow').parentElement.insertBefore(physRow, $('locationSelectRow'));
}
if (practPhys.length > 0) {
physRow.innerHTML = `<label>Physicians Present (select all that apply)</label>
<div id="practicePhysCheckboxes" style="max-height:180px;overflow-y:auto;border:2px solid #e5e5e5;border-radius:8px;padding:0.5rem;">
${practPhys.map(p => `<div class="selector-option" style="margin-bottom:0.25rem;" onclick="var c=this.querySelector('input');c.checked=!c.checked;">
<input type="checkbox" value="${p.id}" class="practice-phys-cb">
<span class="selector-option-label">${fmtName(p)}</span>
</div>`).join('')}
</div>
<div style="font-size:0.75rem;color:#666;margin-top:0.25rem;">${practPhys.length} physician${practPhys.length!==1?'s':''} at this practice</div>`;
physRow.style.display = 'block';
if (practPhys.length === 1) physRow.querySelector('.practice-phys-cb').checked = true;
} else {
physRow.innerHTML = '<div class="empty-notice" style="color:#dc2626;">No physicians at this practice. Assign a physician first.</div>';
physRow.style.display = 'block';
}
$('setReminder').checked = false;
$('reminderDays').style.display = 'none';
$('reminderDatePreview').textContent = '';
$('contactForm').onsubmit = function(ev) { savePracticeContact(ev); return false; };
$('contactModal').classList.add('active');
}
async function savePracticeContact(e) {
e.preventDefault();
const cbs = document.querySelectorAll('.practice-phys-cb:checked');
const selectedPhysIds = [...cbs].map(cb => cb.value);
if (selectedPhysIds.length === 0) { showToast('Please select at least one physician', 'error'); return; }
const tv = $('contactTime').value, nv = $('contactNotes').value;
const locVal = $('contactLocation').value || null;
const reminderOn = $('setReminder').checked;
const reminderDate = reminderOn ? calcBusinessDate(parseInt($('reminderDaysSelect').value)) : null;
const noteText = tv ? `[${tv}] ${nv}` : nv;
const dateVal = $('contactDate').value, authorVal = $('authorName').value;
// Build entries for all selected physicians
const entries = selectedPhysIds.map(pid => ({physician_id:pid,contact_date:dateVal,author:authorVal,notes:noteText,practice_location_id:locVal,reminder_date:reminderDate}));
await withSave('contactSaveBtn', 'Save Note', async() => {
const {error} = await db.from('contact_logs').insert(entries);
if (error) throw error;
// Update last_contact for all
for (const pid of selectedPhysIds) {
await db.from('physicians').update({last_contact:dateVal}).eq('id',pid);
}
showToast(`Call logged for ${selectedPhysIds.length} physician${selectedPhysIds.length!==1?'s':''}`, 'success');
await loadAllData();
renderPracticeProfile();
await loadPracticeActivity(currentPractice.id);
setTimeout(() => { closeContactModal(); $('contactForm').onsubmit = function(ev) { saveContact(ev); return false; }; const pr = $('practicePhysSelectRow'); if (pr) pr.style.display = 'none'; }, 500);
});
}
function openPhysicianModal() {
editMode=false;selectedPracticeId=null;selectedLocationIds=[];$('modalTitle').textContent='Add Physician';
$('physicianForm').reset();setFields({priority:'',specialty:''});
$('newPracticeFields').style.display='none';$('locationSelector').style.display='none';
$('physicianSaveBtn').textContent='Save Physician';$('physicianSaveBtn').className='btn-primary';
populatePracticeOptions();$('physicianModal').classList.add('active');
}
function closeModal(id){$(id).classList.remove('active');}
function closePhysicianModal(){closeModal('physicianModal');}
function populatePracticeOptions() {
const container = $('practiceOptions');
const search = ($('practiceSearchInput')?.value || '').toLowerCase();
const filtered = search ? practices.filter(p => p.name.toLowerCase().includes(search)) : practices;
container.innerHTML = filtered.map(p => `
<div class="selector-option ${selectedPracticeId === p.id ? 'selected' : ''}"
onclick="selectPractice('${p.id}')">
<input type="radio" name="practice" ${selectedPracticeId === p.id ? 'checked' : ''}>
<span class="selector-option-label">${p.name}</span>
</div>
`).join('') || '<div class="empty-notice">No practices found.</div>';
}
function filterPracticeOptions() { populatePracticeOptions(); }
function filterAssignLocationOptions() {
const search = ($('assignLocationSearch')?.value || '').toLowerCase();
document.querySelectorAll('#assignLocationOptions > div').forEach(group => {
const name = group.querySelector('div[style]')?.textContent?.toLowerCase() || '';
const locs = group.querySelectorAll('.selector-option');
let anyVisible = false;
locs.forEach(loc => {
const text = loc.textContent.toLowerCase();
const match = !search || name.includes(search) || text.includes(search);
loc.style.display = match ? '' : 'none';
if (match) anyVisible = true;
});
group.style.display = anyVisible ? '' : 'none';
});
}
function selectPractice(practiceId) {
selectedPracticeId = practiceId;
populatePracticeOptions();
populateLocationOptions(practiceId);
$('locationSelector').style.display = 'block';
$('newPracticeFields').style.display = 'none';
}
function populateLocationOptions(practiceId) {
const locations = practiceLocations.filter(l => l.practice_id === practiceId);
const container = $('locationOptions');
if (locations.length === 0) {
container.innerHTML = '<div class="empty-notice">No locations for this practice. Add one below.</div>';
return;
}
container.innerHTML = locations.map(loc => `
<div class="selector-option ${selectedLocationIds.includes(loc.id) ? 'selected' : ''}"
onclick="toggleLocationSelection('${loc.id}')">
<input type="checkbox" ${selectedLocationIds.includes(loc.id) ? 'checked' : ''}>
<div>
<span class="selector-option-label">${loc.label || 'Office'}</span>
<div class="selector-option-sub">${loc.city || ''} ${loc.zip || ''}</div>
</div>
</div>
`).join('');
}
function toggleLocationSelection(locationId) {
const index = selectedLocationIds.indexOf(locationId);
if (index === -1) {
selectedLocationIds.push(locationId);
} else {
selectedLocationIds.splice(index, 1);
}
populateLocationOptions(selectedPracticeId);
}
function toggleNewPractice() {
const fields = $('newPracticeFields');
fields.style.display = fields.style.display === 'none' ? 'block' : 'none';
if (fields.style.display === 'block') {
selectedPracticeId = null;
populatePracticeOptions();
$('locationSelector').style.display = 'none';
}
}
async function toggleNewLocation() {
let practiceId = selectedPracticeId;
if (!practiceId) {
const npn = $('newPracticeName').value;
if (!npn) { showToast('Please select or create a practice first', 'error'); return; }
try {
const {data:np,error} = await db.from('practices').insert({name:npn}).select().single();
if (error) throw error;
practices.push(np);
practiceId = np.id;
selectedPracticeId = np.id;
showToast('Practice created: ' + npn, 'success');
} catch(e) { showToast('Error creating practice: ' + e.message, 'error'); return; }
}
closePhysicianModal();
openLocationModal(practiceId);
}
async function toggleAdvancedSolution(e) {
e.preventDefault();e.stopPropagation();
if(!currentPhysician) return;
const newVal = !currentPhysician.advanced_solution;
const{error}=await db.from('physicians').update({advanced_solution:newVal}).eq('id',currentPhysician.id);
if(error){showToast('Error updating AS: '+error.message,'error');return;}
currentPhysician.advanced_solution=newVal;
const idx=physicians.findIndex(p=>p.id===currentPhysician.id);
if(idx>=0) physicians[idx].advanced_solution=newVal;
renderProfile();
showToast(newVal?'Marked as Advanced Solution':'Removed Advanced Solution','success');
}
function editPhysicianInfo() {
editMode=true;const p=currentPhysician;$('modalTitle').textContent='Edit Physician';
setFields({firstName:p.first_name,lastName:p.last_name,physicianEmail:p.email||'',priority:p.priority||'',specialty:p.specialty||'',umConnection:p.academic_connection||p.um_connection||'',patientVolume:p.patient_volume||p.mohs_volume||'',physicianGeneralNotes:p.general_notes||'',degree:p.degree||'',staffTitle:p.title||''});
$('practiceSelector').style.display='none';$('locationSelector').style.display='none';
$('physicianSaveBtn').textContent='Save Physician';$('physicianSaveBtn').className='btn-primary';$('physicianModal').classList.add('active');
}
async function savePhysician(e) {
e.preventDefault();
const data = {first_name:$('firstName').value,last_name:$('lastName').value,email:$('physicianEmail').value||null,priority:$('priority').value||null,specialty:$('specialty').value||null,academic_connection:$('umConnection').value||null,patient_volume:$('patientVolume').value||null,general_notes:$('physicianGeneralNotes').value||null};
const degreeVal=$('degree').value||null;const titleVal=$('staffTitle').value||null;
data.degree=degreeVal;data.title=titleVal;
await withSave('physicianSaveBtn','Save Physician',async()=>{
if(editMode){if(!currentPhysician){showToast('Error: physician context lost. Close and try again.','error');return;}const{error}=await db.from('physicians').update(data).eq('id',currentPhysician.id);if(error)throw error;Object.assign(currentPhysician,data);renderProfile();showToast('Physician updated','success');
}else{
let practiceId=selectedPracticeId;const npn=$('newPracticeName').value;
if(npn&&!practiceId){const{data:np,error:pe}=await db.from('practices').insert({name:npn}).select().single();if(pe)throw pe;practiceId=np.id;practices.push(np);}
const{data:newP,error}=await db.from('physicians').insert(data).select().single();if(error)throw error;
if(selectedLocationIds.length>0){const a=selectedLocationIds.map((lid,i)=>({physician_id:newP.id,practice_location_id:lid,is_primary:i===0}));const{error:ae}=await db.from('physician_location_assignments').insert(a);if(ae)throw ae;}
else if(practiceId){
// Auto-create a default location for the new practice and assign physician
const existingLocs=practiceLocations.filter(l=>l.practice_id===practiceId);
if(existingLocs.length>0){
// Assign to first existing location
const{error:ae}=await db.from('physician_location_assignments').insert({physician_id:newP.id,practice_location_id:existingLocs[0].id,is_primary:true});
if(ae)throw ae;
}else{
// Create a default location and assign
const{data:newLoc,error:le}=await db.from('practice_locations').insert({practice_id:practiceId,label:'Main Office'}).select().single();
if(le)throw le;
const{error:ae}=await db.from('physician_location_assignments').insert({physician_id:newP.id,practice_location_id:newLoc.id,is_primary:true});
if(ae)throw ae;
}
}
physicians.push(newP);physicians.sort((a,b)=>a.last_name.localeCompare(b.last_name));showToast('Physician added','success');
}
await loadAllData();renderList();setTimeout(()=>closePhysicianModal(),500);
});
}
async function deletePhysician() {
await dbDel('physicians',currentPhysician.id,`Delete ${fmtName(currentPhysician)}?`,async()=>{physicians=physicians.filter(p=>p.id!==currentPhysician.id);currentPhysician=null;renderList();renderEmptyState();});
}
function openPracticeModal(){editingPracticeId=null;locationsToDelete=[];$('practiceModalTitle').textContent='Add Practice';$('practiceForm').reset();$('practiceEmail').value='';$('practiceAddressSection').style.display='';$('practiceLocationsEditSection').style.display='none';$('practiceSaveBtn').textContent='Save Practice';$('practiceSaveBtn').className='btn-primary';$('practiceModal').classList.add('active');}
function closePracticeModal(){closeModal('practiceModal');}
function editPractice(){editingPracticeId=currentPractice.id;locationsToDelete=[];$('practiceModalTitle').textContent='Edit Practice';const pLocs=practiceLocations.filter(l=>l.practice_id===currentPractice.id);const pEmail=pLocs.map(l=>l.practice_email).find(Boolean)||'';setFields({practiceName:currentPractice.name,practiceWebsite:currentPractice.website||'',practiceNotes:currentPractice.general_notes||'',practiceEmail:pEmail});$('practiceAddressSection').style.display='none';populateLocationEditCards(currentPractice.id);$('practiceLocationsEditSection').style.display='';$('practiceSaveBtn').textContent='Save Practice';$('practiceSaveBtn').className='btn-primary';$('practiceModal').classList.add('active');}
function editPracticeFromProfile(practiceId){
const pr=practices.find(p=>p.id===practiceId);if(!pr)return;
editingPracticeId=pr.id;locationsToDelete=[];$('practiceModalTitle').textContent='Edit Practice';
const prLocs=practiceLocations.filter(l=>l.practice_id===pr.id);const prEmail=prLocs.map(l=>l.practice_email).find(Boolean)||'';setFields({practiceName:pr.name,practiceWebsite:pr.website||'',practiceNotes:pr.general_notes||'',practiceEmail:prEmail});
$('practiceAddressSection').style.display='none';populateLocationEditCards(pr.id);$('practiceLocationsEditSection').style.display='';$('practiceSaveBtn').textContent='Save Practice';$('practiceSaveBtn').className='btn-primary';$('practiceModal').classList.add('active');
}
let locEditCounter = 0;
function buildLocationCardHTML(loc, idx) {
const id = loc ? loc.id : 'new_' + (++locEditCounter);
const isNew = !loc;
return `<div class="loc-edit-card" data-loc-id="${id}" data-is-new="${isNew}">
<div class="loc-edit-card-header">
<span class="loc-edit-card-title">${loc ? (loc.label || 'Office') : 'New Location'}</span>
<button type="button" class="remove-loc-btn" onclick="removeLocationCard(this, '${id}', ${isNew})" title="Remove">&times;</button>
</div>
<div class="loc-field"><label>Label</label><input type="text" data-field="label" value="${(loc?.label||'').replace(/"/g,'&quot;')}" placeholder="e.g., Main Office, Key Biscayne"></div>
<div class="loc-field"><label>Address</label><input type="text" data-field="address" value="${(loc?.address||'').replace(/"/g,'&quot;')}" placeholder="123 Main St"></div>
<div class="form-row">
<div class="loc-field"><label>City</label><input type="text" data-field="city" value="${(loc?.city||'').replace(/"/g,'&quot;')}"></div>
<div class="loc-field"><label>ZIP</label><input type="text" data-field="zip" value="${(loc?.zip||'').replace(/"/g,'&quot;')}"></div>
</div>
<div class="form-row">
<div class="loc-field"><label>Phone</label><input type="tel" data-field="phone" value="${(loc?.phone||'').replace(/"/g,'&quot;')}"></div>
<div class="loc-field"><label>Fax</label><input type="tel" data-field="fax" value="${(loc?.fax||'').replace(/"/g,'&quot;')}"></div>
</div>
<button type="button" class="loc-advanced-toggle" onclick="this.nextElementSibling.classList.toggle('show');this.textContent=this.nextElementSibling.classList.contains('show')?'Hide details':'More details...'">More details...</button>
<div class="loc-advanced">
<div class="loc-field"><label>Email</label><input type="email" data-field="practice_email" value="${(loc?.practice_email||'').replace(/"/g,'&quot;')}" placeholder="office@practice.com"></div>
<div class="loc-field"><label>Office Hours</label><input type="text" data-field="office_hours" value="${(loc?.office_hours||'').replace(/"/g,'&quot;')}" placeholder="Mon-Fri 9AM-5PM"></div>
<div class="loc-field"><label>Office Staff</label><input type="text" data-field="office_staff" value="${(loc?.office_staff||'').replace(/"/g,'&quot;')}"></div>
<div class="loc-field"><label>Receptionist</label><input type="text" data-field="receptionist_name" value="${(loc?.receptionist_name||'').replace(/"/g,'&quot;')}"></div>
<div class="loc-field"><label>Best Days to Visit</label><input type="text" data-field="best_days" value="${(loc?.best_days||'').replace(/"/g,'&quot;')}"></div>
</div>
</div>`;
}
function populateLocationEditCards(practiceId) {
const locations = practiceLocations.filter(l => l.practice_id === practiceId);
const container = $('practiceLocationsCards');
if (locations.length === 0) {
container.innerHTML = '<div class="empty-notice" style="padding:1rem;font-size:0.85rem;">No locations yet. Click "+ Add Location" to add one.</div>';
} else {
container.innerHTML = locations.map((loc, i) => buildLocationCardHTML(loc, i)).join('');
}
}
function addNewLocationCard() {
const container = $('practiceLocationsCards');
const emptyNotice = container.querySelector('.empty-notice');
if (emptyNotice) emptyNotice.remove();
container.insertAdjacentHTML('beforeend', buildLocationCardHTML(null, container.children.length));
const newCard = container.lastElementChild;
newCard.querySelector('input[data-field="label"]').focus();
}
let locationsToDelete = [];
function removeLocationCard(btn, locId, isNew) {
const card = btn.closest('.loc-edit-card');
if (!isNew && locId) {
if (!confirm('Remove this location? It will be deleted when you save.')) return;
locationsToDelete.push(locId);
}
card.remove();
const container = $('practiceLocationsCards');
if (container.children.length === 0) {
container.innerHTML = '<div class="empty-notice" style="padding:1rem;font-size:0.85rem;">No locations. Click "+ Add Location" to add one.</div>';
}
}
function getLocationCardsData() {
const cards = document.querySelectorAll('#practiceLocationsCards .loc-edit-card');
return Array.from(cards).map(card => {
const getData = (field) => {const el = card.querySelector(`input[data-field="${field}"]`); return el ? el.value || null : null;};
return {
id: card.dataset.locId,
isNew: card.dataset.isNew === 'true',
label: getData('label'),
address: getData('address'),
city: getData('city'),
zip: getData('zip'),
phone: getData('phone'),
fax: getData('fax'),
practice_email: getData('practice_email'),
office_hours: getData('office_hours'),
office_staff: getData('office_staff'),
receptionist_name: getData('receptionist_name'),
best_days: getData('best_days')
};
});
}
async function savePractice(e) {
e.preventDefault();
const data={name:$('practiceName').value,website:$('practiceWebsite').value||null,general_notes:$('practiceNotes').value||null};
await withSave('practiceSaveBtn','Save Practice',async()=>{
if(editingPracticeId){
const{error}=await db.from('practices').update(data).eq('id',editingPracticeId);if(error)throw error;
// Save location edits
const locCards = getLocationCardsData();
for (const loc of locCards) {
const locData = {practice_id:editingPracticeId,label:loc.label,address:loc.address,city:loc.city,zip:loc.zip,phone:loc.phone,fax:loc.fax,practice_email:loc.practice_email,office_hours:loc.office_hours,office_staff:loc.office_staff,receptionist_name:loc.receptionist_name,best_days:loc.best_days};
if (loc.isNew) {
const{error:le}=await db.from('practice_locations').insert(locData);if(le)console.error('Location insert error:',le);
} else {
const{error:le}=await db.from('practice_locations').update(locData).eq('id',loc.id);if(le)console.error('Location update error:',le);
}
}
// Delete removed locations
for (const delId of locationsToDelete) {
await db.from('physician_location_assignments').delete().eq('practice_location_id',delId);
await db.from('practice_locations').delete().eq('id',delId);
}
locationsToDelete = [];
showToast('Practice updated','success');
}else{const{data:newPract,error}=await db.from('practices').insert(data).select().single();if(error)throw error;
const addr=$('practiceAddress').value,city=$('practiceCity').value,zip=$('practiceZip').value,ph=$('practicePhone').value,fx=$('practiceFax').value;
const pEmail=$('practiceEmail').value||null;
if(addr||city){const locData={practice_id:newPract.id,label:'Main Office',address:addr||null,city:city||null,zip:zip||null,phone:ph||null,fax:fx||null,practice_email:pEmail};const{error:le}=await db.from('practice_locations').insert(locData);if(le)console.error('Location insert error:',le);}
showToast('Practice added','success');}
await loadAllData();if(currentPractice){currentPractice=practices.find(p=>p.id===currentPractice.id);renderPracticeProfile();}
if(currentPhysician){renderProfile();}
setTimeout(()=>closePracticeModal(),500);
});
}
async function deletePractice() {
await dbDel('practices',currentPractice.id,`Delete ${currentPractice.name}? This will also delete all its locations.`,async()=>{practices=practices.filter(p=>p.id!==currentPractice.id);currentPractice=null;await loadAllData();renderList();renderEmptyState();});
}
function openLocationModal(practiceId = null) {
editingLocationId = null;
$('locationModalTitle').textContent = 'Add Location';
$('locationForm').reset();
$('locationIsPrimary').value = 'false';
$('locationSaveBtn').textContent = 'Save Location';
$('locationSaveBtn').className = 'btn-primary';
const select = $('locationPracticeId');
select.innerHTML = '<option value="">-- Select Practice --</option>' +
practices.map(p => `<option value="${p.id}" ${p.id === practiceId ? 'selected' : ''}>${p.name}</option>`).join('');
$('locationPracticeEditRow').style.display='none';
$('locationModal').classList.add('active');
}
function closeLocationModal(){closeModal('locationModal');}
function editLocationDetails(locationId) {
const loc=practiceLocations.find(l=>l.id===locationId);if(!loc)return;
editingLocationId=locationId;$('locationModalTitle').textContent='Edit Location';
setFields({locationPracticeId:loc.practice_id,locationLabel:loc.label||'',locationIsPrimary:'false',locationAddress:loc.address||'',locationCity:loc.city||'',locationZip:loc.zip||'',locationPhone:loc.phone||'',locationFax:loc.fax||'',locationEmail:loc.practice_email||'',locationHours:loc.office_hours||'',locationStaff:loc.office_staff||'',locationReceptionist:loc.receptionist_name||'',locationBestDays:loc.best_days||''});
$('locationSaveBtn').textContent='Save Location';$('locationSaveBtn').className='btn-primary';
$('locationPracticeId').innerHTML='<option value="">-- Select Practice --</option>'+practices.map(p=>`<option value="${p.id}" ${p.id===loc.practice_id?'selected':''}>${p.name}</option>`).join('');
const pr=practices.find(p=>p.id===loc.practice_id);
$('locationPracticeNameEdit').value=pr?pr.name:'';
$('locationPracticeEditRow').style.display='';
$('locationModal').classList.add('active');
}
async function saveInlinePracticeName() {
const newName = $('locationPracticeNameEdit').value.trim();
if (!newName) { showToast('Practice name cannot be empty', 'error'); return; }
const practiceId = $('locationPracticeId').value;
if (!practiceId) { showToast('No practice selected', 'error'); return; }
try {
const {error} = await db.from('practices').update({name: newName}).eq('id', practiceId);
if (error) throw error;
const pr = practices.find(p => p.id === practiceId);
if (pr) pr.name = newName;
// Update the dropdown option text
const opt = $('locationPracticeId').querySelector(`option[value="${practiceId}"]`);
if (opt) opt.textContent = newName;
showToast('Practice renamed to "' + newName + '"', 'success');
} catch(e) { showToast('Error renaming practice: ' + e.message, 'error'); }
}
async function saveLocation(e) {
e.preventDefault();
const data={practice_id:$('locationPracticeId').value,label:$('locationLabel').value,address:$('locationAddress').value||null,city:$('locationCity').value||null,zip:$('locationZip').value||null,phone:$('locationPhone').value||null,fax:$('locationFax').value||null,practice_email:$('locationEmail').value||null,office_hours:$('locationHours').value||null,office_staff:$('locationStaff').value||null,receptionist_name:$('locationReceptionist').value||null,best_days:$('locationBestDays').value||null};
await withSave('locationSaveBtn','Save Location',async()=>{
if(editingLocationId){const{error}=await db.from('practice_locations').update(data).eq('id',editingLocationId);if(error)throw error;showToast('Location updated','success');
}else{const{error}=await db.from('practice_locations').insert(data);if(error)throw error;showToast('Location added','success');}
await loadAllData();if(currentPractice)renderPracticeProfile();if(currentPhysician)renderProfile();setTimeout(()=>closeLocationModal(),500);
});
}
async function deleteLocation(locationId) {
await dbDel('practice_locations',locationId,'Delete this location and all physician assignments?',async()=>{await loadAllData();if(currentPractice)renderPracticeProfile();});
}
function openAssignLocationModal() {
const existingAssignments = (physicianAssignments[currentPhysician.id] || []).map(a => a.practice_location_id);
const container = $('assignLocationOptions');
container.innerHTML = practices.map(practice => {
const locations = practiceLocations.filter(l => l.practice_id === practice.id);
if (locations.length === 0) return '';
return `
<div style="margin-bottom: 1rem;">
<div style="font-weight: 600; margin-bottom: 0.5rem; color: #0a4d3c;">${practice.name}</div>
${locations.map(loc => `
<div class="selector-option" data-loc-id="${loc.id}" onclick="toggleAssignLocation('${loc.id}', this)">
<input type="checkbox" ${existingAssignments.includes(loc.id) ? 'checked' : ''}>
<div>
<span class="selector-option-label">${loc.label || 'Office'}</span>
<div class="selector-option-sub">${loc.city || ''} ${loc.address || ''}</div>
</div>
</div>
`).join('')}
</div>
`;
}).join('') || '<div class="empty-notice">No locations available. Create a practice and location first.</div>';
$('assignLocationModal').classList.add('active');
}
function closeAssignLocationModal(){closeModal('assignLocationModal');}
function toggleAssignLocation(locationId, element) {
const checkbox = element.querySelector('input[type="checkbox"]');
checkbox.checked = !checkbox.checked;
}
async function saveLocationAssignments() {
const options = document.querySelectorAll('#assignLocationOptions .selector-option');
const selectedIds = [];
options.forEach(opt => {
const cb = opt.querySelector('input[type="checkbox"]');
const locId = opt.getAttribute('data-loc-id');
if (cb && cb.checked && locId) selectedIds.push(locId);
});
try {
updateSyncIndicators('syncing');
const {error:delErr} = await db
.from('physician_location_assignments')
.delete()
.eq('physician_id', currentPhysician.id);
if (delErr) throw delErr;
if (selectedIds.length > 0) {
const assignments = selectedIds.map((locId, index) => ({
physician_id: currentPhysician.id,
practice_location_id: locId,
is_primary: index === 0
}));
const { error } = await db
.from('physician_location_assignments')
.insert(assignments);
if (error) throw error;
}
await loadAllData();
renderProfile();
closeAssignLocationModal();
showToast('Location assignments updated', 'success');
updateSyncIndicators('synced');
} catch (error) {
console.error('Save error:', error);
showToast('Error saving: ' + error.message, 'error');
updateSyncIndicators('error');
}
}
async function quickAddPracticeAndAssign() {
const name = $('quickPracticeName').value.trim();
if (!name) { showToast('Practice name required', 'error'); return; }
try {
updateSyncIndicators('syncing');
const {data:newPract,error:pe} = await db.from('practices').insert({name}).select().single();
if (pe) throw pe;
const locData = {practice_id:newPract.id,label:'Main Office',address:$('quickPracticeAddr').value||null,city:$('quickPracticeCity').value||null,zip:$('quickPracticeZip').value||null,phone:$('quickPracticePhone').value||null};
const {data:newLoc,error:le} = await db.from('practice_locations').insert(locData).select().single();
if (le) throw le;
const {error:ae} = await db.from('physician_location_assignments').insert({physician_id:currentPhysician.id,practice_location_id:newLoc.id,is_primary:false});
if (ae) throw ae;
await loadAllData();
renderProfile();
closeAssignLocationModal();
showToast(`${name} created and assigned`, 'success');
updateSyncIndicators('synced');
} catch(e) {
console.error('Quick add practice error:', e);
showToast('Error: ' + e.message, 'error');
updateSyncIndicators('error');
}
}
async function removeAssignment(assignmentId) {
await dbDel('physician_location_assignments',assignmentId,'Remove this location assignment?',async()=>{await loadAllData();renderProfile();});
}
function prefixNote(prefix){const ta=$('contactNotes');if(!ta.value.startsWith('Call: ')&&!ta.value.startsWith('Visit: ')){ta.value=prefix+ta.value;}else{ta.value=ta.value.replace(/^(Call|Visit): /,prefix);}ta.focus();}
function openContactModal() {
editingContactId = null;
$('contactForm').reset();
$('contactModalTitle').textContent = 'Add Contact Note';
$('authorName').value = 'Tom';
$('contactSaveBtn').textContent = 'Save Note';
$('contactSaveBtn').className = 'btn-primary';
setToday();
populateLocationDropdown();
populateAlsoAttended();
// Hide practicePhysSelectRow if it was left visible from practice modal
const pr = $('practicePhysSelectRow'); if (pr) pr.style.display = 'none';
$('contactForm').onsubmit = function(ev) { saveContact(ev); return false; };
$('setReminder').checked = false;
$('reminderDays').style.display = 'none';
$('reminderDatePreview').textContent = '';
$('contactModal').classList.add('active');
}
function populateLocationDropdown() {
const select = $('contactLocation');
const assignments = physicianAssignments[currentPhysician.id] || [];
const locations = assignments.map(a => {
const loc = practiceLocations.find(l => l.id === a.practice_location_id);
if (loc) {
const practice = practices.find(p => p.id === loc.practice_id);
return {
id: loc.id,
label: `${loc.address}, ${loc.city}${practice ? ' (' + practice.name + ')' : ''}`
};
}
return null;
}).filter(Boolean);
select.innerHTML = locations.length === 1
? `<option value="${locations[0].id}">${locations[0].label}</option>`
: '<option value="">Select location...</option>' +
locations.map(l => `<option value="${l.id}">${l.label}</option>`).join('');
$('locationSelectRow').style.display = locations.length <= 1 ? 'none' : 'block';
if (locations.length === 1) {
select.value = locations[0].id;
}
}
function populateAlsoAttended() {
const row = $('alsoAttendedRow');
const list = $('alsoAttendedList');
if (!row || !list || !currentPhysician) { if(row) row.style.display='none'; return; }
// Find other physicians at the same practice locations
const myAssigns = physicianAssignments[currentPhysician.id] || [];
const myLocIds = myAssigns.map(a => a.practice_location_id);
const colleagues = physicians.filter(p => {
if (p.id === currentPhysician.id) return false;
const theirAssigns = physicianAssignments[p.id] || [];
return theirAssigns.some(a => myLocIds.includes(a.practice_location_id));
});
if (colleagues.length === 0) { row.style.display = 'none'; return; }
row.style.display = 'block';
list.style.display = 'none'; // collapsed by default
list.innerHTML = colleagues.map(p => `<div class="selector-option" style="margin-bottom:0.25rem;" onclick="var c=this.querySelector('input');c.checked=!c.checked;">
<input type="checkbox" value="${p.id}" class="also-attended-cb">
<span class="selector-option-label">${fmtName(p)}</span>
</div>`).join('');
}
function closeContactModal(){closeModal('contactModal');}
async function saveContact(e) {
e.preventDefault();
const tv=$('contactTime').value,nv=$('contactNotes').value;
const locVal=$('contactLocation').value||null;
const reminderOn=$('setReminder').checked;
const reminderDate=reminderOn?calcBusinessDate(parseInt($('reminderDaysSelect').value)):null;
const noteText=tv?`[${tv}] ${nv}`:nv;
const dateVal=$('contactDate').value,authorVal=$('authorName').value;
const data={physician_id:currentPhysician.id,contact_date:dateVal,author:authorVal,notes:noteText,practice_location_id:locVal,reminder_date:reminderDate};
// Collect "also attended" physicians
const alsoCbs=document.querySelectorAll('.also-attended-cb:checked');
const alsoIds=[...alsoCbs].map(cb=>cb.value);
await withSave('contactSaveBtn','Save Note',async()=>{
if(editingContactId){const{error}=await db.from('contact_logs').update(data).eq('id',editingContactId);if(error)throw error;showToast('Note updated','success');
}else{
// Insert for primary physician
const{error}=await db.from('contact_logs').insert(data);if(error)throw error;
// Insert for also-attended physicians
if(alsoIds.length>0){
const alsoEntries=alsoIds.map(pid=>({physician_id:pid,contact_date:dateVal,author:authorVal,notes:noteText,practice_location_id:locVal,reminder_date:reminderDate}));
const{error:ae}=await db.from('contact_logs').insert(alsoEntries);
if(ae)console.error('Also-attended insert error:',ae);
for(const pid of alsoIds){await db.from('physicians').update({last_contact:dateVal}).eq('id',pid);}
}
const total=1+alsoIds.length;
showToast(`Note logged for ${total} physician${total>1?'s':''}`,'success');
}
await db.from('physicians').update({last_contact:dateVal}).eq('id',currentPhysician.id);
currentPhysician.last_contact=dateVal;await loadContactLogs(currentPhysician.id);renderProfile();setTimeout(()=>closeContactModal(),500);
});
}
async function editNote(logId) {
const log = (contactLogs[currentPhysician.id] || []).find(l => l.id === logId);
if (!log) return;
editingContactId = logId;
$('contactModalTitle').textContent = 'Edit Contact Note';
$('contactSaveBtn').textContent = 'Save Note';
$('contactSaveBtn').className = 'btn-primary';
populateLocationDropdown();
$('contactDate').value = log.contact_date;
$('contactLocation').value = log.practice_location_id || '';
$('authorName').value = log.author || '';
// Parse time from notes if stored as [HH:MM] prefix
let notes = log.notes || '';
let time = '';
if (!time) {
const timeMatch = notes.match(/^\[(\d{1,2}:\d{2})\]\s*/);
if (timeMatch) {
time = timeMatch[1];
notes = notes.replace(timeMatch[0], '');
}
}
$('contactTime').value = time;
$('contactNotes').value = notes;
// Populate reminder state
if (log.reminder_date) {
$('setReminder').checked = true;
$('reminderDays').style.display = 'flex';
const rd = new Date(log.reminder_date + 'T12:00:00');
const opts = {weekday:'short', month:'short', day:'numeric'};
$('reminderDatePreview').textContent = rd.toLocaleDateString('en-US', opts);
} else {
$('setReminder').checked = false;
$('reminderDays').style.display = 'none';
$('reminderDatePreview').textContent = '';
}
$('contactModal').classList.add('active');
}
async function deleteNote(logId) {
await dbDel('contact_logs',logId,'Delete this note?',async()=>{await loadContactLogs(currentPhysician.id);renderProfile();});
}
function toggleAdminPanel() {
const panel = $('adminPanel');
panel.classList.toggle('show');
}
async function importCSV(file) {
if(!file)return;
const status=s=>{const el=$('importStatus');if(el)el.textContent=s;const el2=$('importStatusMain');if(el2)el2.textContent=s;};
status('Reading CSV...');
try{
const text=await file.text();
const lines=text.split('\n').filter(l=>l.trim());
const headers=lines[0].split(',').map(h=>h.trim().toLowerCase().replace(/\s+/g,'_'));
const rows=[];
for(let i=1;i<lines.length;i++){
const vals=[];let cur='',inQ=false;
for(const ch of lines[i]){if(ch==='"'){inQ=!inQ;}else if(ch===','&&!inQ){vals.push(cur.trim());cur='';}else{cur+=ch;}}
vals.push(cur.trim());
const row={};headers.forEach((h,j)=>row[h]=vals[j]||'');rows.push(row);
}
status(`Parsed ${rows.length} rows. Importing...`);
updateSyncIndicators('syncing');
// Build unique practices
const practiceNames=[...new Set(rows.map(r=>r.practice_name).filter(Boolean))];
const practiceMap={};
for(const name of practiceNames){
const{data:ex}=await db.from('practices').select('*').eq('name',name).maybeSingle();
if(ex){practiceMap[name]=ex.id;}else{
const{data:np,error}=await db.from('practices').insert({name}).select().maybeSingle();
if(np)practiceMap[name]=np.id;
}}
// Group by physician name, collect locations
const physMap=new Map();
rows.forEach(r=>{
const key=`${(r.first_name||'').toLowerCase()}|${(r.last_name||'').toLowerCase()}`;
if(!physMap.has(key))physMap.set(key,{phys:{first_name:r.first_name,last_name:r.last_name,email:r.email||null,priority:r.priority||null,academic_connection:r.academic_connection||r.um_connection||null,specialty:r.specialty||null,degree:r.degree||null,title:r.title||null,patient_volume:r.patient_volume||r.vol||null,general_notes:r.general_notes||null},locs:[]});
const e=physMap.get(key);
if(r.address&&r.address!=='[Research needed]')e.locs.push({practice_id:practiceMap[r.practice_name],address:r.address,city:r.city,zip:r.zip,phone:r.phone,fax:r.fax,label:r.city||'Office',is_primary:e.locs.length===0});
});
// Insert physicians
let count=0;const total=physMap.size;
for(const[key,entry] of physMap){
count++;if(count%10===0)status(`Importing physician ${count} of ${total}...`);
const{data:ex}=await db.from('physicians').select('*').ilike('first_name',entry.phys.first_name).ilike('last_name',entry.phys.last_name).maybeSingle();
const phys=ex||(await db.from('physicians').insert(entry.phys).select().maybeSingle()).data;
if(!phys)continue;
// Create locations and assignments
for(const loc of entry.locs){
if(!loc.practice_id)continue;
const{data:exLoc}=await db.from('practice_locations').select('*').eq('practice_id',loc.practice_id).eq('address',loc.address).maybeSingle();
const locRec=exLoc||(await db.from('practice_locations').insert({practice_id:loc.practice_id,label:loc.label,address:loc.address,city:loc.city,zip:loc.zip,phone:loc.phone,fax:loc.fax}).select().maybeSingle()).data;
if(!locRec)continue;
const{data:exA}=await db.from('physician_location_assignments').select('*').eq('physician_id',phys.id).eq('practice_location_id',locRec.id).maybeSingle();
if(!exA)await db.from('physician_location_assignments').insert({physician_id:phys.id,practice_location_id:locRec.id,is_primary:loc.is_primary});
}}
await loadAllData();
status(`Done! Imported ${physMap.size} physicians, ${practiceNames.length} practices.`);
showToast(`Imported ${physMap.size} physicians`,'success');
updateSyncIndicators('synced');
}catch(e){console.error('Import error:',e);status('Error: '+e.message);showToast('Import failed: '+e.message,'error');updateSyncIndicators('error');}
}
async function importASList(file) {
if(!file)return;
const status=s=>{const el=$('asImportStatus');if(el)el.textContent=s;};
status('Reading CSV...');
try{
const text=await file.text();
const lines=text.split('\n').filter(l=>l.trim());
const headers=lines[0].split(',').map(h=>h.trim().toLowerCase().replace(/[?"]/g,'').replace(/\s+/g,'_'));
// Find relevant columns
const flIdx=headers.indexOf('first_last');
const fnIdx=headers.indexOf('physician_first_name');
const lnIdx=headers.indexOf('physician_last_name');
const asIdx=headers.findIndex(h=>h==='as'||h==='as_');
if(asIdx<0){status('Error: No "AS?" column found in CSV');showToast('CSV must have an "AS?" column','error');return;}
if(flIdx<0&&(fnIdx<0||lnIdx<0)){status('Error: Need "First Last" or "Physician First Name"+"Physician Last Name" columns');showToast('CSV must have name columns','error');return;}
const rows=[];
for(let i=1;i<lines.length;i++){
const vals=[];let cur='',inQ=false;
for(const ch of lines[i]){if(ch==='"'){inQ=!inQ;}else if(ch===','&&!inQ){vals.push(cur.trim());cur='';}else{cur+=ch;}}
vals.push(cur.trim());
rows.push(vals);
}
let updated=0,notFound=0;
for(const vals of rows){
const asVal=(vals[asIdx]||'').trim().toUpperCase();
const isAS=asVal==='Y'||asVal==='YES'||asVal==='TRUE'||asVal==='1';
let firstName='',lastName='';
if(flIdx>=0){const parts=(vals[flIdx]||'').trim().split(/\s+/);firstName=parts[0]||'';lastName=parts.slice(1).join(' ')||'';}
else{firstName=(vals[fnIdx]||'').trim();lastName=(vals[lnIdx]||'').trim();}
if(!firstName&&!lastName)continue;
const match=physicians.find(p=>p.first_name.toLowerCase()===firstName.toLowerCase()&&p.last_name.toLowerCase()===lastName.toLowerCase());
if(match){
if(match.advanced_solution!==isAS){
const{error}=await db.from('physicians').update({advanced_solution:isAS}).eq('id',match.id);
if(!error){match.advanced_solution=isAS;updated++;}
}
}else{notFound++;}
}
await loadAllData();
status(`Done! Updated ${updated} physician(s).${notFound?' '+notFound+' not matched.':''}`);
showToast(`AS updated for ${updated} physician(s)`,'success');
if(currentPhysician)renderProfile();
}catch(e){console.error('AS import error:',e);status('Error: '+e.message);showToast('AS import failed: '+e.message,'error');}
}
async function clearDatabase() {
const confirmMsg = 'Are you sure you want to DELETE ALL DATA?\n\nThis will remove:\n- All physicians\n- All practices\n- All locations\n- All contact logs\n\nThis cannot be undone!';
if (!confirm(confirmMsg)) return;
if (!confirm('FINAL WARNING: Click OK to permanently delete all data.')) return;
try {
updateSyncIndicators('syncing');
showToast('Clearing database...', 'info');
for(const t of ['contact_logs','physician_location_assignments','physicians','practice_locations','practices']){
const{error,count}=await db.from(t).delete().neq('id','00000000-0000-0000-0000-000000000000');
console.log(`Deleted from ${t}: error=${error?.message||'none'}`);
if(error) throw error;
}
// Verify physicians table is actually empty
const{data:remaining}=await db.from('physicians').select('id,first_name,last_name');
if(remaining&&remaining.length>0){
console.warn(`${remaining.length} physicians survived delete! RLS may be blocking deletions.`);
showToast(`Warning: ${remaining.length} records could not be deleted (database permissions issue). Check Supabase RLS policies.`,'error');
// Try deleting them individually
for(const r of remaining){
const{error:e2}=await db.from('physicians').delete().eq('id',r.id);
console.log(`Individual delete ${r.first_name} ${r.last_name}: ${e2?.message||'ok'}`);
}
}
physicians=[];practices=[];practiceLocations=[];physicianAssignments={};contactLogs={};
currentPhysician=null;currentPractice=null;
await loadAllData();
renderList();
if(physicians.length>0){
showToast(`Clear incomplete: ${physicians.length} physicians remain. Check Supabase RLS/policies.`,'error');
}else{
renderEmptyState();
showToast('Database cleared successfully!', 'success');
}
updateSyncIndicators('synced');
} catch (error) {
console.error('Clear database error:', error);
showToast('Error clearing database: ' + error.message, 'error');
updateSyncIndicators('error');
}
}
function openAssignPhysicianModal() {
const locations = practiceLocations.filter(l => l.practice_id === currentPractice.id);
const select = $('assignPhysLocationSelect');
select.innerHTML = locations.map(loc => `<option value="${loc.id}">${loc.label || 'Office'} - ${loc.address || ''}, ${loc.city || ''}</option>`).join('');
if (locations.length === 0) { showToast('Add a location to this practice first', 'error'); return; }
const locId = select.value;
const existingPhysIds = physicians.filter(p => {
const assigns = physicianAssignments[p.id] || [];
return assigns.some(a => locations.some(l => l.id === a.practice_location_id));
}).map(p => p.id);
renderAssignPhysicianOptions(existingPhysIds);
$('assignPhysSearch').value = '';
$('assignPhysicianModal').classList.add('active');
}
function renderAssignPhysicianOptions(existingPhysIds) {
const search = ($('assignPhysSearch')?.value || '').toLowerCase();
const filtered = search ? physicians.filter(p => `${p.first_name} ${p.last_name}`.toLowerCase().includes(search)) : physicians;
$('assignPhysicianOptions').innerHTML = filtered.map(p => `
<div class="selector-option" data-phys-id="${p.id}" onclick="toggleAssignPhys('${p.id}', this)">
<input type="checkbox" ${existingPhysIds.includes(p.id) ? 'checked' : ''}>
<div>
<span class="selector-option-label">${fmtName(p)}</span>
<div class="selector-option-sub">${p.specialty || ''}</div>
</div>
</div>
`).join('') || '<div class="empty-notice">No physicians found</div>';
}
function filterAssignPhysicianOptions() {
// Preserve current checkbox state before re-rendering
const currentChecked = new Set();
document.querySelectorAll('#assignPhysicianOptions .selector-option').forEach(opt => {
const cb = opt.querySelector('input[type="checkbox"]');
const pid = opt.getAttribute('data-phys-id');
if (cb && cb.checked && pid) currentChecked.add(pid);
});
const locations = practiceLocations.filter(l => l.practice_id === currentPractice.id);
const existingPhysIds = physicians.filter(p => {
const assigns = physicianAssignments[p.id] || [];
return assigns.some(a => locations.some(l => l.id === a.practice_location_id));
}).map(p => p.id);
// Merge: existing DB assignments + manually checked
const mergedIds = [...new Set([...existingPhysIds, ...currentChecked])];
renderAssignPhysicianOptions(mergedIds);
}
function toggleAssignPhys(physId, element) {
const cb = element.querySelector('input[type="checkbox"]');
cb.checked = !cb.checked;
}
function closeAssignPhysicianModal(){closeModal('assignPhysicianModal');}
async function quickAddPhysician() {
const first = $('quickPhysFirst').value.trim();
const last = $('quickPhysLast').value.trim();
if (!first || !last) { showToast('First and last name required', 'error'); return; }
const locId = $('assignPhysLocationSelect').value;
if (!locId) { showToast('Select a location first', 'error'); return; }
try {
updateSyncIndicators('syncing');
const data = {first_name:first,last_name:last,degree:$('quickPhysDegree').value||null,specialty:$('quickPhysSpecialty').value||null,priority:$('quickPhysPriority').value||null};
const {data:newPhys,error} = await db.from('physicians').insert(data).select().single();
if (error) throw error;
// Assign to selected location
const {error:assignErr} = await db.from('physician_location_assignments').insert({physician_id:newPhys.id,practice_location_id:locId,is_primary:true});
if (assignErr) throw assignErr;
await loadAllData();
// Clear quick-add fields
$('quickPhysFirst').value = '';
$('quickPhysLast').value = '';
$('quickPhysDegree').value = '';
$('quickPhysSpecialty').value = '';
$('quickPhysPriority').value = '';
renderPracticeProfile();
// Re-render the physician options to show the new physician as checked
const locations = practiceLocations.filter(l => l.practice_id === currentPractice.id);
const existingPhysIds = physicians.filter(p => {
const assigns = physicianAssignments[p.id] || [];
return assigns.some(a => locations.some(l => l.id === a.practice_location_id));
}).map(p => p.id);
renderAssignPhysicianOptions(existingPhysIds);
showToast(`Dr. ${first} ${last} added and assigned`, 'success');
updateSyncIndicators('synced');
} catch(e) {
console.error('Quick add error:', e);
showToast('Error: ' + e.message, 'error');
updateSyncIndicators('error');
}
}
async function savePhysicianToLocation() {
const locId = $('assignPhysLocationSelect').value;
if (!locId) { showToast('Select a location', 'error'); return; }
const options = document.querySelectorAll('#assignPhysicianOptions .selector-option');
const selectedPhysIds = [];
const unselectedPhysIds = [];
options.forEach(opt => {
const cb = opt.querySelector('input[type="checkbox"]');
const physId = opt.getAttribute('data-phys-id');
if (physId && cb) {
if (cb.checked) selectedPhysIds.push(physId);
else unselectedPhysIds.push(physId);
}
});
try {
updateSyncIndicators('syncing');
// Add new assignments
for (const physId of selectedPhysIds) {
const {data:existing} = await db.from('physician_location_assignments').select('id').eq('physician_id',physId).eq('practice_location_id',locId).maybeSingle();
if (!existing) {
const {error} = await db.from('physician_location_assignments').insert({physician_id:physId,practice_location_id:locId,is_primary:false});
if (error) throw error;
}
}
// Remove unchecked assignments
for (const physId of unselectedPhysIds) {
await db.from('physician_location_assignments').delete().eq('physician_id',physId).eq('practice_location_id',locId);
}
await loadAllData();
renderPracticeProfile();
closeAssignPhysicianModal();
showToast('Physicians assigned', 'success');
updateSyncIndicators('synced');
} catch(e) {
console.error('Assign error:', e);
showToast('Error: ' + e.message, 'error');
updateSyncIndicators('error');
}
}
function openExportModal(){document.getElementById('exportModal').classList.add('active');}
function closeExportModal(){closeModal('exportModal');}
function escCSV(val){if(val==null)return '';const s=String(val);if(s.includes(',')||s.includes('"')||s.includes('\n'))return '"'+s.replace(/"/g,'""')+'"';return s;}
function downloadCSV(filename,headers,rows){const csv=[headers.join(','),...rows.map(r=>r.map(escCSV).join(','))].join('\n');const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}
function todayStamp(){const d=new Date();return d.toISOString().slice(0,10)+'_'+d.toTimeString().slice(0,8).replace(/:/g,'');}
async function exportCSV(type){
const st=document.getElementById('exportStatus');st.style.display='block';st.style.background='#e0f2fe';st.style.color='#075985';st.textContent='Preparing export...';
try{
if(type==='physicians'||type==='all') await exportPhysicians();
if(type==='contacts'||type==='all') await exportContacts();
if(type==='practices'||type==='all') await exportPractices();
st.style.background='#dcfce7';st.style.color='#166534';st.textContent='Export complete!';
showToast('CSV exported successfully','success');
}catch(e){st.style.background='#fee2e2';st.style.color='#991b1b';st.textContent='Export failed: '+e.message;showToast('Export error: '+e.message,'error');}
}
async function exportPhysicians(){
const{data:allPhys,error}=await db.from('physicians').select('*').order('last_name');if(error)throw error;
const{data:allAssign}=await db.from('physician_location_assignments').select('*, practice_locations(*, practices(name))');
const am={};(allAssign||[]).forEach(a=>{if(!am[a.physician_id])am[a.physician_id]=[];am[a.physician_id].push(a);});
// Fetch latest activity per physician for Status column
const{data:allLogs}=await db.from('contact_logs').select('*').order('contact_date',{ascending:false});
const latestLog={};(allLogs||[]).forEach(l=>{if(!latestLog[l.physician_id])latestLog[l.physician_id]=l;});
const h=['Last Name','First Name','Degree','Practice','Tier','Specialty','Email','Academic Connection','Patient Volume','Primary Address','Primary City','Primary ZIP','Primary Phone','Primary Fax','Office Hours','Best Days','Receptionist','Location Count','Last Contact','Status','General Notes'];
const rows=(allPhys||[]).map(p=>{const as=am[p.id]||[];const pl=(as.find(a=>a.is_primary)||as[0])?.practice_locations||{};
const log=latestLog[p.id];const statusNote=log?(log.notes||'').replace(/^\[\d{1,2}:\d{2}\]\s*/,''):'';const statusPreview=statusNote.length>80?statusNote.substring(0,80)+'...':statusNote;const status=log?log.contact_date+': '+statusPreview:'';
return[p.last_name,p.first_name,p.degree||'',pl.practices?.name||p.practice_name||'',p.priority||'',p.specialty||'',p.email||'',p.academic_connection||'',p.patient_volume||p.mohs_volume||'',pl.address||'',pl.city||'',pl.zip||'',pl.phone||'',pl.fax||'',pl.office_hours||'',pl.best_days||'',pl.receptionist_name||'',as.length,p.last_contact||'',status,p.general_notes||''];});
downloadCSV('physicians_export_'+todayStamp()+'.csv',h,rows);
}
async function exportContacts(){
const{data:allLogs,error}=await db.from('contact_logs').select('*').order('contact_date',{ascending:false});if(error)throw error;
const pm={};physicians.forEach(p=>pm[p.id]=p);
const h=['Date','Time','Author','Physician Last Name','Physician First Name','Location','Notes'];
const rows=(allLogs||[]).map(l=>{const p=pm[l.physician_id]||{};const loc=l.practice_location_id?getLocationLabel(l.practice_location_id):'';
let notes=l.notes||'',time=l.contact_time||'';
if(!time&&notes.startsWith('[')){const m=notes.match(/^\[(\d{1,2}:\d{2})\]\s*/);if(m){time=m[1];notes=notes.slice(m[0].length);}}
return[l.contact_date,time,l.author||'',p.last_name||'',p.first_name||'',loc,notes];});
downloadCSV('contact_logs_export_'+todayStamp()+'.csv',h,rows);
}
async function exportPractices(){
const{data:allLocs,error}=await db.from('practice_locations').select('*, practices(name)').order('city');if(error)throw error;
const h=['Practice Name','Location Label','Address','City','ZIP','Phone','Fax','Office Email','Office Hours','Office Staff','Receptionist','Best Days'];
const rows=(allLocs||[]).map(l=>[l.practices?.name||'',l.label||'',l.address||'',l.city||'',l.zip||'',l.phone||'',l.fax||'',l.practice_email||'',l.office_hours||'',l.office_staff||'',l.receptionist_name||'',l.best_days||'']);
downloadCSV('practices_locations_export_'+todayStamp()+'.csv',h,rows);
}
// === Field Routing Export ===
function getRoutingExportHistory() {
try { return JSON.parse(localStorage.getItem('routingExportHistory') || '{}'); } catch(e) { return {}; }
}
function saveRoutingExportHistory(history) {
localStorage.setItem('routingExportHistory', JSON.stringify(history));
}
function buildRoutingRows(latestActivity) {
// Build all physician-location rows (one row per assignment)
const rows = [];
const assignedLocIds = new Set();
const actMap = latestActivity || {};
// 1. Physician-location rows (separate row per location per physician)
physicians.forEach(phys => {
const assigns = physicianAssignments[phys.id] || [];
const activity = actMap[phys.id] || null;
if (assigns.length === 0) {
// Physician with no location assignment ‚Äî still include
rows.push({
key: 'phys_' + phys.id,
phys: phys,
loc: null,
practice: null,
type: 'phys-only',
activity: activity
});
} else {
assigns.forEach(a => {
const loc = a.practice_locations || practiceLocations.find(l => l.id === a.practice_location_id);
if (!loc) return;
assignedLocIds.add(loc.id);
const practice = practices.find(pr => pr.id === loc.practice_id);
rows.push({
key: 'pl_' + phys.id + '_' + loc.id,
phys: phys,
loc: loc,
practice: practice,
type: 'phys-loc',
activity: activity
});
});
}
});
// 2. Practice locations with NO assigned physicians
practiceLocations.forEach(loc => {
if (assignedLocIds.has(loc.id)) return;
const practice = practices.find(pr => pr.id === loc.practice_id);
rows.push({
key: 'loc_' + loc.id,
phys: null,
loc: loc,
practice: practice,
type: 'loc-only',
activity: null
});
});
return rows;
}
async function openRoutingExport() {
// Fetch latest activity per physician for Status column
cachedLatestActivity = {};
try {
const {data:allLogs} = await db.from('contact_logs').select('*').order('contact_date',{ascending:false});
if (allLogs) {
allLogs.forEach(l => {
if (!cachedLatestActivity[l.physician_id]) cachedLatestActivity[l.physician_id] = l;
});
}
} catch(e) { console.error('Could not load activity for routing:', e); }
const history = getRoutingExportHistory();
const rows = buildRoutingRows(cachedLatestActivity);
let newCount = 0, exportedCount = 0, noPhysCount = 0;
const listHTML = rows.map(r => {
const exported = history[r.key];
const isNew = !exported;
if (r.type === 'loc-only') noPhysCount++;
if (isNew) newCount++; else exportedCount++;
const physName = r.phys ? `${r.phys.first_name} ${r.phys.last_name}${r.phys.degree ? ', ' + r.phys.degree : ''}` : '(No physician assigned)';
const practiceName = r.practice?.name || r.loc?.practices?.name || 'No practice';
const addr = r.loc ? [r.loc.address, r.loc.city, r.loc.zip].filter(Boolean).join(', ') : 'No location';
const activityNote = r.activity ? r.activity.notes || '' : '';
const activityPreview = activityNote.replace(/^\[\d{1,2}:\d{2}\]\s*/, '').substring(0, 60) + (activityNote.length > 60 ? '...' : '');
const activityDate = r.activity?.contact_date || '';
const statusLine = activityDate ? `<div style="font-size:0.7rem;color:#0a4d3c;margin-top:0.125rem;">Last: ${activityDate} ‚Äî ${activityPreview}</div>` : '';
const rowClass = r.type === 'loc-only' ? 'no-phys-row' : (isNew ? 'new-row' : 'exported-row');
const badgeClass = isNew ? 'new' : 'exported';
const badgeText = isNew ? 'NEW' : 'Exported ' + exported;
return `<div class="routing-row ${rowClass}" onclick="this.querySelector('input').checked=!this.querySelector('input').checked">
<input type="checkbox" data-key="${r.key}" ${isNew ? 'checked' : ''} onclick="event.stopPropagation()">
<div class="routing-row-content">
<div class="routing-row-name">${physName}</div>
<div class="routing-row-detail">${practiceName} ‚Äî ${addr}</div>
${statusLine}
</div>
<span class="routing-row-badge ${badgeClass}">${badgeText}</span>
</div>`;
}).join('');
$('routingExportSummary').innerHTML = `<strong>${newCount}</strong> new row${newCount !== 1 ? 's' : ''} to export &nbsp;|&nbsp; <strong>${exportedCount}</strong> previously exported &nbsp;|&nbsp; <strong>${noPhysCount}</strong> practice${noPhysCount !== 1 ? 's' : ''} without physicians`;
$('routingExportList').innerHTML = listHTML || '<div class="empty-notice">No data to export. Add physicians or practices first.</div>';
$('routingExportNewBtn').textContent = `Export New Only (${newCount})`;
$('routingExportModal').classList.add('active');
}
function closeRoutingExport() { closeModal('routingExportModal'); }
function getRoutingCSVHeaders() {
// Matches Google Sheet: Routing(Field Use) tab exactly
return ['ORIG','CALL','AS?','Rank','Physician First Name','Physician Last Name','First Last','Degree','Status','Specialty','Facility (full name)','Address','City','Zip','Phone Number','Vol','County','Notes'];
}
function routingRowToCSV(r) {
const p = r.phys;
const l = r.loc;
const pr = r.practice;
const practiceName = pr?.name || l?.practices?.name || '';
// Build status from latest activity
let status = '';
if (r.activity) {
const note = (r.activity.notes || '').replace(/^\[\d{1,2}:\d{2}\]\s*/, '');
const preview = note.length > 80 ? note.substring(0, 80) + '...' : note;
status = r.activity.contact_date + ': ' + preview;
}
if (r.type === 'loc-only') {
// Practice/location with no physician ‚Äî placeholder instructions
return ['','','','','(Enter HCP first name)','(Enter HCP last name)','','',status,'',practiceName,l?.address||'',l?.city||'',l?.zip||'',l?.phone||'','',l?.city?guessCounty(l.city):'',l?.practice_email?'Email: '+l.practice_email:''];
}
const firstName = p?.first_name || '';
const lastName = p?.last_name || '';
const firstLast = (firstName + ' ' + lastName).trim();
const degree = p?.degree || '';
const rank = p?.priority || '';
const vol = p?.patient_volume || p?.mohs_volume || '';
const county = l?.city ? guessCounty(l.city) : '';
const notes = p?.general_notes || '';
const asVal = p?.advanced_solution ? 'Y' : '';
// ORIG, CALL, AS?, Rank, First, Last, First Last, Degree, Status, Specialty, Facility, Address, City, Zip, Phone, Vol, County, Notes
return ['','',asVal,rank,firstName,lastName,firstLast,degree,status,p?.specialty||'',practiceName,l?.address||'',l?.city||'',l?.zip||'',l?.phone||'',vol,county,notes];
}
function guessCounty(city) {
if (!city) return '';
const c = city.toLowerCase();
const mdCities = ['miami','hialeah','homestead','key biscayne','coral gables','south miami','palmetto bay','doral','north miami','aventura','miami beach','miami gardens','miami lakes','opa-locka','sunny isles','key largo'];
const brCities = ['fort lauderdale','hollywood','pembroke pines','coral springs','deerfield beach','plantation','davie','weston','tamarac','lauderdale lakes','coconut creek','pompano beach','cooper city'];
const pbCities = ['west palm beach','boca raton','boynton beach','delray beach','palm beach gardens','jupiter','lake worth','wellington','royal palm beach','belle glade','palm city','atlantis','north palm beach'];
if (mdCities.some(mc => c.includes(mc))) return 'Miami-Dade';
if (brCities.some(bc => c.includes(bc))) return 'Broward';
if (pbCities.some(pc => c.includes(pc))) return 'Palm Beach';
return '';
}
function routingExportSelected(onlyNew) {
const checkboxes = document.querySelectorAll('#routingExportList input[type="checkbox"]');
const allRows = buildRoutingRows(cachedLatestActivity);
const rowMap = {};
allRows.forEach(r => rowMap[r.key] = r);
const history = getRoutingExportHistory();
const stamp = todayStamp();
const selectedKeys = [];
checkboxes.forEach(cb => {
if (onlyNew) {
if (!history[cb.dataset.key]) selectedKeys.push(cb.dataset.key);
} else {
selectedKeys.push(cb.dataset.key);
}
});
if (selectedKeys.length === 0) {
showToast('No rows to export', 'info');
return;
}
const headers = getRoutingCSVHeaders();
const csvRows = selectedKeys.map(key => {
const r = rowMap[key];
if (!r) return null;
return routingRowToCSV(r);
}).filter(Boolean);
downloadCSV('field_routing_' + stamp + '.csv', headers, csvRows);
// Mark exported
selectedKeys.forEach(key => { history[key] = stamp; });
saveRoutingExportHistory(history);
showToast(`Exported ${selectedKeys.length} row${selectedKeys.length !== 1 ? 's' : ''} for field routing`, 'success');
// Refresh the list to show updated badges
openRoutingExport();
}
function routingExportNew() { routingExportSelected(true); }
function routingExportAll() { routingExportSelected(false); }
function routingClearHistory() {
if (!confirm('Clear all export history? Everything will show as "NEW" again.')) return;
localStorage.removeItem('routingExportHistory');
showToast('Export history cleared', 'info');
openRoutingExport();
}
async function renderActivityView(){
try{
const{data:allLogs,error}=await db.from('contact_logs').select('*').order('contact_date',{ascending:false}).limit(200);
if(error)throw error;
const physMap={};physicians.forEach(p=>physMap[p.id]=p);
const search=$('searchInput').value.toLowerCase();
const filtered=search?allLogs.filter(l=>{const p=physMap[l.physician_id]||{};
return(l.notes||'').toLowerCase().includes(search)||(l.author||'').toLowerCase().includes(search)||(p.first_name||'').toLowerCase().includes(search)||(p.last_name||'').toLowerCase().includes(search);
}):allLogs;
$('physicianList').innerHTML=filtered.length===0?'<li class="loading">No activity found</li>':
filtered.map(l=>{const p=physMap[l.physician_id]||{};
let time=l.contact_time||'';let notes=l.notes||'';
if(!time&&notes.startsWith('[')){const m=notes.match(/^\[(\d{1,2}:\d{2})\]\s*/);if(m){time=m[1];notes=notes.slice(m[0].length);}}
const preview=notes.length>60?notes.slice(0,60)+'...':notes;
return`<li class="physician-item" onclick="viewPhysician('${l.physician_id}')">
<div class="name">${p.first_name||''} ${p.last_name||''}</div>
<div class="practice">${l.contact_date}${time?' '+time:''}${l.author?' - '+l.author:''}</div>
<div style="font-size:0.75rem;color:#666;margin-top:0.25rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${preview}</div>
</li>`;}).join('');
$('physicianCount').textContent=filtered.length+' of '+allLogs.length+' activities';
$('mainContent').innerHTML=`<div class="empty-state"><h2>Recent Activity</h2><p>Select an entry to view the full physician profile and notes</p></div>`;
}catch(e){console.error('Activity view error:',e);$('physicianList').innerHTML='<li class="loading">Error loading activity</li>';}
}
async function renderDashboard(){
const{data:allLogs,error}=await db.from('contact_logs').select('*').order('contact_date',{ascending:false});
const logs=allLogs||[];
const now=new Date();const today=now.toISOString().slice(0,10);
const weekAgo=new Date(now-7*86400000).toISOString().slice(0,10);
const monthAgo=new Date(now-30*86400000).toISOString().slice(0,10);
const thisWeek=logs.filter(l=>l.contact_date>=weekAgo).length;
const thisMonth=logs.filter(l=>l.contact_date>=monthAgo).length;
// Tier breakdown
const tierCounts={};physicians.forEach(p=>{const t=p.priority||'Unset';tierCounts[t]=(tierCounts[t]||0)+1;});
const tierHTML=Object.entries(tierCounts).sort((a,b)=>a[0].localeCompare(b[0])).map(([t,c])=>`<div style="display:flex;justify-content:space-between;padding:0.5rem 0;border-bottom:1px solid #f0f0f0;"><span>Tier ${t}</span><strong>${c}</strong></div>`).join('');
// Specialty breakdown
const specCounts={};physicians.forEach(p=>{const s=p.specialty||'Unset';specCounts[s]=(specCounts[s]||0)+1;});
const specHTML=Object.entries(specCounts).sort((a,b)=>b[1]-a[1]).map(([s,c])=>`<div style="display:flex;justify-content:space-between;padding:0.5rem 0;border-bottom:1px solid #f0f0f0;"><span>${s}</span><strong>${c}</strong></div>`).join('');
// City breakdown
const cityCounts={};physicians.forEach(p=>{const loc=getPrimaryLoc(p.id);const c=loc.city||'Unknown';cityCounts[c]=(cityCounts[c]||0)+1;});
const cityHTML=Object.entries(cityCounts).sort((a,b)=>b[1]-a[1]).slice(0,15).map(([c,n])=>`<div style="display:flex;justify-content:space-between;padding:0.5rem 0;border-bottom:1px solid #f0f0f0;"><span>${c}</span><strong>${n}</strong></div>`).join('');
// Contact frequency per physician
const contactCounts={};logs.forEach(l=>{contactCounts[l.physician_id]=(contactCounts[l.physician_id]||0)+1;});
const physMap={};physicians.forEach(p=>physMap[p.id]=p);
const mostContacted=Object.entries(contactCounts).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([id,c])=>{const p=physMap[id];return p?`<div style="display:flex;justify-content:space-between;padding:0.5rem 0;border-bottom:1px solid #f0f0f0;cursor:pointer;" onclick="setView('physicians');viewPhysician('${id}')"><span>${p.first_name} ${p.last_name}</span><strong>${c}</strong></div>`:'';}).join('');
// Never contacted
const contacted=new Set(logs.map(l=>l.physician_id));
const neverContacted=physicians.filter(p=>!contacted.has(p.id));
const neverHTML=neverContacted.slice(0,10).map(p=>`<div style="padding:0.5rem 0;border-bottom:1px solid #f0f0f0;cursor:pointer;" onclick="setView('physicians');viewPhysician('${p.id}')">${p.first_name} ${p.last_name} <span style="font-size:0.75rem;color:#999;">Tier ${p.priority||'?'}</span></div>`).join('');
const card=(title,content)=>`<div style="background:white;padding:1.25rem;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.1);"><h4 style="color:#0a4d3c;margin-bottom:0.75rem;font-size:1rem;">${title}</h4>${content}</div>`;
const stat=(label,val,color)=>`<div style="background:white;padding:1.25rem;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.1);text-align:center;"><div style="font-size:2rem;font-weight:700;color:${color||'#0a4d3c'};">${val}</div><div style="font-size:0.75rem;color:#999;margin-top:0.25rem;">${label}</div></div>`;
$('mainContent').innerHTML=`
<div style="margin-bottom:1rem;"><h2 style="color:#0a4d3c;font-size:1.5rem;">Territory Dashboard</h2></div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:0.75rem;margin-bottom:1rem;">
${stat('Physicians',physicians.length)}
${stat('Practices',practices.length)}
${stat('Locations',practiceLocations.length)}
${stat('Total Contacts',logs.length)}
${stat('This Week',thisWeek,'#f97316')}
${stat('This Month',thisMonth,'#0ea5e9')}
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:0.75rem;">
${card('By Tier',tierHTML)}
${card('By Specialty',specHTML)}
${card('By City (Top 15)',cityHTML)}
${card('Most Contacted',mostContacted)}
${card('Never Contacted ('+neverContacted.length+')',neverHTML||'<div style="color:#10b981;padding:0.5rem 0;">All physicians contacted!</div>')}
</div>`;
$('physicianCount').textContent='Territory Dashboard';
}
let territoryMap=null;
const geocodeCache=(function(){try{return JSON.parse(localStorage.getItem('geocodeCache')||'{}');}catch(e){return {};}})();
function saveGeocodeCache(){try{localStorage.setItem('geocodeCache',JSON.stringify(geocodeCache));}catch(e){}}
let territoryMapCache=null; // {version, markers:[{lat,lng,popup,locId}], bounds:[]}
function getMapDataVersion(){return practiceLocations.length+'_'+physicians.length+'_'+Object.keys(physicianAssignments).length;}
function buildMarkerPopup(loc,practiceName,physNames,addr){
return '<strong>'+(practiceName||loc.label||'Office')+'</strong><br>'
+addr+'<br>'
+(physNames?'<em>'+physNames+'</em><br>':'')
+'<a href="https://maps.apple.com/?q='+encodeURIComponent(addr)+'" target="_blank" style="color:#0a4d3c;">Get Directions</a>';
}
async function renderMapView(){
const search=($('searchInput').value||'').toLowerCase().trim();
$('mainContent').innerHTML='<div id="mapContainer" style="height:calc(100vh - 2rem);border-radius:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.1);"></div>';
if(territoryMap){territoryMap.remove();territoryMap=null;}
territoryMap=L.map('mapContainer').setView([25.76,-80.19],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'OpenStreetMap',maxZoom:18}).addTo(territoryMap);
const version=getMapDataVersion();
// Full territory with valid cache ‚Äî instant render
if(!search&&territoryMapCache&&territoryMapCache.version===version){
territoryMapCache.markers.forEach(m=>{L.marker([m.lat,m.lng]).addTo(territoryMap).bindPopup(m.popup);});
$('physicianCount').textContent='Territory Map ('+territoryMapCache.markers.length+' locations, cached)';
if(territoryMapCache.bounds.length>1)territoryMap.fitBounds(territoryMapCache.bounds,{padding:[30,30]});
else if(territoryMapCache.bounds.length===1)territoryMap.setView(territoryMapCache.bounds[0],15);
return;
}
// Filtered: build filtered location set
const filteredLocIds=new Set();
if(search){
const filteredPhys=getFilteredPhysicians(search);
filteredPhys.forEach(p=>{(physicianAssignments[p.id]||[]).forEach(a=>{if(a.practice_location_id)filteredLocIds.add(a.practice_location_id);});});
practiceLocations.filter(l=>l.address&&l.city).forEach(l=>{
if([l.address,l.city,l.zip,l.phone,l.fax,l.label,l.practices?.name||''].some(v=>(v||'').toLowerCase().includes(search)))filteredLocIds.add(l.id);
});
}
const locs=practiceLocations.filter(l=>l.address&&l.city&&(!search||filteredLocIds.has(l.id)));
$('physicianCount').textContent=search?'Map: "'+search+'" ('+locs.length+' locations)':'Territory Map ('+locs.length+' locations)';
// Filtered with valid full cache ‚Äî subset from cache (instant)
if(search&&territoryMapCache&&territoryMapCache.version===version){
const subset=territoryMapCache.markers.filter(m=>filteredLocIds.has(m.locId));
const bounds=[];
subset.forEach(m=>{L.marker([m.lat,m.lng]).addTo(territoryMap).bindPopup(m.popup);bounds.push([m.lat,m.lng]);});
$('physicianCount').textContent='Map: "'+search+'" ('+subset.length+' locations)';
if(bounds.length>1)territoryMap.fitBounds(bounds,{padding:[30,30]});
else if(bounds.length===1)territoryMap.setView(bounds[0],15);
return;
}
// Build markers from scratch (first load or data changed)
let plotted=0;
const statusEl=document.createElement('div');
statusEl.style.cssText='position:absolute;top:10px;right:10px;z-index:1000;background:white;padding:0.5rem 1rem;border-radius:8px;font-size:0.8rem;box-shadow:0 2px 4px rgba(0,0,0,0.2);';
document.getElementById('mapContainer').appendChild(statusEl);
const uncachedCount=locs.filter(l=>!geocodeCache[l.address+', '+l.city+', FL '+(l.zip||'')]).length;
statusEl.textContent=uncachedCount?'Geocoding '+uncachedCount+' new addresses...':'Loading '+locs.length+' locations...';
const bounds=[];
const builtMarkers=[];
for(const loc of locs){
const addr=loc.address+', '+loc.city+', FL '+(loc.zip||'');
const practiceName=loc.practices?.name||practices.find(p=>p.id===loc.practice_id)?.name||'';
const assignedPhys=physicians.filter(p=>(physicianAssignments[p.id]||[]).some(a=>a.practice_location_id===loc.id));
const physNames=assignedPhys.map(p=>p.first_name+' '+p.last_name).join(', ');
try{
let coords=geocodeCache[addr];
if(!coords){
const r=await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(addr)+'&limit=1');
const d=await r.json();
if(d&&d[0]){coords={lat:parseFloat(d[0].lat),lng:parseFloat(d[0].lon)};geocodeCache[addr]=coords;saveGeocodeCache();}
await new Promise(ok=>setTimeout(ok,300));
}
if(coords){
const popup=buildMarkerPopup(loc,practiceName,physNames,addr);
L.marker([coords.lat,coords.lng]).addTo(territoryMap).bindPopup(popup);
bounds.push([coords.lat,coords.lng]);
builtMarkers.push({lat:coords.lat,lng:coords.lng,popup,locId:loc.id});
plotted++;
}
}catch(e){console.log('Geocode error for '+addr,e);}
if(uncachedCount)statusEl.textContent='Plotted '+plotted+' of '+locs.length+'...';
}
statusEl.textContent=plotted+' locations mapped'+(search?' for "'+search+'"':'');
setTimeout(()=>statusEl.remove(),3000);
if(bounds.length>1)territoryMap.fitBounds(bounds,{padding:[30,30]});
else if(bounds.length===1)territoryMap.setView(bounds[0],15);
else territoryMap.invalidateSize();
// Cache full territory build for instant reuse
if(!search)territoryMapCache={version,markers:builtMarkers,bounds};
}
</script>
<div class="modal" id="exportModal">
<div style="background:white;border-radius:16px;width:100%;max-width:420px;margin:auto;box-shadow:0 20px 25px -5px rgba(0,0,0,0.2);">
<div style="display:flex;justify-content:space-between;align-items:center;padding:1.5rem;border-bottom:1px solid #e5e5e5;">
<h2 style="font-size:1.5rem;color:#0a4d3c;">Export Data</h2>
<button onclick="closeExportModal()" style="background:none;border:none;font-size:2rem;cursor:pointer;color:#999;">&times;</button>
</div>
<div style="padding:1.5rem;">
<p style="color:#666;margin-bottom:1rem;">Download CRM data as CSV files:</p>
<div style="display:flex;flex-direction:column;gap:0.5rem;">
<button onclick="closeExportModal();openRoutingExport()" style="display:flex;align-items:center;gap:0.75rem;padding:0.875rem 1rem;background:#fef3c7;border:2px solid #f59e0b;border-radius:10px;cursor:pointer;text-align:left;width:100%;margin-bottom:0.5rem;"><span style="font-size:1.5rem;">üó∫Ô∏è</span><div><strong style="color:#92400e;">Field Routing Export</strong><br><small style="color:#a16207;">NEW &amp; updated HCP-to-address rows for routing sheet. Tracks what's already been exported.</small></div></button>
<div style="border-top:1px solid #e5e5e5;margin:0.5rem 0;padding-top:0.5rem;"><small style="color:#999;">Full data exports:</small></div>
<button onclick="exportCSV('physicians')" style="display:flex;align-items:center;gap:0.75rem;padding:0.875rem 1rem;background:#f9f9f9;border:2px solid #e5e5e5;border-radius:10px;cursor:pointer;text-align:left;width:100%;"><span style="font-size:1.5rem;">üë®‚Äç‚öïÔ∏è</span><div><strong style="color:#0a4d3c;">Physicians</strong><br><small style="color:#999;">All physicians with practice &amp; location info</small></div></button>
<button onclick="exportCSV('contacts')" style="display:flex;align-items:center;gap:0.75rem;padding:0.875rem 1rem;background:#f9f9f9;border:2px solid #e5e5e5;border-radius:10px;cursor:pointer;text-align:left;width:100%;"><span style="font-size:1.5rem;">üìã</span><div><strong style="color:#0a4d3c;">Contact Logs</strong><br><small style="color:#999;">All activity notes with dates &amp; locations</small></div></button>
<button onclick="exportCSV('practices')" style="display:flex;align-items:center;gap:0.75rem;padding:0.875rem 1rem;background:#f9f9f9;border:2px solid #e5e5e5;border-radius:10px;cursor:pointer;text-align:left;width:100%;"><span style="font-size:1.5rem;">üè•</span><div><strong style="color:#0a4d3c;">Practices &amp; Locations</strong><br><small style="color:#999;">All practices with location details</small></div></button>
<button onclick="exportCSV('all')" style="display:flex;align-items:center;gap:0.75rem;padding:0.875rem 1rem;background:#f0fdf4;border:2px solid #0a4d3c;border-radius:10px;cursor:pointer;text-align:left;width:100%;"><span style="font-size:1.5rem;">üì¶</span><div><strong style="color:#0a4d3c;">Export Everything</strong><br><small style="color:#999;">Downloads all three files at once</small></div></button>
</div>
<div id="exportStatus" style="display:none;margin-top:1rem;padding:0.75rem;border-radius:8px;text-align:center;font-size:0.85rem;"></div>
</div>
</div>
</div>
<div class="modal" id="routingExportModal">
<div class="modal-content" style="max-width:650px;">
<div class="modal-header" style="background:#fef3c7;border-radius:16px 16px 0 0;">
<h2 style="color:#92400e;font-size:1.25rem;">Field Routing Export</h2>
<button class="close-btn" onclick="closeRoutingExport()">&times;</button>
</div>
<div class="modal-body" style="padding:1rem 1.5rem;">
<div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap;">
<button class="edit-btn" onclick="routingExportNew()" id="routingExportNewBtn" style="background:#f59e0b;flex:1;text-align:center;">Export New Only</button>
<button class="edit-btn" onclick="routingExportAll()" style="flex:1;text-align:center;">Export All</button>
<button class="btn-secondary" onclick="routingClearHistory()" style="font-size:0.75rem;">Clear History</button>
</div>
<div id="routingExportSummary" style="padding:0.5rem 0.75rem;background:#f0fdf4;border-radius:8px;font-size:0.8rem;color:#166534;margin-bottom:0.75rem;"></div>
<div id="routingExportList" style="max-height:55vh;overflow-y:auto;"></div>
</div>
</div>
</div>
</body>
</html>
